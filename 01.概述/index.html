<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《深入理解 Babel》 · 刘远洋</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="manifest" href="/deep-in-babel/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="Deep In Babel">
    <meta property="og:url" content="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/">
    <meta property="og:site_name" content="《深入理解 Babel》 · 刘远洋">
    <meta property="og:description" content="本章从整体视角介绍 Babel 生态的全貌，并非详细地介绍其中的每一个细节，如希望了解详细的介绍，可根据需要查看本书其他章节。 1 Babel 简介 1.1 Babel 是什么？ Babel 是 JavaScript 转译器，通过 Babel，开发者可以自由使用下一代 ECMAScript 语法。高版本 ECMAScript 语法将被转译为低版本语法，以便顺">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="《深入理解 Babel》 · 刘远洋">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <link rel="preload" href="/deep-in-babel/assets/css/0.styles.493975ce.css" as="style"><link rel="preload" href="/deep-in-babel/assets/js/app.1bcfb3b3.js" as="script"><link rel="preload" href="/deep-in-babel/assets/js/vendors~layout-Layout.df4812ba.js" as="script"><link rel="preload" href="/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ebefd1c7.js" as="script"><link rel="preload" href="/deep-in-babel/assets/js/page--aec4dcea.63bd61cc.js" as="script"><link rel="preload" href="/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.33005620.js" as="script"><link rel="prefetch" href="/deep-in-babel/assets/js/26.db6b8dab.js"><link rel="prefetch" href="/deep-in-babel/assets/js/layout-Blog.b0c6dcb7.js"><link rel="prefetch" href="/deep-in-babel/assets/js/layout-Layout.54347a9b.js"><link rel="prefetch" href="/deep-in-babel/assets/js/layout-NotFound.846facba.js"><link rel="prefetch" href="/deep-in-babel/assets/js/layout-Slide.88fa1023.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--0634ff23.a0330061.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--0a25c2f2.537ec7c2.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--16ed4b18.a3685b13.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--22748d68.ec38d625.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--340e5eca.98e127bc.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--3593c398.674650dc.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--3c8b2e78.a85de8a4.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--41eeb5e4.f46cc140.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--4655fe84.fb128710.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--4d090060.fed09ae4.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--4fdeacc4.9d22c4c1.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--aa1cd778.17eec900.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page-前言.0350ecb5.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page-提案特性转换插件.51954226.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page-语法分析和语义分析.f62ff820.js"><link rel="prefetch" href="/deep-in-babel/assets/js/vendors~photo-swipe.ed4bf049.js">
    <link rel="stylesheet" href="/deep-in-babel/assets/css/0.styles.493975ce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/deep-in-babel/" class="home-link router-link-active"><!----> <!----> <span class="site-name can-hide">《深入理解 Babel》 · 刘远洋</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://inotely.github.io/home" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Notely · 撰写工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/hoperyy" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Follow 作者
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/hoperyy/deep-in-babel" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Star
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></nav> <!----> <!----> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="https://inotely.github.io/home" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Notely · 撰写工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/hoperyy" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Follow 作者
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/hoperyy/deep-in-babel" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Star
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> <div class="content__sidebar-center"></div> <ul class="sidebar-links"><li><a href="/deep-in-babel/00.%E5%89%8D%E8%A8%80/" class="sidebar-link">第 0 章 - 前言</a></li><li><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/" aria-current="page" class="active sidebar-link">第 1 章 - 概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_1-babel-简介" class="sidebar-link">1 Babel 简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_1-1-babel-是什么" class="sidebar-link heading3">1.1 Babel 是什么？</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_1-2-转译过程" class="sidebar-link heading3">1.2 转译过程</a></li></ul></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_2-babel-模块拆解" class="sidebar-link">2 Babel 模块拆解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_2-1-微内核架构" class="sidebar-link heading3">2.1 微内核架构</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_2-2-转译模块" class="sidebar-link heading3">2.2 转译模块</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_2-3-插件模块" class="sidebar-link heading3">2.3 插件模块</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_2-4-工具模块" class="sidebar-link heading3">2.4 工具模块</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_2-5-运行时相关模块" class="sidebar-link heading3">2.5 运行时相关模块</a></li></ul></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_3-使用-babel" class="sidebar-link">3 使用 Babel</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_3-1-对外工具集" class="sidebar-link heading3">3.1 对外工具集</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_3-2-配置-babel" class="sidebar-link heading3">3.2 配置 Babel</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#多种配置方式" class="sidebar-link heading3">多种配置方式</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#项目级配置与局部配置" class="sidebar-link heading3">项目级配置与局部配置</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#配置项" class="sidebar-link heading3">配置项</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#配置合并规则" class="sidebar-link heading3">配置合并规则</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#plugins-presets-配置" class="sidebar-link heading3">Plugins/Presets 配置</a></li></ul></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_4-babel-的项目管理" class="sidebar-link">4 Babel 的项目管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_4-1-monorepo" class="sidebar-link heading3">4.1 monorepo</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_4-2-lerna" class="sidebar-link heading3">4.2 lerna</a></li></ul></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_5-标准化" class="sidebar-link">5 标准化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_5-1-ecmascript" class="sidebar-link heading3">5.1 ECMAScript</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#javascript诞生" class="sidebar-link heading3">JavaScript诞生</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#ecmascript发布" class="sidebar-link heading3">ECMAScript发布</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#ecmascript-各版本" class="sidebar-link heading3">ECMAScript 各版本</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#ecmascript-迭代过程" class="sidebar-link heading3">ECMAScript 迭代过程</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_5-2-如何阅读-ecmascript" class="sidebar-link heading3">5.2 如何阅读 ECMAScript</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#ecmascript-文档结构" class="sidebar-link heading3">ECMAScript 文档结构</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#通过阅读规格解决一些问题" class="sidebar-link heading3">通过阅读规格解决一些问题</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_5-3-web标准" class="sidebar-link heading3">5.3 web标准</a></li></ul></li><li class="sidebar-sub-header"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_6-总结" class="sidebar-link">6 总结</a></li></ul></li><li><a href="/deep-in-babel/02.%E8%BD%AC%E8%AF%91%E5%8E%9F%E7%90%86(1)/" class="sidebar-link">第 2 章 - 转译原理 (1)</a></li><li><a href="/deep-in-babel/03.%E8%BD%AC%E8%AF%91%E5%8E%9F%E7%90%86(2)/" class="sidebar-link">第 3 章 - 转译原理 (2)</a></li><li><a href="/deep-in-babel/04.Babel%E8%8A%82%E7%82%B9/" class="sidebar-link">第 4 章 - Babel 节点</a></li><li><a href="/deep-in-babel/05.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/" class="sidebar-link">第 5 章 - Babel 工具集</a></li><li><a href="/deep-in-babel/06.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/" class="sidebar-link">第 6 章 - Babel 插件编写</a></li><li><a href="/deep-in-babel/07.Babel%E5%86%85%E7%BD%AEPlugin(1)/" class="sidebar-link">第 7 章 - Babel 内置 Plugin (1)</a></li><li><a href="/deep-in-babel/08.Babel%E5%86%85%E7%BD%AEPlugin(2)/" class="sidebar-link">第 8 章 - Babel 内置 Plugin (2)</a></li><li><a href="/deep-in-babel/09.Babel%E5%86%85%E7%BD%AEPreset/" class="sidebar-link">第 9 章 - Babel 内置 Preset</a></li><li><a href="/deep-in-babel/10.runtime(1)/" class="sidebar-link">第 10 章 - runtime (1)</a></li><li><a href="/deep-in-babel/11.runtime(2)/" class="sidebar-link">第 11 章 - runtime (2)</a></li><li><a href="/deep-in-babel/12.runtime(3)/" class="sidebar-link">第 12 章 - runtime (3)</a></li><li><a href="/deep-in-babel/13.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" class="sidebar-link">第 13 章 - Babel 项目管理</a></li><li><a href="/deep-in-babel/14.%E8%BD%AC%E8%AF%91%E5%99%A8%E5%AF%B9%E6%AF%94/" class="sidebar-link">第 14 章 - 转译器对比</a></li></ul> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb disable"><!----></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline"></span></h1> <div class="page-info"><!----> <!----><!----><span aria-label="Writing Date📅" data-balloon-pos="down" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2022-2-24</span></span><!----><!----><span aria-label="Reading Time⌛" data-balloon-pos="down" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 36 min</span> <meta property="timeRequired" content="PT36M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_1-babel-简介" class="anchor-link heading2"><div>1 Babel 简介</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_1-1-babel-是什么" class="anchor-link heading3"><div>1.1 Babel 是什么？</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_1-2-转译过程" class="anchor-link heading3"><div>1.2 转译过程</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_2-babel-模块拆解" class="anchor-link heading2"><div>2 Babel 模块拆解</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_2-1-微内核架构" class="anchor-link heading3"><div>2.1 微内核架构</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_2-2-转译模块" class="anchor-link heading3"><div>2.2 转译模块</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_2-3-插件模块" class="anchor-link heading3"><div>2.3 插件模块</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_2-4-工具模块" class="anchor-link heading3"><div>2.4 工具模块</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_2-5-运行时相关模块" class="anchor-link heading3"><div>2.5 运行时相关模块</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_3-使用-babel" class="anchor-link heading2"><div>3 使用 Babel</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_3-1-对外工具集" class="anchor-link heading3"><div>3.1 对外工具集</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_3-2-配置-babel" class="anchor-link heading3"><div>3.2 配置 Babel</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#多种配置方式" class="anchor-link heading3"><div>多种配置方式</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#项目级配置与局部配置" class="anchor-link heading3"><div>项目级配置与局部配置</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#配置项" class="anchor-link heading3"><div>配置项</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#配置合并规则" class="anchor-link heading3"><div>配置合并规则</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#plugins-presets-配置" class="anchor-link heading3"><div>Plugins/Presets 配置</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_4-babel-的项目管理" class="anchor-link heading2"><div>4 Babel 的项目管理</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_4-1-monorepo" class="anchor-link heading3"><div>4.1 monorepo</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_4-2-lerna" class="anchor-link heading3"><div>4.2 lerna</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_5-标准化" class="anchor-link heading2"><div>5 标准化</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_5-1-ecmascript" class="anchor-link heading3"><div>5.1 ECMAScript</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#javascript诞生" class="anchor-link heading3"><div>JavaScript诞生</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#ecmascript发布" class="anchor-link heading3"><div>ECMAScript发布</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#ecmascript-各版本" class="anchor-link heading3"><div>ECMAScript 各版本</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#ecmascript-迭代过程" class="anchor-link heading3"><div>ECMAScript 迭代过程</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_5-2-如何阅读-ecmascript" class="anchor-link heading3"><div>5.2 如何阅读 ECMAScript</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#ecmascript-文档结构" class="anchor-link heading3"><div>ECMAScript 文档结构</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#通过阅读规格解决一些问题" class="anchor-link heading3"><div>通过阅读规格解决一些问题</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_5-3-web标准" class="anchor-link heading3"><div>5.3 web标准</div></a></li><li class="anchor"><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/#_6-总结" class="anchor-link heading2"><div>6 总结</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><p>本章从整体视角介绍 Babel 生态的全貌，并非详细地介绍其中的每一个细节，如希望了解详细的介绍，可根据需要查看本书其他章节。</p> <h2 id="_1-babel-简介"><a href="#_1-babel-简介" class="header-anchor">#</a> 1 Babel 简介</h2> <h3 id="_1-1-babel-是什么"><a href="#_1-1-babel-是什么" class="header-anchor">#</a> 1.1 Babel 是什么？</h3> <p>Babel 是 JavaScript 转译器，通过 Babel，开发者可以自由使用下一代 ECMAScript 语法。高版本 ECMAScript 语法将被转译为低版本语法，以便顺利运行在各类环境，如低版本浏览器、低版本 Node.js 等。</p> <blockquote><p>Babel 是转译器，不是编译器。下面是转译和编译的区别:</p></blockquote> <blockquote><p>编译，一般指将一种语言转换为另一种语法和抽象程度等都不同的语言，常见的比如 gcc 编译器。
转译，一般指将一种语言转换为不同版本或者抽象程度相同的语言，比如 Babel 可以把 ECMAScript 6 语法转译为 ECMAScript 5 语法。</p></blockquote> <p>利用 Babel，开发者可以使用 ECMAScript 的各种新特性进行开发，同时花极少的精力关注浏览器或其他JS运行环境对新特性的支持。甚至，开发者可以根据自身需要，创造属于自己的 JavaScript 语法。</p> <p>Babel 在转译的时候，会对源码进行以下处理: 语法转译(Syntax)和添加 API Polyfill。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155267231-132a2ee7-828f-4a7e-bb32-eb85a288b7d7.png" alt="Babel概述/Babel转换过程.png"></p> <ul><li><p>语法(Syntax)部分</p> <p>Babel 支持识别高版本语法，并通过插件将源码从高版本语法转译为低版本语法，如:</p> <ul><li>箭头函数 <code>() =&gt; {}</code> 转为普通函数 <code>function() {}</code>。</li> <li><code>const / let</code> 转译为 <code>var</code></li></ul></li> <li><p>API Polyfill</p> <p>有些运行时相关的 API，语法转译无法解决它们对低版本浏览器等环境的兼容性问题，因此 Babel 通过与 core-js 等工具的配合，实现 API 部分对目标环境(通常是低版本浏览器等)的兼容。</p> <p>例如<code>[1, 2, 3].include</code>、<code>Promise</code>等 API，Babel 在处理时，如果目标环节可能不支持原生的 <code>include / Promise</code> 的话，Babel 会在转译结果中嵌入 <code>include / Promise</code> 的自定义实现。</p></li></ul> <p>有多种方式可以使用 Babel，如: 命令行(babel-cli、babel-node)、浏览器(babel-standalone)、API调用(babel-core)、webpack loader(babel-loader)等。</p> <h3 id="_1-2-转译过程"><a href="#_1-2-转译过程" class="header-anchor">#</a> 1.2 转译过程</h3> <p>和多数转译器相同，Babel 运行的生命周期主要是 3 个阶段: 解析、转换、代码生成。</p> <p>这个过程涉及抽象语法树:</p> <p>抽象语法树(Abstract Syntax Tree，AST)，或简称语法树(Syntax tree)，是源代码语法结构的一种抽象表示。</p> <p>AST 是树形对象，以结构化的形式表示编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155267412-62ddab76-91e5-4b4c-b3d9-439ecee5a3cd.png" alt="Babel概述/AST-demo.png"></p> <p>源码字符串需要经转译器生成 AST，转译器有很多种，不同转译器，生成的AST对象格式细节可能有差异，但共同点为: 都是树形对象、该树形对象描述了节点特征、各节点之间的关系（兄弟、父子等）。</p> <p>以下是 Babel 生命周期的三个过程:</p> <ul><li><p>解析(Parsing): Code1 ==&gt; 抽象语法树1</p> <p>解析过程包括 2 个环节: 词法解析、语法解析，最终生成抽象语法树。</p> <p>词法解析阶段，代码字符串被解析为 token 令牌数组，数组项是一个对象，包括: 代码字符碎片的值、位置、类型等信息。</p> <p>token 数组是平铺式的数组，没有嵌套的结构信息，它是为语法解析阶段做准备的。</p> <p>语法解析阶段，token 令牌数组被解析为结构化的抽放语法树对象(AST)。</p> <p>babel-parser 完成该阶段的主要功能。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155267543-453c1f37-fc91-47f1-b19b-63d1376f7c02.png" alt="Babel概述/AST-tokens"></p></li> <li><p>转换(Transformation): AST1 ==&gt; AST2</p> <p>Babel 生成 AST 后，会对 AST 进行遍历，遍历过程中，各类插件对原 AST 对象进行增删改查等操作，AST 结构被修改。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155267607-f2be330e-43e5-4b8d-a994-1a1e341c4506.png" alt="Babel概述/AST-转换"></p></li> <li><p>代码生成(Generation): AST2 ==&gt; Code2</p> <p>Babel 将修改后的 AST 对象转目标代码字符串。</p> <p>babel-generator 完成该阶段的主要功能。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155267712-05cac9d1-0158-4bb6-b6fe-a6b20d531d31.png" alt="Babel概述/AST-生成代码"></p></li></ul> <h2 id="_2-babel-模块拆解"><a href="#_2-babel-模块拆解" class="header-anchor">#</a> 2 Babel 模块拆解</h2> <h3 id="_2-1-微内核架构"><a href="#_2-1-微内核架构" class="header-anchor">#</a> 2.1 微内核架构</h3> <p>Babel 采用微内核架构，其内核保留核心功能，其余功能利用外部工具和插件机制实现，也体现了&quot;开放-封闭&quot;的设计原则。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155268039-82423cb1-7d31-47de-a4c0-62b72e6b7f67.jpg" alt="Babel概述/微内核架构"></p> <p>除了微内核设计架构，Babel 的模块设计也可以做如下分类:</p> <p><img src="https://user-images.githubusercontent.com/5757051/155267994-ff62fe98-4a9d-453e-8e97-8877969dc4d6.png" alt="Babel概述/模块分层"></p> <h3 id="_2-2-转译模块"><a href="#_2-2-转译模块" class="header-anchor">#</a> 2.2 转译模块</h3> <p>转译模块位于 Babel 微内核架构的&quot;微内核&quot;部分，该部分主要负责代码转译，也就是上面提到的&quot;解析-转换-代码生成&quot;过程。</p> <p>该模块主要包括: babel-parser、babel-traverse、babel-generator。</p> <ul><li><p>babel-parser</p> <p>负责将代码字符串转为 AST 对象。</p> <p>有 2 点值得一提:</p> <ul><li>babel-parser 本身并不会对 AST 做转换操作，只是负责解析出 AST。AST 转换部分交由各类 plugins 和 presets 处理。</li> <li>babel-parser 内置了对 ESNext/TypeScript/JSX/Flow 最新版本语法的支持，但很多默认是不开启的，目前没有开放插件机制扩展新语法。</li></ul></li> <li><p>babel-traverse</p> <p>在转译过程中，babel-traverse 负责遍历 AST 节点，并根据配置的 plugins/presets，在遍历过程中，对各个 AST 节点进行增删改查的操作。</p> <p>AST 是一个树形对象，遍历 AST 对象的过程也是一个深度优先遍历的过程。</p></li> <li><p>babel-generator</p> <p>负责将 AST 节点，转为代码字符串，同时也可以生成 source-map。</p></li></ul> <h3 id="_2-3-插件模块"><a href="#_2-3-插件模块" class="header-anchor">#</a> 2.3 插件模块</h3> <p>插件模块包括 plugins、presets。</p> <ul><li><p>plugins</p> <p>丰富的插件，帮助 Babel 成为一个非常成功的转译工具。</p> <p>对 AST 的遍历、转换是 Babel 转译的核心功能，但 Babel 本身并不参与该过程，将这些功能作为插件引入到运行时。</p> <p>具体来说，babel-core 作为核心工具，不提供对 AST 的修改逻辑，通过调用各类插件，实现对 AST 的修改。</p> <p>Babel的插件分为语法插件和转换插件。</p> <ul><li><p>语法插件</p> <p>值得注意的是，babel-parser 负责将 JavaScript 代码解析出抽象语法树(AST)，它支持全面识别 ESNext/TypeScript/JSX/Flow 等语法，目前由 Babel 团队开发维护，不支持插件化。</p> <p>Babel 插件生态中的语法插件，其功能就是作为&quot;开关&quot;，配置是否开启 babel-parser 的某些语法转译功能。</p> <p>语法插件在 Babel 源码中，以 <code>babel-plugin-syntax</code> 开头。</p> <p>举个例子:</p> <ul><li><p><code>babel-plugin-syntax-decorators</code></p> <p>负责开启 babel-parser 对装饰器的语法支持。</p></li> <li><p><code>babel-plugin-syntax-dynamic-import</code></p> <p>负责开启 babel-parser 对 <code>import</code> 语句的语法支持。</p></li> <li><p><code>babel-plugin-syntax-jsx</code></p> <p>负责开启 babel-parser 对 jsx 语法的支持。</p></li></ul></li> <li><p>转换插件</p> <p>转换插件就是社区里常说的 Babel 插件，负责转换 AST 节点。</p> <p>在介绍 babel-traverse 时提到，它负责遍历 AST 对象，每个 AST 节点会被访问到，等待转换，转换的部分，由&quot;转换插件&quot;负责。</p> <p>转换插件会提供一个叫做&quot;Visitor&quot;的对象，该对象的 Key 为节点名称，Value 部分提供进入该节点时、离开该节点时的回调函数，在回调函数里，可以对该节点进行一系列操作。</p> <p>&quot;Visitor&quot; 又称为 &quot;访问者&quot;。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// plugin 提供 visitor，在 visitor 中对 AST 节点操作</span>
<span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">Program</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token literal-property property">CallExpression</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token literal-property property">NumberLiteral</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> visitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>转换插件在 Babel 源码中，以 <code>babel-plugin-transform</code> 开头。</p> <p>举个例子:</p> <ul><li><p>babel-plugin-transform-strict-mode</p> <p>该插件拦截 <code>Program</code> 节点，也就是整个程序的根节点，添加 <code>&quot;use strict&quot;</code> 指令。</p> <p>visitor 节点值为函数时，是 enter 回调的快捷方式。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;transform-strict-mode&quot;</span><span class="token punctuation">,</span>

    <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">Program</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> directive <span class="token keyword">of</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>directives<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>directive<span class="token punctuation">.</span>value<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        path<span class="token punctuation">.</span><span class="token function">unshiftContainer</span><span class="token punctuation">(</span>
          <span class="token string">&quot;directives&quot;</span><span class="token punctuation">,</span>
          t<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">directiveLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></li> <li><p>babel-plugin-transform-object-assign</p> <p>该插件负责拦截函数调用表达式节点 <code>CallExpression</code>，将 <code>Object.assign</code> 转为 <code>extends</code> 写法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;transform-object-assign&quot;</span><span class="token punctuation">,</span>

    <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;callee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matchesPattern</span><span class="token punctuation">(</span><span class="token string">&quot;Object.assign&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>callee <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">addHelper</span><span class="token punctuation">(</span><span class="token string">&quot;extends&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li></ul></li></ul></li> <li><p>presets</p> <p>Babel 插件的功能是细粒度的，大部分插件承担了单一功能。</p> <p>而在实际开发过程中，往往需要支持对各类语法的支持。此时，有两种做法:</p> <ol><li>需要支持哪些特性，就分别引入支持该特性的插件</li> <li>直接引入一个插件集合，涵盖所需的各类插件功能</li></ol> <p>很显然，第一种做法是相对麻烦的。针对第二种做法，Babel 提供了插件集 preset。</p> <p>preset 在 Babel 源码中，以 <code>babel-preset</code> 开头。</p> <p>例如，Babel 已经提供了几种常用的 preset 供开发者使用:</p> <ul><li><code>babel-preset-env</code></li> <li><code>babel-preset-react</code></li> <li><code>babel-preset-flow</code></li> <li><code>babel-preset-typescript</code></li></ul></li> <li><p>插件运行顺序</p> <p>Babel 配置项中，plugins 和 presets 均以数组的形式配置，执行时有先后顺序。</p> <ul><li>plugins 在 presets之前运行</li> <li>plugins 按照数组正序执行</li> <li>presets 按照数组倒序执行</li></ul> <p><img src="https://user-images.githubusercontent.com/5757051/155268224-00fe6902-8ab8-4054-828f-85197e97ffc3.png" alt="Babel概述/插件运行顺序"></p></li></ul> <h3 id="_2-4-工具模块"><a href="#_2-4-工具模块" class="header-anchor">#</a> 2.4 工具模块</h3> <p>工具模块提供 Babel 相关模块所需的各类工具，以下一一简要介绍:</p> <ul><li><p>babel-core</p> <p>babel-core 对外提供了 Babel 多项功能的 API，如转译文件、转译代码、创建/获取配置等，在 Babel 官方文档介绍的比较详细，不再赘述。</p> <p>值得注意的是，转译类的 API 均提供了同步和异步版本，如 <code>transformSync/transfomAsync</code>、<code>parseSync/parseAsync</code>。</p></li> <li><p>babel-cli</p> <p>Babel 的命令行工具，可以直接转译文件夹/文件，它也提供了很多配置项做其他工作，官方文档介绍的比较详细，感兴趣的同学可以去 Babel 官网查看详细配置。</p></li> <li><p>babel-standalone</p> <p>Babel 对外服务的很多包是基于 node 环境下使用的，babel-standalone 提供了浏览器下转译的方案。</p> <p>babel-standalone 内置了所有 Babel 插件，所以体积还是比较大的，而且在浏览器端转译需要时间，比较适合开发、学习使用，不适合在生产环境使用。</p> <p>举个例子:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>test babel-standalone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/@babel/standalone/babel.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/babel<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在浏览器运行该 html，可以看到，页面结构变成了:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>test babel-standalone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/@babel/standalone/babel.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/babel<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _console<span class="token punctuation">;</span>
        <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span>_console <span class="token operator">=</span> console<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_console<span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//# sourceMappingURL=data:application/json;charset=utf-8;base64...</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></li> <li><p>babel-node</p> <p>提供在命令行执行高级语法的环境。</p> <p>例如:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// index.js 里可以使用高级语法</span>
babel<span class="token operator">-</span>node <span class="token operator">-</span>e index<span class="token punctuation">.</span>js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>index.js 文件以及被其引入的其他文件均可以使用高级语法了。</p> <p>和 babel-cli 不同的是，babel-cli 只负责转换，不在 node 运行时执行；babel-node 会在 node 运行时执行转换，不适合生产环境使用。</p></li> <li><p>babel-register</p> <p>在源文件中，引入<code>babel-register</code>，如 index.js:</p> <p>index.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babel-register'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./run'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>run.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>执行 <code>node index</code> 时，run.js 就不需要被转码了。</p> <p>babel-register 通过拦截 node require 方法，为 node 运行时引入了 Babel 的转译能力。</p></li> <li><p>babel-loader</p> <p>babel-loader 并不是 Babel 官方提供的对外服务工具，它是独立的另一个项目，利用 babel-core 的 API 封装的 webpack loader，用于 webpack 构建过程。</p></li> <li><p>babel-types</p> <p>babel-types 是一个非常强大的工具集合，它集成了节点校验、增删改查等功能，是 Babel 核心模块开发、插件开发等场景下不可或缺的工具。</p> <p>例如:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> binaryExpression <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">binaryExpression</span><span class="token punctuation">(</span><span class="token string">'+'</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">numericLiteral</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">numericLiteral</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>babel-template</p> <p>模板引擎，负责将代码字符串转为 AST 节点对象。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> smart <span class="token keyword">as</span> template <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@babel/template'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> generate <span class="token keyword">from</span> <span class="token string">'@babel/generator'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> t <span class="token keyword">from</span> <span class="token string">'@babel/types'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> buildRequire <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  var %%importName%% = require(%%source%%);
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">buildRequire</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    importName<span class="token operator">:</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'myModule'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    source<span class="token operator">:</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;my-module&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>运行结果:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> myModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;my-module&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>babel-code-frame</p> <p>负责打印出错的代码位置，例如:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> codeFrameColumns <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/code-frame'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> testCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
class Run {
    constructor() {}
}
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">line</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">column</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">codeFrameColumns</span><span class="token punctuation">(</span>testCode<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>  <span class="token number">1</span> <span class="token operator">|</span> class Run <span class="token punctuation">{</span>
<span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">|</span>     <span class="token function-name function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token operator">|</span>  ^
  <span class="token number">3</span> <span class="token operator">|</span> <span class="token punctuation">}</span>
  <span class="token number">4</span> <span class="token operator">|</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>babel-highlight</p> <p>向控制台输出有颜色的代码片段。该工具可以识别 JavaScript 中的操作符号、标识符、保留字等类型的词法单元，并在终端环境下显示不同的颜色。</p></li></ul> <h3 id="_2-5-运行时相关模块"><a href="#_2-5-运行时相关模块" class="header-anchor">#</a> 2.5 运行时相关模块</h3> <p>Babel 配合其插件可以对静态代码进行转译，但有一些遗漏点:</p> <ul><li>对于运行时涉及的一些高版本 API，并没有提供兼容目标环境的 Polyfill</li> <li>转译产物代码可能有些臃肿</li></ul> <p>为此，运行时模块(runtime)关注的是转译产物的运行时环境，对运行时提供 API polyfill、代码优化等，该模块涉及几个子包:</p> <ul><li>babel-preset-env</li> <li>babel-plugin-transform-runtime</li> <li>babel-runtime</li> <li>babel-runtime-corejs2/3</li> <li>core-js</li></ul> <p>接下来以案例解释 runtime 模块的作用。</p> <p>源码文件 index.js 的内容:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// const 为语法部分</span>
<span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// class 为语法部分</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Promise 为 API 部分</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这段源码包含了语法和 API 部分:</p> <ul><li><code>const</code>、<code>class</code> 为语法部分</li> <li><code>Promise</code> 为 API 部分</li></ul> <p>如果希望这段源码转为 ES5 版本，使构建产物可以运行在不支持 ES6 和 Promise 的环境里，该怎么做呢？</p> <p>用 babel 命令行执行转译，其中源文件为 index.js，转译产物文件为 index-compiled.js。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>npx babel index.js --out-file index-compiled.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>安装 node 或 npm 后，可直接使用 npx 唤起各类命令行执行</p></blockquote> <p>需要配置 <code>.babelrc</code> 帮助 Babel 完成语法和 API 部分的转译:</p> <p><code>.babelrc</code>:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> 
            <span class="token string">&quot;@babel/preset-env&quot;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;@babel/plugin-transform-runtime&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;corejs&quot;</span><span class="token operator">:</span> <span class="token number">3</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>简要解释下该配置的原理:</p> <ul><li><p>babel-preset-env 可以完成语法部分转译，即 <code>const</code> 转译为<code>var</code></p> <p>但构建产物中，有些辅助代码如 <code>_classCallCheck</code> 是以硬编码的形式直接写入转译产物的:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot call a class as a function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">Base</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这样的后果就是构建产物比较臃肿。</p></li> <li><p>babel-plugin-transform-runtime 可以将上述 <code>_classCallCheck</code> 置于通用包中，以引用的形式写入转译产物:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _interopRequireDefault <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/interopRequireDefault&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _classCallCheck2 <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/classCallCheck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">Base</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _classCallCheck2<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li> <li><p>babel-plugin-transform-runtime 的配置参数 <code>corejs</code> 用于转译 API 部分，如 <code>Promsie</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _interopRequireDefault <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime-corejs3/helpers/interopRequireDefault&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _promise <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime-corejs3/core-js-stable/promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _classCallCheck2 <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime-corejs3/helpers/classCallCheck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">Base</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _classCallCheck2<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">_promise</span><span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li></ul> <p>Babel 转译过程的运行时优化是一个繁琐的过程，为此将单独用一章讲解运行时优化，感兴趣的同学可以直接阅读 &quot;Babel Runtime&quot; 章节详细了解。</p> <h2 id="_3-使用-babel"><a href="#_3-使用-babel" class="header-anchor">#</a> 3 使用 Babel</h2> <h3 id="_3-1-对外工具集"><a href="#_3-1-对外工具集" class="header-anchor">#</a> 3.1 对外工具集</h3> <p>在介绍 Babel 微内核架构时，面向用户使用的工具，有这些:</p> <ul><li>babel-cli</li> <li>babel-node</li> <li>babel-register</li> <li>babel-standalone</li> <li>babel-parser</li> <li>babel-loader</li></ul> <p>由此看出，Babel 官方和社区提供了众多工具以满足开发者在不同场景下使用 Babel 的需要，下图是 Babel 可以使用的场景分类:</p> <p><img src="https://user-images.githubusercontent.com/5757051/155268321-a4fd97d5-4914-4494-a3d3-95c0aaf0222f.png" alt="Babel概述/对外工具集"></p> <h3 id="_3-2-配置-babel"><a href="#_3-2-配置-babel" class="header-anchor">#</a> 3.2 配置 Babel</h3> <h3 id="多种配置方式"><a href="#多种配置方式" class="header-anchor">#</a> 多种配置方式</h3> <p>Babel 支持多种配置方式。</p> <h4 id="文件式配置"><a href="#文件式配置" class="header-anchor">#</a> 文件式配置</h4> <ul><li><p>配置文件列表</p> <ul><li><p><code>babel.config.</code> 为前缀的文件</p> <ul><li>babel.config.json</li> <li>babel.config.js</li> <li>babel.config.cjs</li> <li>babel.config.mjs</li></ul></li> <li><p><code>.babelrc</code> 为前缀的文件</p> <ul><li>.babelrc.json</li> <li>.babelrc.js</li> <li>.babelrc.cjs</li> <li>.babelrc.mjs</li></ul> <p>其他工具如 ESLint、Prettier 也有类似的配置文件: .eslintrc、.prettierrc。</p></li> <li><p>package.json 中</p> <p>package.json 中的 &quot;babel&quot; 字段。</p></li></ul></li> <li><p>配置文件格式</p> <p>不同后缀名的配置文件，其配置内容需遵循不同的格式规范。</p> <ul><li><p><code>.cjs</code> 文件，内容是 CommonJS 规范</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> presets <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token operator">...</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token operator">...</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> presets<span class="token punctuation">,</span> plugins <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p><code>.mjs</code> 文件，内容是 ECMAScript modules 格式</p> <p>可以在 Node.js 13.2 及以上版本试用，也可以在较老版本 Node.js 的 <code>--experimental-modules</code> 标记下使用。</p></li> <li><p><code>.js</code> 文件内容，可以是 CommonJS 规范，也可以是 ECMAScript modules 格式</p> <p>如果在 package.json 中指定 <code>&quot;type&quot;: &quot;module&quot;</code>，<code>babel.config.js</code> 和 <code>.babelrc.js</code> 文件即可使用 ECMAScript modules。</p> <p>否则，<code>babel.config.js</code> 和 <code>.babelrc.js</code> 文件需要使用 CommonJS 规范。</p></li> <li><p><code>.json</code> 文件，内容可以是: JSON5 规范、CommonJS 规范</p> <p>JSON5 规范的写法:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;my-package&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;babel&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> ... <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> ... <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ul></li></ul> <h4 id="命令行式配置"><a href="#命令行式配置" class="header-anchor">#</a> 命令行式配置</h4> <p>Babel 支持执行 <code>babel</code> 命令行时指定配置。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>babel --plugins @babel/plugin-transform-arrow-functions script.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="api-式配置"><a href="#api-式配置" class="header-anchor">#</a> API 式配置</h4> <p>通过调用 Babel 提供的 API，并为其传参。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/core&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transformSync</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;@babel/plugin-transform-arrow-functions&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="项目级配置与局部配置"><a href="#项目级配置与局部配置" class="header-anchor">#</a> 项目级配置与局部配置</h3> <p>Babel7 新增了项目级配置和局部配置的概念，其配置文件有两种作用范围: 完整的项目范围、子项目范围。</p> <p><code>babel.config.</code> 系列的配置文件，影响范围是整个项目。</p> <p><code>.babelrc</code> 系列的配置文件，影响范围是子项目。</p> <p>官方文档对此有详细的描述，以下是笔者整理后的配置文件作用范围描述:</p> <ul><li><p>项目级配置文件（<code>babel.config.</code> 系列）</p></li> <li><p>局部配置文件（<code>.babelrc</code> 系列）</p> <p>对于当前正在被转译的文件，Babel 会逐级向上查找 <code>.babelrc</code> 系列的配置文件，直到第一个有 <code>package.json</code> 的目录、或当前项目的 <code>root</code> 目录。</p> <p>找到局部配置文件后，会将其内容和 <code>babel.config.json</code> 之类的配置内容合并。</p></li></ul> <h3 id="配置项"><a href="#配置项" class="header-anchor">#</a> 配置项</h3> <ul><li><p>Primary options</p> <p>这些配置在 API 中使用，相对于文件形式（<code>.babelrc</code> 等）的配置，它们的优先级更高些，因此成为 <code>Primary options</code>。</p> <ul><li><p><code>cwd: string</code></p> <p>默认值是: <code>process.cwd()</code></p> <p>Babel 运行过程中，所有子路径的相对地址，应用于 API 调用时。</p></li> <li><p><code>caller: CallerData</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">CallerData</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
    supportsStaticESM<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    supportsDynamicImport<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    supportsTopLevelAwait<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    supportsExportNamespaceFrom<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>提供给 Babel 自身配置项、<code>plugins</code>、<code>presets</code> 的一些快捷灵活配置项。</p></li> <li><p><code>filename: string</code></p> <p>这是个非必填项。可用于 API 调用时，一些其他配置项依赖 <code>filename</code> 的配置。</p> <p>这里有一些场景可能需要配置 <code>filename</code>:</p> <ul><li><code>filename</code> 的值可以暴露给插件做进一步处理</li> <li><code>test</code>、<code>exclude</code>、<code>ignore</code> 等配置项需要 <code>filename</code> 有值用于匹配</li> <li>不提供 <code>filename</code> 的情况下，查找 <code>.babelrc.json</code>、<code>.babelrc</code> 这些配置文件时，会相对于被转译的目标文件；如果提供了 <code>filename</code>，会默认执行 <code>babelrc: false</code> 的逻辑</li></ul></li> <li><p><code>filenameRelative: string</code></p> <p>默认值: <code>path.relative(opts.cwd, opts.filename)</code>。</p> <p><code>filenameRelative</code> 的值会是配置项 <code>sourceFileName</code> 的默认值。</p></li> <li><p><code>code: boolean</code></p> <p>默认是 <code>true</code>。</p> <p>默认情况下，api 如 <code>transformSync</code> 在转译后会返回转译后的代码，也就是 <code>code</code>。但可能存在不需要 <code>code</code> 的时候，比如在多级转译时，前后逻辑仅需要 AST 传递即可。</p></li> <li><p><code>ast: boolean</code></p> <p>默认是 <code>false</code>，api 如 <code>transformSync</code> 并不会返回转移后代码的 AST 对象，也是出于性能考虑，因为 Babel 会优先为转译结果添加本地缓存文件，而 AST 对象需要占用挺大空间的。</p> <p>如果需要在多级转译时，利用中间过程产生的 AST 对象，就可以设置为 <code>true</code> 了:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token string">&quot;example.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> source <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Load and compile file normally, but skip code generation.</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> ast <span class="token punctuation">}</span> <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transformSync</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">,</span>
    <span class="token literal-property property">ast</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Minify the file in a second pass and generate the output code here.</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> map <span class="token punctuation">}</span> <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transformFromAstSync</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">,</span>
    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;minify&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">babelrc</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">configFile</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li> <li><p><code>cloneInputAst: boolean</code></p> <p>默认值是 <code>true</code>。</p> <p>例如:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> map <span class="token punctuation">}</span> <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transformFromAstSync</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">,</span>
    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;minify&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">babelrc</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">configFile</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>babel.transformFromAstSync</code> 会接受一个 ast 对象进行各种操作，内部会复制一个新的 ast 对象避免修改传入的 ast 对象。当然开发者可以决定是否需要复制，毕竟复制的开销是比较大的。</p></li></ul></li> <li><p>Config Loading options</p> <ul><li><p><code>root</code></p> <p>仅用于 API 调用环境。类型是 <code>string</code>，默认值是 <code>opts.cwd</code> 的值，<code>opts.cwd</code> 的默认值是 <code>process.cwd()</code>。</p> <p>这是一个基准路径，与 <code>rootMode</code> 配合使用，它决定了当前 Babel 作用项目的根路径（root folder）是什么。</p> <p>这个基准值可以用来:</p> <ul><li>作为查找 <code>configFile</code> 配置项的基准路径</li> <li>作为 <code>babelrcRoots</code> 配置项的默认值</li></ul></li> <li><p><code>rootMode</code></p> <p>仅用于 API 调用环境。类型是 <code>&quot;root&quot; | &quot;upward&quot; | &quot;upward-optional&quot;</code>。默认值是 <code>&quot;root&quot;</code>。</p> <p><code>rootMode</code> 与 <code>root</code> 配合使用，它决定了当前 Babel 作用项目的根路径。</p> <ul><li><code>&quot;root&quot;</code>: 和默认值一样，描述当前 Babel 作用项目的根路径</li> <li><code>&quot;upward&quot;</code>: 沿着 <code>root</code> 配置项持续向上查找，发现 <code>babel.config.json</code> 文件后停止向上遍历，否则会一直遍历到系统根目录</li> <li><code>&quot;upward-optional&quot;</code>: 和 <code>&quot;upward&quot;</code> 一样，但如果遍历到系统根目录也没有发现 <code>babel.config.json</code> 文件，会退回到 <code>&quot;root&quot;</code> 值</li></ul></li> <li><p><code>envName</code></p> <p>仅用于 API 调用环境。类型是 <code>string</code>。默认值是 <code>process.env.BABEL_ENV || process.env.NODE_ENV || &quot;development&quot;</code>。</p> <p>可以在配置文件的 <code>&quot;env&quot;</code> 配置项里，或 <code>api.env()</code> 方法使用。</p></li> <li><p><code>configFile</code></p> <p>仅用于 API 调用环境。类型是 <code>string | boolean</code>。默认值是 <code>path.resolve(opts.root, &quot;babel.config.json&quot;)</code>，但内部会判断该路径的文件是否存在，如果不存在，值会被调整为 <code>false</code>。</p></li> <li><p><code>babelrc</code></p> <p>仅用于 API 调用环境。类型是 <code>boolean</code>。默认值是 <code>true</code>。</p></li> <li><p><code>babelrcRoots</code></p></li></ul></li> <li><p>Plugin and Preset options</p> <ul><li><p><code>plugins/presets</code></p> <p><code>plugin/preset</code> 配置规范相同。</p> <p>对于 <code>plugin/preset</code>，如下配置方式的含义是一致的:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;pluginA&quot;</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span> <span class="token string">&quot;pluginA&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span> <span class="token string">&quot;pluginA&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>[ &quot;pluginA&quot;, {} ]</code> 这种写法可以为 plugin/preset 描述更具体的配置，如:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;transform-async-to-module-method&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bluebird&quot;</span><span class="token punctuation">,</span>
                <span class="token string-property property">&quot;method&quot;</span><span class="token operator">:</span> <span class="token string">&quot;coroutine&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;loose&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token string-property property">&quot;modules&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li> <li><p><code>passPerPreset</code></p></li></ul></li> <li><p>Output targets</p> <ul><li><p><code>targets</code></p> <p>类型 <code>string | Array&lt;string&gt; | { [string]: string }</code>。默认值 <code>{}</code>。</p> <ul><li><p>举例</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;targets&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&gt; 0.25%, not dead&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>要适配的目标环境的最小版本:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;targets&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;chrome&quot;</span><span class="token operator">:</span> <span class="token string">&quot;58&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;ie&quot;</span><span class="token operator">:</span> <span class="token string">&quot;11&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>目标环境可以是: <code>chrome</code>, <code>opera</code>, <code>edge</code>, <code>firefox</code>, <code>safari</code>, <code>ie</code>, <code>ios</code>, <code>android</code>, <code>node</code>, <code>electron</code>。</p></li> <li><p>没有设置 <code>targets</code> 时</p> <p>如果没有设置 <code>targets</code>，Babel 默认会假设你要适配最古老的浏览器版本，当然这样是不推荐的，因为转译后的文件会比较大。</p> <p>截至本书截稿时，如果使用者没有指定 <code>targets</code> 的值，Babel 也不会像 browserslist 那样提供一个 <code>&quot;defaults&quot;</code> 的默认值。</p></li> <li><p><code>targets.esmodules</code></p> <p>类型 <code>boolean</code>。默认值 ??</p> <p>可以指定支持 esmodules 的目标浏览器。</p></li> <li><p><code>targets.node</code></p> <p>类型 <code>string | &quot;current&quot; | true</code>。</p></li> <li><p><code>targets.safari</code></p> <p>类型 <code>string | &quot;tp&quot;</code>。</p> <p>可以通过设置为 <code>&quot;tp&quot;</code> 来指定 safari 的 <code>technology preview</code> 版本。</p></li> <li><p><code>targets.browsers</code></p> <p>类型 <code>string | Array&lt;string&gt;</code>。它的语法是 browserslist 的查询语法。</p></li></ul></li> <li><p><code>browserslistConfigFile</code></p> <p>类型 <code>boolean</code>。默认值是 <code>true</code>。用于 browserslist 查询配置用。</p></li> <li><p><code>browserslistEnv</code></p> <p>类型是 <code>string</code>。默认 <code>undefined</code>。</p></li></ul></li> <li><p>Config Merging options</p> <ul><li><p><code>extends</code></p> <p>类型是 <code>string</code>。</p></li> <li><p><code>env</code></p> <p>类型是 <code>{ [envKey: string]: Options }</code>。</p></li> <li><p><code>overrides</code></p> <p>类型是 <code>Array&lt;Options&gt;</code>。</p></li> <li><p><code>test</code></p> <p>类型是 <code>MatchPattern | Array&lt;MatchPattern&gt;</code>。</p></li> <li><p><code>include</code></p> <p>类型是 <code>MatchPattern | Array&lt;MatchPattern&gt;</code>。</p> <p>同 <code>test</code>。</p></li> <li><p><code>exclude</code></p> <p>类型是 <code>MatchPattern | Array&lt;MatchPattern&gt;</code>。</p></li> <li><p><code>ignore</code></p> <p>类型 <code>Array&lt;MatchPattern&gt;</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">ignore</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./lib&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><code>only</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">only</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./src&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li> <li><p>Source Map options</p> <ul><li><p><code>inputSourceMap</code></p> <p>类型 <code>boolean | SourceMap</code>。默认值 <code>true</code>。</p> <ul><li><code>true</code>: 如果存在注释 <code>//# sourceMappingURL=...</code>，会尝试在 Babel 要转译的文件中寻找 sourceMap 的信息，如果加载失败的话就忽略</li> <li><code>SourceMap</code>: 也可以传入一个 sourceMap 对象</li></ul></li> <li><p><code>sourceMaps</code></p> <p>类型 <code>boolean | &quot;inline&quot; | &quot;both&quot;</code>。默认值 <code>false</code>。</p> <ul><li><code>true</code>: 转译时会生成 sourceMap，并在转译结果对象中添加 sourceMap 结果对象</li> <li><code>&quot;inline&quot;</code>: 转译时会生成 sourceMap，并在转译结果代码中添加以 <code>data</code> 开头的 sourceMap 代码</li> <li><code>&quot;both&quot;</code>: 综合了 <code>true</code> 和 <code>&quot;inline&quot;</code></li></ul></li> <li><p><code>sourceMap</code></p> <p>同 <code>sourceMaps</code> 配置项，推荐使用 <code>sourceMaps</code>。</p></li> <li><p><code>sourceFileName</code></p> <p>类型 <code>string</code>。默认值 <code>path.basename(opts.filenameRelative)</code>，如果不可用，会被重置为 <code>unknown</code>。</p> <p>用于 sourceMap 对象内部。</p></li> <li><p><code>sourceRoot</code></p> <p>类型 <code>string</code>。</p> <p>设置生成的 sourceMap 中的 <code>sourceRoot</code> 字段。</p></li></ul></li> <li><p>Misc options</p> <ul><li><p><code>sourceType</code></p> <p>类型 <code>&quot;script&quot; | &quot;module&quot; | &quot;unambiguous&quot;</code>。默认 <code>&quot;module&quot;</code>。</p> <ul><li><code>&quot;script&quot;</code>: 使用 ECMAScript Script 语法转译。不允许出现 <code>import/export</code> 语句的写法。</li> <li><code>&quot;module&quot;</code>: 使用 ECMAScript Module 语法转译。允许出现 <code>import/export</code> 语句的写法，并默认转译为严格模式。</li> <li><code>&quot;unambiguous&quot;</code>: 自动化判断，如果源码中出现了 <code>import/export</code> 语句，就用 <code>&quot;module&quot;</code> 模式，否则用 <code>&quot;script&quot;</code> 模式。</li></ul></li> <li><p><code>assumptions</code></p> <p>类型 <code>{ [assumption: string]: boolean }</code>。默认 <code>{}</code>。</p> <p>允许使用在 API 使用、配置文件、<code>presets</code> 中。</p> <p>它可以用来减少转译结果大小。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;assumptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;iterableIsArray&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p><code>highlightCode</code></p> <p>类型 <code>boolean</code>。默认 <code>true</code>。</p> <p>在错误提示里对源码高亮展示。</p></li> <li><p><code>wrapPluginVisitorMethod</code></p> <p>类型 <code>(key: string, nodeType: string, fn: Function) =&gt; Function</code>。</p> <p>该方法可用于 AST 节点被内部访问等处理时，开发者做拦截处理。</p> <ul><li><code>key</code>: ??</li> <li><code>nodeType</code>: AST 节点类型</li> <li><code>fn</code>: AST 节点内部处理函数</li></ul> <p>开发者需要返回一个新的函数，并在新函数里执行旧的处理函数 <code>fn</code>。</p></li> <li><p><code>parserOpts</code></p> <p>类型 <code>{}</code>。用于给 babel-parser 提供配置项。</p></li> <li><p><code>generatorOpts</code></p> <p>类型 <code>{}</code>。用于给 babel-generator 提供配置项。</p></li></ul></li> <li><p>Code Generator options</p> <ul><li><p><code>retainLines</code></p> <p>类型 <code>boolean</code>。默认值 <code>false</code>。</p> <p>？？</p></li> <li><p><code>compact</code></p> <p>类型 <code>boolean | &quot;auto&quot;</code>。默认值 <code>&quot;auto&quot;</code>。</p> <p>？？</p></li> <li><p><code>minified</code></p> <p>类型 <code>boolean</code>。默认值 <code>false</code>。</p> <p>如果设置为 <code>true</code>，会省略块级代码结尾的分号、省略 <code>new Foo()</code> 中的 <code>()</code>、生成更短形式的字面量描述方式等。</p></li> <li><p><code>auxiliaryCommentBefore</code></p> <p>类型 <code>string</code>。</p></li> <li><p><code>auxiliaryCommentAfter</code></p></li> <li><p><code>comments</code></p> <p>类型 <code>boolean</code>。默认 <code>true</code>。</p></li> <li><p><code>shouldPrintComment</code></p> <p>类型 <code>(value: string) =&gt; boolean</code>。</p> <p>如果同时设置了 <code>minified</code>，那么其默认值是 <code>(val) =&gt; opts.comments || /@license|@preserve/.test(val)</code>。</p> <p>如果没有设置 <code>minified</code>，那么其默认值是 <code>() =&gt; opts.comments</code>。</p> <p>用于决定哪些注释可以在最终输出的转译结果中保留（通常注释是会被删除的）。</p></li></ul></li> <li><p>AMD / UMD / SystemJS module options</p> <ul><li><p><code>moduleIds</code></p> <p>类型 <code>boolean</code>。默认 <code>!!opts.moduleId</code>。</p> <p>是否开启 <code>module ID</code> 的转译。</p></li> <li><p><code>moduleId</code></p> <p>类型 <code>string</code>。</p> <p>用于描述当前转译的 <code>module</code> ID，这是硬编码的。不能与 <code>getModuleId</code> 同时使用。</p></li> <li><p><code>getModuleId</code></p> <p>类型 <code>(name: string) =&gt; string</code>。</p> <p>？？</p></li> <li><p><code>moduleRoot</code></p> <p>类型 <code>string</code>。</p> <p>为生成的 module 名字上添加根路径。</p></li></ul></li> <li><p>Options Concepts</p> <ul><li><p><code>MatchPattern</code></p> <p>类型 <code>string | RegExp | (filename: string | void, context: { caller: { name: string } | void, envName: string, dirname: string ) =&gt; boolean</code>。</p></li></ul></li></ul> <h3 id="配置合并规则"><a href="#配置合并规则" class="header-anchor">#</a> 配置合并规则</h3> <p>Babel 配置的合并遵循以下方式:</p> <ul><li><p><code>Array#concat</code></p> <p>针对 <code>plugins/presets</code>，用 <code>Array#concat</code> 合并，因为它们均为数组。</p></li> <li><p><code>Object.assign</code></p> <p><code>plugins/presets</code> 之外的配置，使用 <code>Object.assign</code> 做覆盖式合并。</p></li></ul> <p>下面是官方文档的案例:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;plugin-1a&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">loose</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span> 
        <span class="token string">&quot;plugin-1b&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;preset-1a&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">&quot;script&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> newConfigItem <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;plugin-1a&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">loose</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span> 
        <span class="token string">&quot;plugin-2b&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;preset-1a&quot;</span><span class="token punctuation">,</span> 
        <span class="token string">&quot;preset-2a&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span>
<span class="token punctuation">}</span>

<span class="token function">BabelConfigMerge</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> newConfigItem<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// returns</span>
<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;plugin-1a&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">loose</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token string">&quot;plugin-1b&quot;</span><span class="token punctuation">,</span>

        <span class="token punctuation">[</span>
            <span class="token string">&quot;plugin-1a&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">loose</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>  <span class="token comment">// concat 推入的配置</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token string">&quot;plugin-2b&quot;</span> <span class="token comment">// concat 推入的配置</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;preset-1a&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;preset-1a&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// concat 推入的配置</span>
        <span class="token string">&quot;preset-2b&quot;</span>  <span class="token comment">// concat 推入的配置</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span> <span class="token comment">// sourceType: &quot;script&quot; 值被新值覆盖</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h3 id="plugins-presets-配置"><a href="#plugins-presets-配置" class="header-anchor">#</a> Plugins/Presets 配置</h3> <p>Babel 支持对 Plugins 和 Presets 多种形式的配置，可配置的方式有:</p> <ul><li><code>EntryTarget</code></li> <li><code>[EntryTarget, EntryOptions]</code></li> <li><code>[EntryTarget, EntryOptions, string]</code></li> <li><code>ConfigItem</code></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// EntryTarget</span>
    <span class="token string">'@babel/plugin-transform-classes'</span><span class="token punctuation">,</span>

    <span class="token comment">// [EntryTarget, EntryOptions]</span>
    <span class="token punctuation">[</span><span class="token string">'@babel/plugin-transform-arrow-functions'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">spec</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// [EntryTarget, EntryOptions, string]</span>
    <span class="token punctuation">[</span><span class="token string">'@babel/plugin-transform-for-of'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">loose</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;some-name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// ConfigItem</span>
    babel<span class="token punctuation">.</span><span class="token function">createConfigItem</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/plugin-transform-spread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li><p><code>EntryTarget: string | {} | Function</code></p> <ul><li><code>string</code>: 要求是 Babel plugin/preset 的路径、名字（如 <code>env / @babel/preset-env</code>，会经过格式化的）。</li> <li><code>{} | Function</code>: 要求是 Babel plugin/preset 对象或函数。</li></ul></li> <li><p><code>EntryOptions: undefined | {} | false</code></p> <ul><li><p><code>undefined</code>: 没有设置，内部会重置为空对象 <code>{}</code>。</p></li> <li><p><code>false</code>: 禁用该 plugin/preset，这个可用于提升转译速度等情况下，由开发者决定是否开启。</p> <p>但是 <code>overrides</code> 配置项的优先级高于它:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'one'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token string">'two'</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'three'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token literal-property property">overrides</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token string">&quot;./src&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">'two'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>以上配置的效果是:</p> <ul><li><code>two</code> 会参与对 <code>./src</code> 路径下文件的转译，其他路径不参与</li> <li><code>two</code> 的转译依然发生在 <code>one</code> 和 <code>three</code> 之间</li></ul></li></ul></li> <li><p>对 plugin/preset 名称的格式化</p> <p>Babel 支持多种对 plugin/preset 名称的简写，当然要遵循一定的规则:</p> <ul><li>绝对路径</li> <li>以 <code>./</code> 开头的相对路径</li> <li>以 <code>moudle:</code> 开头的名称</li> <li>以 <code>@babel</code> 开头的名称内，会默认为添加 <code>plugin-</code> 和 <code>preset-</code> 前缀，如 <code>@babel/env</code> 会被格式化为 <code>@babel/preset-env</code></li></ul> <p>| 输入 | 格式化结果 | 规则 |
| <code>&quot;/dir/plugin.js&quot;</code> | <code>&quot;/dir/plugin.js&quot;</code> | 绝对路径不处理 |
| <code>&quot;./dir/plugin.js&quot;</code> | <code>&quot;./dir/plugin.js&quot;</code> | 相对路径不处理 |
| <code>&quot;mod&quot;</code> | <code>&quot;babel-plugin-mod&quot;</code> | 未声明命名空间 <code>@babel</code>，且没有前缀的，会新增 <code>babel-plugin</code> 前缀 |
| <code>&quot;mod/plugin&quot;</code> | <code>&quot;mod/plugin&quot;</code> | |
| <code>&quot;babel-plugin-mod&quot;</code> | <code>&quot;babel-plugin-mod&quot;</code> | 有 <code>babel-plugin</code> 前缀，不处理 |
| <code>&quot;@babel/mod&quot;</code> | <code>&quot;@babel/plugin-mod&quot;</code> | 以 <code>@babel</code> 命名空间开头，会添加 <code>plugin</code> 前缀 |
| <code>&quot;@babel/plugin-mod&quot;</code> | <code>&quot;@babel/plugin-mod&quot;</code> | 以 <code>@babel</code> 命名空间开头，且有 <code>plugin</code> 前缀，不处理 |
| <code>&quot;@babel/mod/plugin&quot;</code> | <code>&quot;@babel/mod/plugin&quot;</code> | |
| <code>&quot;@scope&quot;</code> | <code>&quot;@scope/babel-plugin&quot;</code> | 在 <code>@</code> 开头的某个命名空间上，添加 <code>babel-plugin</code> 前缀 |
| <code>&quot;@scope/babel-plugin&quot;</code> | <code>&quot;@scope/babel-plugin&quot;</code> | |
| <code>&quot;@scope/mod&quot;</code> | <code>&quot;@scope/babel-plugin-mod&quot;</code> | 在 <code>@</code> 开头的某个命名空间上，添加 <code>babel-plugin</code> 前缀 |
| <code>&quot;@scope/babel-plugin-mod&quot;</code> | <code>&quot;@scope/babel-plugin-mod&quot;</code> | |
| <code>&quot;@scope/prefix-babel-plugin-mod&quot;</code> | <code>&quot;@scope/prefix-babel-plugin-mod&quot;</code> | |
| <code>&quot;@scope/mod/plugin&quot;</code> | <code>&quot;@scope/mod/plugin&quot;</code> | |
| <code>&quot;module:foo&quot;</code> | <code>&quot;foo&quot;</code> | 以 <code>module:</code> 开头，会移除 <code>module:</code> |</p></li></ul> <h2 id="_4-babel-的项目管理"><a href="#_4-babel-的项目管理" class="header-anchor">#</a> 4 Babel 的项目管理</h2> <h3 id="_4-1-monorepo"><a href="#_4-1-monorepo" class="header-anchor">#</a> 4.1 monorepo</h3> <p>如果一个大型项目由多个子工程组成，该如何管理呢？</p> <p>通常来说，有以下方式:</p> <ul><li><p>monorepo</p> <p>monorepo 指的是，该项目所有工程统一在一个仓库中，维护、发布等操作统一进行。</p> <p>目前 Babel、React、Angular 等均采用该方式。</p> <p>monorepo 的代码结构为:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>├── packages
|   ├── pkg1
|   |   ├── package.json
|   ├── pkg2
|   |   ├── package.json
├── package.json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>multirepo</p> <p>和 monorepo 相反，该项目的每个子工程独立运行，每个子工程相互独立，自由选择构建工具，独立发布。</p> <p>multirepo 的代码结构为:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>├── project1
|   ├── package.json
├── project2
|   ├── package.json
├── project3
|   ├── package.json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>submodules</p> <p>submodules 是借助 git 的实现，在 <code>.gitmodules</code> 中写明引用的仓库，在主仓库中只保留必要的索引。</p></li></ul> <p>在此主要关注 monorepo 和 multirepo。二者对比如下:</p> <table><thead><tr><th>monorepo</th> <th>multirepo</th></tr></thead> <tbody><tr><td>所有项目在同一个分支内开发</td> <td>所有项目独立开发</td></tr> <tr><td>统一的 issue 管理</td> <td>分散的 issue 管理</td></tr> <tr><td>统一的开发环境</td> <td>分散的开发环境</td></tr> <tr><td>统一管理所有项目的版本</td> <td>各项目难以统一版本</td></tr> <tr><td>项目所需存储空间大</td> <td>项目分散，存储空间较小</td></tr></tbody></table> <p>Babel 项目涉及的子工程很多，其采用了 monorepo 方式开发，并且沉淀出了自动化工具 lerna。</p> <h3 id="_4-2-lerna"><a href="#_4-2-lerna" class="header-anchor">#</a> 4.2 lerna</h3> <ul><li><p>两种模式</p> <p>monorepo 有两种模式: <code>fixed</code> 和 <code>independent</code>，默认为 <code>fixed</code> 模式。</p> <ul><li><p><code>fixed</code> 模式</p> <p>该模式强制所有的包都使用在根目录 lerna.json 中指定的版本号。</p> <p>lerna 默认使用该模式。</p> <p>该模式下，每个 package 呈现&quot;黑盒&quot;状态，所有包统一迭代。</p></li> <li><p><code>independent</code>模式</p> <p>该模式允许各个包独立指定自己的版本号。</p> <p>可以使用 <code>lerna init --independent</code> 声明该模式，也可以将 <code>lerna.json</code> 的 <code>version</code> 字段指定为 <code>independent</code>。</p> <p>对于需要暴露内部细节、或者迭代频率显著不一致的包，比较适合该模式。</p></li></ul></li> <li><p>命令集</p> <p>以下是 lerna 的部分命令及功能:</p> <ul><li><code>lerna init</code>: 初始化一个项目</li> <li><code>lerna create</code>: 创建一个子 package</li> <li><code>lerna import</code>: 将已有项目导入为子 package</li> <li><code>lerna list</code>: 列举当前项目所有子 package</li> <li><code>lerna add</code>: 添加公共依赖</li> <li><code>lerna clean</code>: 删除子 package 的 node_modules</li> <li><code>lerna bootstrap</code>: 安装依赖、创建子 package 间的 symlink</li> <li><code>lerna diff</code>: 类似 git diff</li> <li><code>lerna changed</code>: 列出子 package 的所有变更</li> <li><code>lerna exec</code>: 在所有子 package 下执行 shell</li> <li><code>lerna run</code>: 在所有子 package 下执行 npm scripts 命令</li> <li><code>lerna link</code>: 将彼此依赖的子 package 关联起来</li> <li><code>lerna publish</code>: 发布子 package</li> <li><code>lerna version</code>: 确认发布的版本号</li></ul> <p>后面的章节对 lerna 有更详细的介绍。</p></li></ul> <h2 id="_5-标准化"><a href="#_5-标准化" class="header-anchor">#</a> 5 标准化</h2> <p>Babel 生态涉及的一些标准化组织。无论是 JavaScript、HTML、DOM、URL 等领域，均需要统一的标准，才能在不同的运行环境下有统一的表现。Babel 转译也需要遵循这些标准，包括 ECMAScript、web 标准等。</p> <p>// JavaScript 20年: https://cn.history.js.org/part-2.html</p> <p>https://zhuanlan.zhihu.com/p/22557749</p> <h3 id="_5-1-ecmascript"><a href="#_5-1-ecmascript" class="header-anchor">#</a> 5.1 ECMAScript</h3> <h3 id="javascript诞生"><a href="#javascript诞生" class="header-anchor">#</a> JavaScript诞生</h3> <p>1995 年，JavaScript 的第一个版本发布。用时间线的方式描述 JavaScript 的诞生过程会更清晰:</p> <p><img src="https://user-images.githubusercontent.com/5757051/155268504-5bf461c5-bb96-433d-b47b-9c78451f68d9.png" alt="标准化/JavaScript诞生"></p> <h3 id="ecmascript发布"><a href="#ecmascript发布" class="header-anchor">#</a> ECMAScript发布</h3> <p>1996 年，微软模仿 JavaScript 实现了 JScript 并内置在 IE3.0，随后，Netscape 公司着手推动 JavaScript 标准化。</p> <p>这里涉及几个组织:</p> <ul><li><p>Ecma International</p> <p>Ecma International 是一家国际性会员制度的信息和电信标准组织。1994年之前，名为欧洲计算机制造商协会（European Computer Manufacturers Association）。因为计算机的国际化，组织的标准牵涉到很多其他国家，因此组织决定改名表明其国际性。</p> <p>Ecma International 的任务包括与有关组织合作开发通信技术和消费电子标准、鼓励准确的标准落实、和标准文件与相关技术报告的出版。</p> <p>Ecma International 负责多个国际标准的制定:</p> <ul><li>CD-ROM 格式（之后被国际标准化组织批准为ISO 9660）</li> <li>C# 语言规范</li> <li>C++/CLI 语言规范</li> <li>通用语言架构（CLI）</li> <li>Eiffel 语言</li> <li>电子产品环境化设计要素</li> <li>Universal 3D 标准</li> <li>OOXML</li> <li>Dart 语言规范</li> <li>ECMAScript 语言规范（以 JavaScript 为基础）ECMA-262</li></ul> <p>其中就包括 JavaScript 标准语言规范 ECMAScript。</p> <p>Ecma International 拥有 ECMAScript 的商标。</p></li> <li><p>ECMA TC39</p> <p>「TC39」全称「Technical Committee 39」译为「第 39 号技术委员会」，是 Ecma International 组织架构中的一部分。</p> <p>TC39 负责迭代和发展 ECMAScript，它的成员由各个主流浏览器厂商的代表组成，通常每年召开约 6 次会议来讨论未决提案的进展情况，会议的每一项决议必须得到大部分人的赞同，并且没有人强烈反对才可以通过。</p> <p>TC39 负责:</p> <ul><li>维护和更新 ECMAScript 语言标准</li> <li>识别、开发、维护 ECMAScript 的扩展功能库</li> <li>开发测试套件</li> <li>为 ISO/IEC JTC 1 提供标准</li> <li>评估和考虑新添加的标准</li></ul></li> <li><p>ISO</p> <p>国际标准化组织（英语: International Organization for Standardization，简称: ISO）成立于 1947 年 2 月 23 日，制定全世界工商业国际标准的国际标准建立机构。</p> <p>ISO 总部设于瑞士日内瓦，现有 164 个会员国。该组织定义为非政府组织，官方语言是英语、法语和俄语。参加者包括各会员国的国家标准机构和主要公司。</p> <p>ISO 的国际标准以数字表示，例如: &quot;ISO 11180:1993&quot; 的 &quot;11180&quot; 是标准号码，而 &quot;1993&quot; 是出版年份。</p> <p>ISO/IEC JTC 1 是国际标准化组织和国际电工委员会联合技术委员会。其目的是开发、维护和促进信息技术以及信息和通信技术领域的标准。JTC 1 负责了许多关键的 IT 标准，从 MPEG 视频格式到 C++ 編程語言。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155268629-aa87a838-6e2d-4fd1-925c-aac33f0cb85a.png" alt="标准化/ECMA-ISO"></p></li> <li><p>ECMAScript 发展过程中的关键节点</p> <p><img src="https://user-images.githubusercontent.com/5757051/155268798-1e6d3585-fe7a-42ab-b770-aa0cd1653a21.png" alt="标准化/JavaScript标准化"></p></li></ul> <h3 id="ecmascript-各版本"><a href="#ecmascript-各版本" class="header-anchor">#</a> ECMAScript 各版本</h3> <p>ECMAScript 经历了多个版本，每个版本有自己的特点，简单列举如下:</p> <p><img src="https://user-images.githubusercontent.com/5757051/155269036-57f82a7e-69f4-4ff1-bdbc-653e39efef47.jpg" alt="标准化/ECMA版本"></p> <h3 id="ecmascript-迭代过程"><a href="#ecmascript-迭代过程" class="header-anchor">#</a> ECMAScript 迭代过程</h3> <p>https://erasermeng.github.io/2017/07/12/ECMAScript%E6%B5%81%E7%A8%8B%E8%A7%84%E8%8C%83%E7%AE%80%E4%BB%8B/</p> <p>一个 ECMAScript 标准的制作过程，包含了 Stage 0 到 Stage 4 共 5 个阶段，每个阶段提交至下一阶段都需要 TC39 审批通过。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155269169-c455f590-7486-4fc8-a19c-ed5668b84f80.jpg" alt="标准化/ECMA迭代流程"></p> <p>特性进入 Stage-4 后，才有可能被加入标准中，还需要 ECMA General Assembly 表决通过才能进入下一次的 ECMAScript 标准中。</p> <h3 id="_5-2-如何阅读-ecmascript"><a href="#_5-2-如何阅读-ecmascript" class="header-anchor">#</a> 5.2 如何阅读 ECMAScript</h3> <h3 id="ecmascript-文档结构"><a href="#ecmascript-文档结构" class="header-anchor">#</a> ECMAScript 文档结构</h3> <p>https://timothygu.me/es-howto/</p> <p>http://www.ruanyifeng.com/blog/2015/11/ecmascript-specification.html</p> <p>ECMAScript 的规格，可以在 ECMA 国际标准组织的官方网站免费下载和在线阅读。ECMAScript 不同版本的规格有独立的网址，网址格式为: www.ecma-international.org/ecma-262/{version}/。比如 ECMAScript 6.0 版本的网址为 <code>www.ecma-international.org/ecma-262/6.0/</code>。截止本书截稿时，官方网站支持的版本有: <code>6.0/7.0/8.0/9.0/10.0/11.0</code>。</p> <p><code>ECMAScript 6.0</code>、<code>ECMAScript 7.0</code> 有 26 章，之后的版本有 27 章，虽然章节数量不同，规格章节的分布是保持一定规律的，以 <code>ECMAScript 11.0</code> 版本为例:</p> <ul><li><p>Introduction: 介绍部分</p> <p>该章节简要描述了: JavaScript 和 ECMAScript 的发展历史、不同 ECMAScript 规格的主要更新内容。</p></li> <li><p>第 1 章到第 3 章: 描述了规格文件本身，而非语言</p> <p>第 1 章用一句话描述了该规格的描述范围。</p> <p>第 2 章描述了基于规格的&quot;实现&quot;的一致性要求:</p> <ul><li>&quot;实现&quot;必须支持规格中描述的所有类型、值、对象、属性、函数以及程序的语法和语义</li> <li>&quot;实现&quot;必须按照 Unicode 标准和 ISO/IEC 10646 的最新版本处理文本输入</li> <li>&quot;实现&quot;如果提供了应用程序编程接口（API），那么该 API 需要适应不同的人文语言和国家差异，且必须实现最新版本的 ECMA-402 所定义的与本规范相兼容的接口</li> <li>&quot;实现&quot;可以支持该规格中没有提及的类型、值、对象、属性、函数、正则表达式语法以及其他编程写法</li> <li>&quot;实现&quot;不能实现该规格中禁止的写法</li></ul> <p>第 3 章描述了该规格的一些参考资料:</p> <ul><li>ISO/IEC 10646</li> <li>ECMA-402</li> <li>EMCA-404 JSON 数据交换格式规范</li></ul></li> <li><p>第 4 章: 对这门语言总体设计的描述。</p></li> <li><p>第 5 章到第 8 章: 语言宏观层面的描述。</p> <p>第 5 章是规格的名词解释和写法的介绍。</p> <p>第 6 章介绍数据类型。</p> <p>第 7 章介绍语言内部用到的抽象操作。</p> <p>第 8 章介绍代码如何运行。</p></li> <li><p>第 9 章到第 27 章: 介绍具体的语法。</p></li></ul> <p>一般而言，除非写编译器，开发者无需阅读 ECMAScript 的规格，规格的内容非常多，如无必要也无需通读。只是在遇到一些奇怪的问题时，阅读官方规格，是最稳妥的办法。</p> <h3 id="通过阅读规格解决一些问题"><a href="#通过阅读规格解决一些问题" class="header-anchor">#</a> 通过阅读规格解决一些问题</h3> <ul><li><p>识别关键词和保留字，并高亮</p> <p>Babel 工具集中的 babel-highlight，可以实现在终端对代码块中的目标字符单元显示不同的颜色。这里需要识别不同字符单元的类型，如关键字、保留字、标识符、数字、字符串等。</p> <p>标识符、数字、字符串都很好理解和识别，但哪些字符应该被识别为关键字、保留字，而不是标识符呢？</p> <p>此时可以阅读 ECMAScript 规格了，ECMAScript 11.0 规格的 11.6.2 节介绍了关键词和保留字列表。</p> <ul><li><p>关键词（keywords）</p> <p>关键词首先是标识符，同时有语义，包括 <code>if、while、async、await...</code>，个别关键词是可以用作变量名的。</p></li> <li><p>保留字（reserved word）</p> <p>保留字首先是标识符，但不能用作变量名。</p> <p>部分关键词是保留字，但部分不是: <code>if、while</code> 是保留字；<code>await</code> 只有在 <code>async</code> 方法和模块中才是保留字；<code>async</code> 不是保留字，它可以作为普通的变量名使用。</p></li> <li><p>保留字列表</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">await</span> <span class="token keyword">break</span> <span class="token keyword">case</span> catch <span class="token keyword">class</span> <span class="token class-name">const</span> <span class="token keyword">continue</span> <span class="token keyword">debugger</span> <span class="token keyword">default</span> <span class="token keyword">delete</span> <span class="token keyword">do</span> <span class="token keyword">else</span> <span class="token keyword">enum</span> <span class="token keyword">export</span> <span class="token keyword">extends</span> <span class="token class-name">false</span> finally <span class="token keyword">for</span> <span class="token keyword">function</span> <span class="token keyword">if</span> <span class="token keyword">import</span> <span class="token keyword">in</span> <span class="token keyword">instanceof</span> <span class="token class-name">new</span> <span class="token keyword">null</span> returns uper <span class="token keyword">switch</span> <span class="token keyword">this</span> <span class="token keyword">throw</span> <span class="token boolean">true</span> <span class="token keyword">try</span> <span class="token keyword">typeof</span> <span class="token keyword">var</span> <span class="token keyword">void</span> <span class="token keyword">while</span> <span class="token keyword">with</span> <span class="token keyword">yield</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <p>读完上述规格，也就知道哪些字符单元是需要识别为保留字与关键词，并高亮的了。</p></li> <li><p>识别全局对象，并高亮</p> <p>继续使用 babel-highlight 实现代码块中的全局对象高亮，那么，我们需要知道哪些是规格中描述的全局变量。</p> <p>规格的 18 章介绍了全局对象，通过该章的描述，可以知道:</p> <ul><li><p>全局属性</p> <p>全局属性有: <code>globalThis</code>、<code>Infinity</code>、<code>NaN</code>、<code>undefined</code>。</p></li> <li><p>全局方法</p> <p>全局方法有: <code>eval(x)</code>、<code>isFinite</code>、<code>isNaN</code>、<code>parseFloat</code>、<code>parseInt</code>、<code>decodeURIComponent</code>、<code>encodeURIComponent</code> 等。</p></li> <li><p>全局构造函数</p> <p>全局的构造函数有: <code>Array</code>、<code>ArrayBuffer</code>、<code>BigInt</code>、<code>BigInt64Array</code>、<code>BigUnit64Array</code>、<code>Boolean</code>、<code>DataView</code>、<code>Date</code>、<code>Error</code>、<code>EvalError</code>、<code>Float32Array</code>、<code>Float64Array</code>、<code>Function</code>、<code>Int8Array</code>、<code>Int16Array</code>、<code>Int32Array</code>、<code>Map</code>、<code>Number</code>、<code>Object</code>、<code>Promise</code>、<code>Proxy</code>、<code>RangeError</code>、<code>ReferenceError</code>、<code>RegExp</code>、<code>Set</code>、<code>SharedArrayBuffer</code>、<code>String</code>、<code>Symbol</code>、<code>SyntaxError</code>、<code>TypeError</code>、<code>Uint8Array</code>、<code>Uint8ClampedArray</code>、<code>Uint16Array</code>、<code>Uint32Array</code>、<code>URIError</code>、<code>WeakMap</code>、<code>WeakSet</code>。</p></li> <li><p>其他的全局属性</p> <p><code>Atomics</code>、<code>JSON</code>、<code>Math</code>、<code>Reflect</code>。</p></li></ul> <p>很显然，当字符单元的名称是上述名称中的一员时，我们可以对其进行高亮处理了（若上下文中无重新定义的同名变量）。</p></li> <li><p>自定义 Error</p> <p>在介绍 Babel 工具集中的 babel-loader 时，babel-loader 自身维护了私有的 LoaderError 对象，该对象继承自原生 Error 类，并且订制了部分实例属性。代码如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">LoaderError</span> <span class="token keyword">extends</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> message<span class="token punctuation">,</span> codeFrame<span class="token punctuation">,</span> hideStack <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;BabelLoaderError&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>codeFrame<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>hideStack <span class="token operator">=</span> hideStack<span class="token punctuation">;</span>

        Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以看到，babel-loader 自定义了错误实例的 <code>name</code>、<code>message</code>、<code>hideStack</code> 属性，那么，问题是，原生的 <code>Error</code> 类有哪些属性和方法，哪些是开发者可以自定义的呢？</p> <p>规格的 19.5 章节，详细介绍了 <code>Error</code> 的各类规范:</p> <ul><li><code>Error</code> 作为函数被调用时（<code>Error(...)</code>），表现和 <code>new Error(...)</code> 一致，均会创建并返回 <code>Error</code> 的新实例</li> <li><code>Error</code> 可以被继承，比如通过 <code>extends</code> 的方式，子类必须提供 <code>constructor</code> 方法，且该方法内必须提供 <code>super()</code> 调用</li> <li><code>Error</code> 构造函数必须有 <code>prototype</code> 属性</li> <li><code>Error.prototype</code> 属性需有以下属性
<ul><li><code>Error.prototype.constructor</code>: 指向构造函数</li> <li><code>Error.prototype.message</code>: 描述错误信息，默认是空字符串</li> <li><code>Error.prototype.name</code>: 描述错误名称，默认值是 <code>Error</code></li> <li><code>Error.prototype.toString</code>:</li></ul></li></ul> <p>从 <code>LoaderError</code> 的源码可以看到，<code>LoaderError</code> 做了以下几件事情:</p> <ul><li><code>LoaderError</code> 继承自 <code>Error</code></li> <li>实例自定义了 <code>name</code>、<code>message</code> 属性，明确 babel-loader 的信息</li> <li>实例自定义的 <code>hideStack</code> 属性是非标准属性，用于 babel-loader 内部</li></ul></li></ul> <h3 id="_5-3-web标准"><a href="#_5-3-web标准" class="header-anchor">#</a> 5.3 web标准</h3> <p>是在解决 API Polyfil 的时候，Babel 配合使用的 core-js 除了提供 ECMAScript 标准下的 JavaScript API 实现，也提供了 DOM/URL 等实现。而 DOM/URL 所属的 web 标准，由 W3C/WHATWG 制定。</p> <table><thead><tr><th>标准化组织</th> <th>介绍</th></tr></thead> <tbody><tr><td>W3C</td> <td>W3C(World Wide Web Consortium) 致力于实现所有的用户都能够对 web 加以利用（不论其文化教育背景、能力、财力以及其身体残疾）。<br>W3C 包含了众多标准，包括 HTML/CSS/DOM/WebAssembly/WebDriver/IndexedDB 等等。</td></tr> <tr><td>WHATWG</td> <td>WHATWG(Web Hypertext Application Technology Working Group) 是浏览器厂商（包括苹果、谷歌、微软、Mozilla）于 2004 年组成的行业组织。<br>专注于浏览器领域的标准制定、测试等工作，如 HTML/DOM/streams/fetch/url/encoding 等标准的起草和发布。</td></tr></tbody></table> <p>经过多年发展，WHATWG 和 W3C 目前是合作关系，其中，WHATWG 维护 HTML 和 DOM 标准，W3C 使用 WHATWG 存储库中的 HTML 和 DOM 标准描述，W3C 在 HTML 部分的工作集中在 XHTML/XML 上。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155269291-6a41c972-b3e0-4759-8b8a-f218e7097324.jpg" alt="标准化/web标准"></p> <h2 id="_6-总结"><a href="#_6-总结" class="header-anchor">#</a> 6 总结</h2> <p>本章从整体层面介绍了 Babel 的转译过程及其生态中各个模块的作用。</p> <p>其中涉及的部分知识点，后续章节有详细解析，读者可以根据自身需要查看相应内容。</p></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><!----> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">October 10, 2022 14:26</span></div> <div class="meta-item contributors"><span class="label">Contributors: </span> <span class="info"><span title="email: antfootmail@gmail.com" class="contributor">
          hoperyy
        </span> , <span title="email: liuyuanyang@weidian.com" class="contributor">
          hoperyy
        </span> <!----></span></div></footer> <!----> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close"></button> <button class="pswp__button pswp__button--share"></button> <button class="pswp__button pswp__button--fs"></button> <button class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left"></button> <button class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/deep-in-babel/assets/js/app.1bcfb3b3.js" defer></script><script src="/deep-in-babel/assets/js/vendors~layout-Layout.df4812ba.js" defer></script><script src="/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ebefd1c7.js" defer></script><script src="/deep-in-babel/assets/js/page--aec4dcea.63bd61cc.js" defer></script><script src="/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.33005620.js" defer></script>
  </body>
</html>
