<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《深入理解 Babel》 · 刘远洋</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="manifest" href="/deep-in-babel/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="Just playing around">
    <meta property="og:url" content="/deep-in-babel/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/">
    <meta property="og:site_name" content="《深入理解 Babel》 · 刘远洋">
    <meta property="og:description" content="本章介绍 Babel 生态体系相关的各种工具，这些工具在 Babel 内部和外部均可使用，了解这些工具和其背后的原理，对理解 Babel 非常有用。 和Babel相关的工具包括： 解析工具: babel-parser; api 服务: babel-core; 命令行: babel-cli; node 增强: babel-register; 命令行: babe">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="《深入理解 Babel》 · 刘远洋">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <link rel="preload" href="/deep-in-babel/assets/css/0.styles.2e317060.css" as="style"><link rel="preload" href="/deep-in-babel/assets/js/app.ce7a4d57.js" as="script"><link rel="preload" href="/deep-in-babel/assets/js/vendors~layout-Layout.f8963aab.js" as="script"><link rel="preload" href="/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ebefd1c7.js" as="script"><link rel="preload" href="/deep-in-babel/assets/js/page--c3b426fa.9544b46f.js" as="script"><link rel="preload" href="/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.33005620.js" as="script"><link rel="prefetch" href="/deep-in-babel/assets/js/22.6353f00e.js"><link rel="prefetch" href="/deep-in-babel/assets/js/layout-Blog.b0c6dcb7.js"><link rel="prefetch" href="/deep-in-babel/assets/js/layout-Layout.54347a9b.js"><link rel="prefetch" href="/deep-in-babel/assets/js/layout-NotFound.846facba.js"><link rel="prefetch" href="/deep-in-babel/assets/js/layout-Slide.88fa1023.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--4c0dc106.30bd06b4.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--4fdeacc4.b6218b0e.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--584954b8.6ac5374d.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--5e0b8312.34d20a66.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--6723acaa.5e9a3a71.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--6ea6aa74.99eda923.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--8fcba694.e2bc50aa.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--9bf3e428.c95018ed.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--aec4dcea.614b31ca.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--d99aed8e.811085ae.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page-前言.f0a3bfce.js"><link rel="prefetch" href="/deep-in-babel/assets/js/vendors~photo-swipe.e221f9da.js">
    <link rel="stylesheet" href="/deep-in-babel/assets/css/0.styles.2e317060.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/deep-in-babel/" class="home-link router-link-active"><!----> <!----> <span class="site-name can-hide">《深入理解 Babel》 · 刘远洋</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://mogonote.com/home" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Notely
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></nav> <!----> <a rel="noopener noreferrer" href="https://github.com/hoperyy/deep-in-babel" target="_blank" class="repo-link can-hide">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="https://mogonote.com/home" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Notely
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a rel="noopener noreferrer" href="https://github.com/hoperyy/deep-in-babel" target="_blank" class="repo-link">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> <div class="content__sidebar-center"></div> <ul class="sidebar-links"><li><a href="/deep-in-babel/00.%E5%89%8D%E8%A8%80/" class="sidebar-link">第 0 章 - 前言</a></li><li><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/" class="sidebar-link">第 1 章 - 概述</a></li><li><a href="/deep-in-babel/02.%E8%BD%AC%E8%AF%91%E5%8E%9F%E7%90%86/" class="sidebar-link">第 2 章 - 转译原理</a></li><li><a href="/deep-in-babel/03.Babel%E8%8A%82%E7%82%B9/" class="sidebar-link">第 3 章 - Babel 节点</a></li><li><a href="/deep-in-babel/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/" aria-current="page" class="active sidebar-link">第 4 章 - Babel 工具集</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/deep-in-babel/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/#_4-4-1-babel-register-用法" class="sidebar-link">4.4.1 babel-register 用法</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/#_4-4-2-require-加载机制" class="sidebar-link">4.4.2 require 加载机制</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/#_4-4-3-为-require-添加钩子" class="sidebar-link">4.4.3 为 require 添加钩子</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/#_4-4-4-babel-register-内部实现" class="sidebar-link">4.4.4 babel-register 内部实现</a></li></ul></li><li><a href="/deep-in-babel/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/" class="sidebar-link">第 5 章 - Babel 插件编写</a></li><li><a href="/deep-in-babel/06.Babel%E5%86%85%E7%BD%AEplugin/" class="sidebar-link">第 6 章 - Babel 内置 Plugin</a></li><li><a href="/deep-in-babel/07.Babel%E5%86%85%E7%BD%AEpreset/" class="sidebar-link">第 7 章 - Babel 内置 Preset</a></li><li><a href="/deep-in-babel/08.runtime/" class="sidebar-link">第 8 章 - runtime</a></li><li><a href="/deep-in-babel/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" class="sidebar-link">第 9 章 - Babel 项目管理</a></li><li><a href="/deep-in-babel/10.%E8%BD%AC%E8%AF%91%E5%99%A8%E5%AF%B9%E6%AF%94/" class="sidebar-link">第 10 章 - 转译器对比</a></li></ul> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb disable"><!----></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline"></span></h1> <div class="page-info"><!----> <!----><!----><!----><!----><!----><span aria-label="Reading Time⌛" data-balloon-pos="down" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 16 min</span> <meta property="timeRequired" content="PT16M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/deep-in-babel/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/#_4-4-1-babel-register-用法" class="anchor-link heading2"><div>4.4.1 babel-register 用法</div></a></li><li class="anchor"><a href="/deep-in-babel/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/#_4-4-2-require-加载机制" class="anchor-link heading2"><div>4.4.2 require 加载机制</div></a></li><li class="anchor"><a href="/deep-in-babel/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/#_4-4-3-为-require-添加钩子" class="anchor-link heading2"><div>4.4.3 为 require 添加钩子</div></a></li><li class="anchor"><a href="/deep-in-babel/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/#_4-4-4-babel-register-内部实现" class="anchor-link heading2"><div>4.4.4 babel-register 内部实现</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><p>本章介绍 Babel 生态体系相关的各种工具，这些工具在 Babel 内部和外部均可使用，了解这些工具和其背后的原理，对理解 Babel 非常有用。</p> <p>和Babel相关的工具包括：</p> <ul><li>解析工具: babel-parser</li> <li>api 服务: babel-core</li> <li>命令行: babel-cli</li> <li>node 增强: babel-register</li> <li>命令行: babel-node</li> <li>浏览器支持: babel-standalone</li> <li>代码生成器: babel-generator</li> <li>代码高亮: babel-highlight</li> <li>模板引擎: babel-template</li> <li>webpack 支持: babel-loader（社区提供）</li></ul> <p>本章中涉及 Babel 转译部分，可以理解为下述代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> babel <span class="token keyword">from</span> <span class="token string">&quot;@babel/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> newCode <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h1 id="_4-1-commander-js"><a href="#_4-1-commander-js" class="header-anchor">#</a> 4.1 commander.js</h1> <p>Babel 对外提供了几个命令行工具，babel-cli/babel-node 均使用了 commander.js 提供命令行服务。在如今的前端领域，commander.js 是命令行开发的重要基础工具了。这里先介绍 commander.js 的使用和原理，便于后续章节的理解。</p> <ul><li><p>commander.js 版本</p> <p>本书中 babel-cli 使用的 <code>commander.js</code> 的版本是<code>^4.0.1</code>，截至写稿时，<code>commander.js</code> 的最新版本是7.0.0。</p> <p>为了理解最新的设计理念，本书只介绍 <code>commander.js</code> 7.0.0版本的使用和实现，相信了解该版本实现后，<code>^4.0.1</code> 版本的理解也就顺理成章了。</p></li> <li><p>commander.js 的使用</p> <p>commander.js 在 Github 的 Readme 介绍的比较详细，这里无意做文档翻译机，在此对 commander.js 的功能特点做一些归纳整理。</p> <p>先准备 index.js 文件以便讲解，代码中涵盖了一部分使用特点。</p> <p>后续的案例中我们使用 <code>node index *</code> 启动执行该文件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token hashbang comment">#!/usr/bin/env node</span>

<span class="token comment">// index.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Command <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Command</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 链式调用</span>
program
    <span class="token comment">/******************** 版本配置区域 **********************/</span>
    <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">'0.0.1'</span><span class="token punctuation">,</span> <span class="token string">'-v, --version'</span><span class="token punctuation">)</span> <span class="token comment">// 版本信息</span>

    <span class="token comment">/******************** 选项区域 **********************/</span>
    <span class="token comment">// boolean 类型的选项</span>
    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-d, --debug'</span><span class="token punctuation">,</span> <span class="token string">'output extra debugging'</span><span class="token punctuation">)</span>

    <span class="token comment">// 带参数类型的选项: &lt;type&gt; 必填</span>
    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-c, --cheese &lt;type&gt;'</span> <span class="token punctuation">,</span> <span class="token string">'cheese type'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span> <span class="token comment">// (选项定义, 描述, 默认值)</span>

    <span class="token comment">// 带参数类型的选项: [type] 选填;</span>
    <span class="token comment">//      type 有值时，banana 选项为字符串类型</span>
    <span class="token comment">//      type 无值时，banana 选项为 boolean 类型</span>
    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-b, --banana [type]'</span> <span class="token punctuation">,</span> <span class="token string">'banana type'</span><span class="token punctuation">)</span> <span class="token comment">// (选项定义, 描述)</span>

    <span class="token comment">// 自定义参数类型的选项</span>
    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-i, --integer &lt;number&gt;'</span><span class="token punctuation">,</span> <span class="token string">'integer argument'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">/******************** 解析命令 **********************/</span>
    <span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 打印options</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>program<span class="token punctuation">.</span><span class="token function">opts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><ul><li><p>链式调用</p> <p>commander.js 暴露的方法会返回 <code>cmd</code> 实例或子命令实例对象，以支持链式调用，该做法还是很常见的。</p></li> <li><p>版本配置</p> <p>执行 <code>node index.js -v</code> 终端会显示 <code>0.0.1</code>。</p></li> <li><p>多样的选项配置</p> <ul><li><p>boolean 类型的选项</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>program<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-d, --debug'</span><span class="token punctuation">,</span> <span class="token string">'output extra debugging'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>扩展：&quot;取反 boolean&quot;类型</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>program<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'--no-debug'</span><span class="token punctuation">,</span> <span class="token string">'not output extra debugging'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>非 boolean 类型的选项</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>program<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-c, --cheese &lt;type&gt;'</span> <span class="token punctuation">,</span> <span class="token string">'cheese type'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span> <span class="token comment">// (选项定义, 描述, 默认值)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>参数可设置默认值。</p></li> <li><p>既可是 boolean 也可非 boolean 类型的选项</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>program<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-b, --banana [type]'</span> <span class="token punctuation">,</span> <span class="token string">'banana type'</span><span class="token punctuation">)</span> <span class="token comment">// (选项定义, 描述)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>type</code> 无值时，<code>banana</code> 选项的值为 boolean 类型。</p> <p><code>type</code> 有值时，<code>banana</code> 选项的值为非 boolean 类型。</p></li> <li><p>不定数量的选项</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>program
    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-n, --number &lt;numbers...&gt;'</span><span class="token punctuation">,</span> <span class="token string">'specify numbers'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-l, --letter [letters...]'</span><span class="token punctuation">,</span> <span class="token string">'specify letters'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li></ul></li> <li><p>commander.js 原理解析</p> <ul><li><p>概览</p> <p>commander.js 7.0.0 版本的核心代码就一个文件 <code>index.js</code>，2200 多行代码，代码的注释比较丰富，代码可读性也是不错的，感兴趣的同学可以通读一下。</p> <p>commander.js 包含以下类：</p> <ul><li><code>Option</code></li> <li><code>Help</code></li> <li><code>Command</code></li> <li><code>CommandError</code></li> <li><code>InvalidOptionArgumentError</code></li></ul> <p>如下图：</p> <p><img src="https://user-images.githubusercontent.com/5757051/155270093-4ff28959-cdb2-4654-82b9-e095399dcf51.jpg" alt="Babel概览/commander-概览"></p></li> <li><p><code>Option</code> 类</p> <p><code>Option</code> 类的实例存储选项的各类信息:</p> <ul><li>选项是否必填(<code>requred</code>)</li> <li>描述信息(<code>description</code>)</li> <li>可变参数(<code>variadic</code>)</li> <li>是否反向 boolean，也就是 <code>--no-xx</code>类型的选项</li> <li>长名称/短名称，也就是 <code>-c, --cheese</code></li> <li>参数的值</li> <li>其他</li></ul> <p><img src="https://user-images.githubusercontent.com/5757051/155270176-f03855e2-e5fc-45fe-a594-f8f534622e5e.jpg" alt="Babel概览/Commander-Option 类"></p> <p>命令行实例执行 <code>program.option(&quot;-c, --cheese&quot;, &quot;add cheese&quot;)</code>，会创建一个新的 <code>Option</code> 实例，存储该选项的各类信息。</p> <p>Option类内部通过各种正则和字符串的计算各类信息。</p> <p>比如，Option类接受参数的长短名称有三种写法：</p> <ul><li><code>&quot;-c, --cheese&quot;</code></li> <li><code>&quot;-c|--cheese&quot;</code></li> <li><code>&quot;-c --cheese&quot;</code></li></ul> <p>其解析参数的时候以正则<code>/[ |,]+/</code>对字符串做分隔计算: <code>flags.split(/[ |,]+/)</code>。</p></li> <li><p><code>Help</code> 类</p> <p><code>Help</code> 类主要负责帮助信息的展示、配置等工作。</p> <p>比如执行命令行 <code>node index.js -h</code>会打印出：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Usage: index <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

Options:
    -v, --version           output the version number
    -d, --debug             output extra debugging
    -c, --cheese <span class="token operator">&lt;</span>type<span class="token operator">&gt;</span>     cheese <span class="token builtin class-name">type</span> <span class="token punctuation">(</span>default: <span class="token string">&quot;blue&quot;</span><span class="token punctuation">)</span>
    -b, --banana <span class="token punctuation">[</span>type<span class="token punctuation">]</span>     banana <span class="token builtin class-name">type</span>
    -i, --integer <span class="token operator">&lt;</span>number<span class="token operator">&gt;</span>  integer argument
    -h, --help              display <span class="token builtin class-name">help</span> <span class="token keyword">for</span> <span class="token builtin class-name">command</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>Help</code> 类中相对值得说的是 <code>formatHelp</code> 方法了。</p> <p><code>formatHelp</code> 接收当前命令行和 help 实例对象，返回格式化后的帮助信息。</p> <p>在生成帮助信息的过程中，有几个小的编程技巧可以借鉴：</p> <ul><li><p>日志信息字符串，通过数组形式组织，最终拼接为字符串</p> <p>该方法对比直接拼接字符串，代码可维护性更强。</p></li> <li><p>利用 <code>String.prototype.padEnd</code> 方法实现字符串补全</p> <p>日常工作中用到该方法的场景可能不多，容易遗漏。</p> <p>比如：<code>'hello'.padEnd(7, '~')</code> 的结果是 <code>hello~~</code>。</p> <p>在 <code>formatHelp</code> 里用空格补全，用于字符串显示的格式化。</p></li> <li><p>根据终端宽度动态计算显示宽度</p> <p>TODO</p></li></ul></li> <li><p><code>Command</code> 类</p> <p><code>Command</code> 类是 commander.js 的核心类，提供了命令行的各类方法。</p> <p>下图是 <code>Command</code> 类使用时的主要流程：</p> <p><img src="https://user-images.githubusercontent.com/5757051/155270289-cbbe70ce-982d-474e-9ea8-4f8c4f28f394.jpg" alt="Babel概览/Commander-Command类"></p> <p>我们简要介绍下其中的一些点：</p> <ul><li><p><code>version(str, flags, description)</code></p> <p>该方法注册了命令的版本信息，利用 <code>createOption()</code> 实现的一个快捷方法。</p></li> <li><p><code>command(nameAndArgs, actionOptsOrExecDesc, execOpts)</code></p> <p>该方法注册子命令，有两种模式：</p> <ul><li><p>绑定函数实现命令</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>program
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'actor'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>执行 <code>node index start</code>的时候，会执行 <code>action</code> 注册的回调，打印 <code>actor</code>。</p></li> <li><p>启动独立文件执行命令</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>program<span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">,</span> <span class="token string">'start runner'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>执行 <code>node index start</code> 的时候，会启动 <code>index-start.js</code> 文件。</p></li></ul> <p>该方法内部通过是否含有描述信息判断是哪种模式。</p></li> <li><p>重复注册命令时，会使用第一个注册的命令</p> <p>比如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>program
        <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
program
        <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在执行 <code>node index start</code> 的时候，只会打印 <code>start 1</code>，因为内部找到匹配的命令的代码是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">cmd</span> <span class="token operator">=&gt;</span> cmd<span class="token punctuation">.</span>_name <span class="token operator">===</span> name <span class="token operator">||</span> cmd<span class="token punctuation">.</span>_aliases<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>Array.prototype.find</code> 方法会返回数组第一个匹配的元素。</p></li> <li><p><code>EventEmitter</code> 在 <code>Command</code> 类中的使用</p> <p>Node 内置模块 <code>EventEmitter</code> 提供了事件机制，最常见的 API 是 <code>on/emit</code>。</p> <p><code>Command</code> 类中几处利用事件机制的地方举例：</p> <ul><li>注册选项参数时，会注册 <code>option:${optionName}</code> 事件(<code>on(option:${optionName})</code>)，在命令行执行时触发回调(<code>emit(option:${optionName})</code>)。</li> <li>执行命令时，如果没有匹配的命令，会通过 <code>this.listenerCount('command:*')</code> 获取 <code>command:xx</code> 事件(<code>*</code> 为通配符)的监听者数量，决定是否触发该事件</li></ul></li></ul></li> <li><p><code>Error</code> 类</p> <p>下图是 Commander.js 内部定义的几个 <code>Error</code> 类的继承关系。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155270428-9250a291-bd67-449b-a1fa-abcc00c51d68.png" alt="Babel概览/Commander-Error类"></p> <p>在内部实现上，分别定义了每个类自身的特殊字段。但值得注意的是，<code>Error.captureStackTrace(this, this.constructor)</code> 被频繁使用。</p> <ul><li><p><code>Error.captureStackTrace</code> 使用</p> <p><code>Error.captureStackTrace(targetObject[, constructorOpt])</code></p> <p>其作用是在 <code>targetObject</code> 中添加一个 <code>stack</code> 属性。当访问 <code>targetObject.stack</code> 时，将以字符串的形式返回 <code>Error.captureStackTrace</code> 方法被调用时的代码位置信息。举例：</p> <p>index.js</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">const</span> myObject <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> <span class="token number">2</span> Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span>myObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> <span class="token number">3</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myObject<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>执行 <code>node index.js</code> 后，终端输出：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Error
    at Object.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>xxx/index.js:2:7<span class="token punctuation">)</span>
    at Module._compile <span class="token punctuation">(</span>internal/modules/cjs/loader.js:689:30<span class="token punctuation">)</span>
    at <span class="token punctuation">..</span>.
    at <span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当传入 <code>constructorOpt</code> 时，代码如：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">function</span> <span class="token function">MyError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token operator">&gt;</span> <span class="token number">2</span>    Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> MyError<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token punctuation">}</span>
<span class="token operator">&gt;</span> <span class="token number">4</span>
<span class="token operator">&gt;</span> <span class="token number">5</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>终端输出：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Error
    at Object.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>xxx/index.js:5:13<span class="token punctuation">)</span>
    at Module._compile <span class="token punctuation">(</span>internal/modules/cjs/loader.js:689:30<span class="token punctuation">)</span>
    at <span class="token punctuation">..</span>.
    at <span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以看出，<code>MyError</code> 函数内部的堆栈细节被隐藏了。</p></li> <li><p><code>Error.captureStackTrace</code> 优点</p> <p>相对于 <code>new Error().stack</code>，<code>Error.captureStackTrace</code> 有以下优点：</p> <ul><li><p>更简洁</p> <p>无需 <code>new</code> 一个新的 <code>Error</code> 对象，节省内存空间，同时代码上也会更加优雅。</p> <p>一般而言，捕获错误信息通常的做法是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// err.stack 包含了堆栈信息，可以对其处理</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>而使用 <code>Error.captureStackTrace</code> 可以直接获取堆栈信息，实现方式更简洁。</p></li> <li><p>更安全</p> <p>如果需要忽略部分堆栈信息，使用 <code>Error.captureStackTrace</code> 会更加方便，无需手工操作。</p></li> <li><p>更少资源</p> <p>使用 <code>Error.captureStackTrace</code> 时，只有访问 <code>targetObject.stack</code> 时，才会进行堆栈信息的格式化工作。</p> <p>如果 <code>targetObj.stack</code> 未被访问，则堆栈信息的格式化工作会被省略，从而节省计算资源。</p></li></ul></li> <li><p><code>Error.captureStackTrace</code> 使用场景</p> <p><code>Error.captureStackTrace</code> 并不是 Node.js 创造的，而是 V8 引擎的 Stack Trace API。语法上，Node.js 中的 <code>Error.captureStackTrace()</code>与 V8 引擎中所暴露的接口完全一致。</p> <p>事实上，Node.js 的 <code>Error</code> 类中，所有与 stack trace 有关的内容均依赖于 V8 的 Stack Trace API。</p> <p>因此，<code>Error.captureStackTrace(targetObject[, constructorOpt])</code> 使用的场景有：</p> <ul><li><p>基于 V8 引擎的运行环境，如 Node.js、Chrome 浏览器</p></li> <li><p><code>Error.captureStackTrace(this, MyError)</code></p> <p>作用也是隐藏构造函数内部的堆栈信息，但需要明确指定构造函数名，通用性不强。</p></li> <li><p><code>Error.captureStackTrace(this, arguments.callee)</code></p> <p><code>arguments.callee</code> 表示当前函数，也有通用性。但 ES3 及之后的严格模式禁用了 <code>arguments.callee</code>，因此不建议使用。</p></li> <li><p><code>Error.captureStackTrace(this, this.constructor)</code></p> <p>该做法可以隐藏构造函数内部的堆栈信息，无需指定构造函数名，通用型强。</p></li></ul></li></ul></li></ul></li></ul> <h1 id="_4-2-api-服务-babel-core"><a href="#_4-2-api-服务-babel-core" class="header-anchor">#</a> 4.2 api 服务: babel-core</h1> <p>TODO</p> <h1 id="_4-3-命令行-babel-cli"><a href="#_4-3-命令行-babel-cli" class="header-anchor">#</a> 4.3 命令行: babel-cli</h1> <p>babel-cli 本身的用法本书不再赘述，官方文档讲解的非常详细。</p> <p>babel-cli 是基于 commander.js 的命令行，了解 commander.js 的使用之后，babel-cli 的原理也比较容易理解了。</p> <p>babel-cli 的运行过程并不复杂，运行流程图如下：</p> <p><img src="https://user-images.githubusercontent.com/5757051/155269518-722cd7af-fdbd-4adf-a61e-f9ef64e06da7.jpg" alt="Babel工具集/babel-cli"></p> <p>以下是其源码中的部分细节：</p> <ul><li><p>参数定义</p> <p>babel-cli 的参数定义基于 commander.js。</p> <p>例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> commander <span class="token keyword">from</span> <span class="token string">&quot;commander&quot;</span><span class="token punctuation">;</span>

commander<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span>
    <span class="token string">&quot;-f, --filename [filename]&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;The filename to use when reading from stdin. This will be used in source-maps, errors etc.&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>globs 语法</p> <p>babel-cli 支持通配符匹配源文件，例如：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>babel *.js --output-file dist.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>*.js</code> 会匹配当前目录所有以 <code>.js</code> 为后缀的文件。</p> <p>babel 使用 npm 包 <code>glob</code> 提供对通配符的支持。</p> <p>TODO：globs 语法</p></li> <li><p>参数错误信息提示</p> <p>解析参数的过程中，对于输入错误的情况，babel-cli 在解析过程中用数组统一收集错误信息，最后统一输出给使用者。</p> <p>这个技巧值得借鉴。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 错误收集</span>
<span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>commander<span class="token punctuation">.</span>outFile <span class="token operator">&amp;&amp;</span> commander<span class="token punctuation">.</span>outDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;--out-file and --out-dir cannot be used together&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 错误展示</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;babel:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;  &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li> <li><p>不向前兼容的提示</p> <p>babel-cli 历史版本可能是支持用户这样使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;babel-cli&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>但后续的升级移除了对该功能的支持，为了提示使用者，babel-cli 保留了旧的 <code>index.js</code>，内容比较直接：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Use the `@babel/core` package instead of `@babel/cli`.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在做工具的破坏性升级时，这也是可以借鉴的提示技巧。</p></li></ul> <h1 id="_4-4-node-增强-babel-register"><a href="#_4-4-node-增强-babel-register" class="header-anchor">#</a> 4.4 node 增强：babel-register</h1> <h2 id="_4-4-1-babel-register-用法"><a href="#_4-4-1-babel-register-用法" class="header-anchor">#</a> 4.4.1 babel-register 用法</h2> <p>babel-register 模块会改写 node 的 <code>require</code> 方法，为其加上一个钩子，当 <code>require</code> 加载 <code>.js</code>、<code>.jsx</code>、<code>.es6</code>、<code>.es</code>、<code>.mjs</code> 后缀的时候，会先用 Babel 转码。</p> <blockquote><p>后缀可配置<br> <code>.js</code>、<code>.jsx</code>、<code>.es6</code>、<code>.es</code>、<code>.mjs</code>为默认配置</p></blockquote> <p>举例：</p> <p>index.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babel-register'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./run'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>run.js</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>执行 <code>node index</code> 时，run.js 就不需要被转码了。</p> <p>有两点需要注意：</p> <ul><li>babel-register 不会对所在的当前文件转码，也就是 <code>index.js</code> 不会被转码</li> <li>babel-register 是实时转码，会影响运行性能，只适合在开发环境使用</li></ul> <h2 id="_4-4-2-require-加载机制"><a href="#_4-4-2-require-加载机制" class="header-anchor">#</a> 4.4.2 require 加载机制</h2> <p>理解 node 中 <code>require</code> 的加载机制，有助于理解 babel-register 是如何为 require 添加钩子的。</p> <p>require 的源码定义在 node 源码 <code>lib/module.js</code> 的 <code>Module.prototype.require</code> 方法。</p> <p><code>Module</code> 是构造函数，其简要定义如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 每个Module实例都有require方法</span>
<span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Module<span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token comment">// 当前模块 module.js 也是 Module 的实例</span>
<span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>（TODO：附录链接 https://github.com/nodejs/node-v0.x-archive/blob/master/lib/module.js）</p> <p>下图是 require 过程执行的其中一条链路：</p> <p><img src="https://user-images.githubusercontent.com/5757051/155269602-ec603340-e642-46e5-afc4-f5d7fdbc8a0a.jpg" alt="Babel工具集/require加载机制"></p> <p>从上图，我们看到 require 加载链路中有以下特点：</p> <ul><li>在 node 代码里常见的 <code>exports</code>、<code>require</code>、<code>module</code>、<code>__dirname</code>、<code>__filename</code> 均是被注入的局部变量</li> <li>目标模块解析过程中会生成新的 <code>Module</code> 实例，用于记录目标模块的各类信息</li> <li><code>require</code> 执行过程中涉及很多内部方法，这为 <code>require</code> 添加钩子提供了可能</li> <li>一些情况下，目标模块的代码是通过 node 虚拟机 <code>require('vm').runInThisContext</code>、<code>require('vm').runInNewContext</code> 执行的</li></ul> <h2 id="_4-4-3-为-require-添加钩子"><a href="#_4-4-3-为-require-添加钩子" class="header-anchor">#</a> 4.4.3 为 <code>require</code> 添加钩子</h2> <ul><li><p>基本原理</p> <p>我们已经了解了 <code>require</code> 的加载机制，那么，假如文件 run.js 的内容如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hi, this is run.js.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>另有文件 index.js的内容如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./run.js'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当执行 <code>node index.js</code> 时，终端会打印：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Hi, this is run.js.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后，我们尝试下拦截 <code>require</code>，在执行 <code>node index.js</code> 时，终端打印：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Knock knock, I'm here<span class="token operator">!</span>
Hi, this is run.js.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>结合前面讲解的 <code>require</code> 加载机制，我们可以从以下点入手：</p> <ul><li><p>重写 <code>Module._extensions['.js']</code>，拦截所有 <code>.js</code> 文件的 <code>require</code> 行为</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Module <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'module'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> oldLoader <span class="token operator">=</span> Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO</span>
    <span class="token function">oldLoader</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./run.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p>在新的处理函数中，重写 <code>module</code> 实例的 <code>_compile</code> 方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Module <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'module'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> oldLoader <span class="token operator">=</span> Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldCompile <span class="token operator">=</span> module<span class="token punctuation">.</span>_compile<span class="token punctuation">;</span>

    <span class="token comment">// 重写 module._compile</span>
    module<span class="token punctuation">.</span><span class="token function-variable function">_compile</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                console.log(&quot;Knock knock, I'm here!&quot;);
                </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
            </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">oldCompile</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>newCode<span class="token punctuation">,</span> filename<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">oldLoader</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./run.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></li></ul> <p>这样，重新执行 <code>node index.js</code>，终端打印出：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Knock knock, I'm here<span class="token operator">!</span>
index.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>pirates</p> <p>很显然上面的代码并不优雅，真实的需求中我们可能无需拦截所有的 <code>.js</code> 文件，可能也需要拦截其他后缀的文件，各种操作还是比较繁琐的。</p> <p>babel-register 使用 npm 包 <code>pirates</code> 提供的 <code>addHook</code> 方法拦截 <code>require</code>，拦截时利用 Babel 对源码转译。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 拦截 require 注册 compileHook 方法</span>
<span class="token comment">// compileHook 会利用Babel转译模块源码，返回转译后的代码</span>
<span class="token function">addHook</span><span class="token punctuation">(</span>compileHook<span class="token punctuation">,</span> <span class="token punctuation">{</span> exts<span class="token punctuation">,</span> <span class="token literal-property property">ignoreNodeModules</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>addHook</code> 的核心原理同上，但处理了更多细节：</p> <ul><li><p>增强安全性</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> BuiltinModule <span class="token keyword">from</span> <span class="token string">'module'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Module <span class="token operator">=</span> module<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> module<span class="token punctuation">.</span>constructor <span class="token operator">:</span> BuiltinModule<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>Module</code> 对象的获取优先选取 <code>module.constructor</code>，其次选取内置的 <code>&quot;module&quot;</code> 模块，以适配 mock 出的 <code>module</code> 实例。</p></li> <li><p>能够恢复被拦截方法到原始状态</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">revert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reverted<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    reverted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    exts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ext</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// if the current loader for the extension is our loader then unregister it and set the oldLoader again</span>
    <span class="token comment">// if not we can not do anything as we cannot remove a loader from within the loader-chain</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span>ext<span class="token punctuation">]</span> <span class="token operator">===</span> loaders<span class="token punctuation">[</span>ext<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span>ext<span class="token punctuation">]</span> <span class="token operator">=</span> oldLoaders<span class="token punctuation">[</span>ext<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p>根据配置项确定是否处理目标模块源码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">shouldCompile</span><span class="token punctuation">(</span><span class="token parameter">filename<span class="token punctuation">,</span> exts<span class="token punctuation">,</span> matcher<span class="token punctuation">,</span> ignoreNodeModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> filename <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exts<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> resolvedFilename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ignoreNodeModules <span class="token operator">&amp;&amp;</span> nodeModulesRegex<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>resolvedFilename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> matcher <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token function">matcher</span><span class="token punctuation">(</span>resolvedFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></li></ul></li></ul> <h2 id="_4-4-4-babel-register-内部实现"><a href="#_4-4-4-babel-register-内部实现" class="header-anchor">#</a> 4.4.4 babel-register 内部实现</h2> <ul><li><p>主要流程</p> <p>在理解了 <code>require</code> 的加载机制、如何为 <code>require</code> 添加钩子后，继续阅读 babel-register 源码会得心应手很多。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155269714-56adbacc-1c4d-46eb-954f-16028ba60c78.jpg" alt="Babel工具集/babel-register"></p> <p>babel-register 依赖 pirates.js 提供的 <code>addHook</code> 方法，实现拦截 <code>require</code>，同时在拦截函数里执行 Babel 的转译逻辑。</p></li> <li><p>缓存处理</p> <p>TODO</p></li></ul> <h1 id="_4-5-命令行-babel-node"><a href="#_4-5-命令行-babel-node" class="header-anchor">#</a> 4.5 命令行：babel-node</h1> <p>babel-node 也是基于 commander.js 的命令行服务。下图是 babel-node 的运行过程：</p> <p><img src="https://user-images.githubusercontent.com/5757051/155269786-a1927641-ed07-4fa6-829c-9e19c290ca5d.jpg" alt="Babel工具集/babel-node"></p> <p>由上图可以看出，babel-node 的运行过程比较直观。解析其源码，也有一些值得注意的细节：</p> <ul><li><p>v8flags</p> <p>TODO</p></li> <li><p>kexec 与 spawn</p> <p>TODO</p></li> <li><p>处理 exit 事件</p> <p>TODO</p></li> <li><p>repl</p> <p>TODO</p></li> <li><p><code>vm.runInThisContext</code></p> <p>TODO</p></li> <li><p>Module</p> <p>TODO</p></li> <li><p>node 参数处理</p> <p>TODO</p></li></ul> <h1 id="_4-6-浏览器支持-babel-standalone"><a href="#_4-6-浏览器支持-babel-standalone" class="header-anchor">#</a> 4.6 浏览器支持：babel-standalone</h1> <p>babel-standalone 提供浏览器环境实时转译 JavaScript 的能力。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155269870-fbea5b53-1c46-46bc-8d6a-e2822cc3385c.jpg" alt="Babel工具集/babel-standalone"></p> <h1 id="_4-7-babel-highlight"><a href="#_4-7-babel-highlight" class="header-anchor">#</a> 4.7 babel-highlight</h1> <p>babel-highlight 可以将一段代码字符串在终端高亮展示。</p> <p>代码中已经可以看到 Babel8 的处理方式了。无论是 Babel7 还是 Babel8 的处理方式，总体思路都是：将代码块解析为不同类型的 token 单元，并对不同类型显示不同的颜色。</p> <ul><li><p>token 化处理</p> <p>babel-highlight 依赖 js-tokens 对代码块解析为不同类型的 token 单元。</p> <p>TODO</p></li> <li><p>高亮工具：chalk</p> <p>babel-highlight 使用 chalk 实现代码块在终端的高亮。</p> <p>TODO</p></li> <li><p>高亮规则</p> <p>babel-highlight 会用不同颜色对以下目标类型进行高亮处理：</p> <ul><li><code>keyword</code>: 关键词</li> <li><code>capitalized</code>: 大写</li> <li><code>jsxIdentifier</code>: JSX标识符</li> <li><code>punctuator</code>: 标点</li> <li><code>number</code>: 数字</li> <li><code>string</code>: 字符串</li> <li><code>regex</code>: 正则</li> <li><code>comment</code>: 注释</li> <li><code>invalid</code>: 非正常写法</li> <li><code>uncolored</code></li></ul></li></ul> <h1 id="_4-8-babel-template"><a href="#_4-8-babel-template" class="header-anchor">#</a> 4.8 babel-template</h1> <p>TODO</p> <h1 id="_4-9-webpack-支持-babel-loader"><a href="#_4-9-webpack-支持-babel-loader" class="header-anchor">#</a> 4.9 webpack 支持：babel-loader</h1> <p>babel-loader 非 Babel 官方出品，也是 webpack 生态中的重要基础工具，其承担了对 webpack 打包过程中相关文件的转译工作。</p> <p>下图是 babel-loader 的大致运行过程：</p> <p><img src="https://user-images.githubusercontent.com/5757051/155269949-ad23f672-418a-4cf4-b315-60bfcdada50f.jpg" alt="Babel工具集/babel-loader-总览"></p> <ul><li><p>转译模块</p> <p>babel-loader 直接使用 babel-core 的 <code>transform</code> 方法执行源码的转译。而 <code>transform</code> 的转译结果对象包含众多属性，babel-loader 选取了部分属性作为新的结果对象。</p> <p>根据 Github issue 中的描述，babel-loader 开发者注意到，transform 返回的原始结果对象中，含有难以序列化的属性值（如 <code>options</code>），而 Babel 本身也会提供本地化的缓存结果，对于难以序列化的 <code>options</code> 等属性，缓存时会丢失一些信息，因此，babel-loader 只会返回可以序列化的部分属性组成的新结果对象。</p></li> <li><p>缓存模块</p> <p>babel-loader 将转移过的结果缓存到本地文件系统。</p> <p>缓存路径优先使用开发者设置的 <code>cacheDirectory</code> 路径，否则使用 <code>babel-loader</code> 提供的默认缓存路径。</p> <p>经过 babel-core 的 <code>transform</code> API 处理的转译结果 result 对象，会直接被 <code>JSON.stringify(result)</code> 转为字符串，并写入本地缓存。如果开发者指定需要对缓存文件压缩，则会压缩为 <code>.gz</code> 文件，否则会明文写入缓存文件。</p> <p>下图描述了缓存处理过程：</p> <p><img src="https://user-images.githubusercontent.com/5757051/155270020-30770461-e00e-46db-b5b2-829898ad4c9e.jpg" alt="Babel工具集/babel-loader-cache"></p></li> <li><p>错误处理模块</p> <p>对于转译过程发生的错误，babel-loader 并没有直接使用 Node 的原生错误表现，而是基于原生 <code>Error</code> 类，封装了定制化的 <code>LoaderError</code> 类。 <code>LoaderError</code> 类对错误信息执行格式化，主要规范了以下属性：</p> <ul><li><p><code>name</code></p> <p>报错名称统一为&quot;<code>BabelLoaderError</code>&quot;。</p></li> <li><p><code>message</code></p> <p>去掉 message 信息中的冗余信息。</p></li> <li><p><code>hideStack</code></p> <p>隐藏堆栈信息。</p></li> <li><p>使用 <code>Error.captureStackTrace</code> 隐藏非必要信息</p> <p>TODO</p></li></ul></li></ul></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><div class="edit-link"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon edit-icon"><path d="M117.953 696.992 64.306 959.696l265.931-49.336 450.204-452.505-212.284-213.376-450.204 452.513zm496.384-296.326L219.039 797.993l-46.108-46.34L568.233 354.33l46.104 46.335zm345.357-122.99-114.45 115.04-212.288-213.377 114.45-115.035 212.288 213.371zm0 0" fill="currentColor"></path></svg> <a href="https://github.com/hoperyy/deep-in-babel/edit/main/04.Babel工具集/index.md" target="_blank" rel="noopener noreferrer">Edit this page</a></div> <!----> <!----></footer> <!----> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close"></button> <button class="pswp__button pswp__button--share"></button> <button class="pswp__button pswp__button--fs"></button> <button class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left"></button> <button class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/deep-in-babel/assets/js/app.ce7a4d57.js" defer></script><script src="/deep-in-babel/assets/js/vendors~layout-Layout.f8963aab.js" defer></script><script src="/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ebefd1c7.js" defer></script><script src="/deep-in-babel/assets/js/page--c3b426fa.9544b46f.js" defer></script><script src="/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.33005620.js" defer></script>
  </body>
</html>
