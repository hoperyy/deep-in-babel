(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{486:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("本章介绍 Babel 生态体系相关的各种工具，这些工具在 Babel 内部和外部均可使用，了解这些工具和其背后的原理，对理解 Babel 非常有用。")]),s._v(" "),a("p",[s._v("和Babel相关的工具包括：")]),s._v(" "),a("ul",[a("li",[s._v("解析工具: babel-parser")]),s._v(" "),a("li",[s._v("api 服务: babel-core")]),s._v(" "),a("li",[s._v("命令行: babel-cli")]),s._v(" "),a("li",[s._v("node 增强: babel-register")]),s._v(" "),a("li",[s._v("命令行: babel-node")]),s._v(" "),a("li",[s._v("浏览器支持: babel-standalone")]),s._v(" "),a("li",[s._v("代码生成器: babel-generator")]),s._v(" "),a("li",[s._v("代码高亮: babel-highlight")]),s._v(" "),a("li",[s._v("模板引擎: babel-template")]),s._v(" "),a("li",[s._v("webpack 支持: babel-loader（社区提供）")])]),s._v(" "),a("p",[s._v("本章中涉及 Babel 转译部分，可以理解为下述代码：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" babel "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@babel/core"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" newCode "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" babel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("transform")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h1",{attrs:{id:"_4-1-commander-js"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-commander-js"}},[s._v("#")]),s._v(" 4.1 commander.js")]),s._v(" "),a("p",[s._v("Babel 对外提供了几个命令行工具，babel-cli/babel-node 均使用了 commander.js 提供命令行服务。在如今的前端领域，commander.js 是命令行开发的重要基础工具了。这里先介绍 commander.js 的使用和原理，便于后续章节的理解。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("commander.js 版本")]),s._v(" "),a("p",[s._v("本书中 babel-cli 使用的 "),a("code",[s._v("commander.js")]),s._v(" 的版本是"),a("code",[s._v("^4.0.1")]),s._v("，截至写稿时，"),a("code",[s._v("commander.js")]),s._v(" 的最新版本是7.0.0。")]),s._v(" "),a("p",[s._v("为了理解最新的设计理念，本书只介绍 "),a("code",[s._v("commander.js")]),s._v(" 7.0.0版本的使用和实现，相信了解该版本实现后，"),a("code",[s._v("^4.0.1")]),s._v(" 版本的理解也就顺理成章了。")])]),s._v(" "),a("li",[a("p",[s._v("commander.js 的使用")]),s._v(" "),a("p",[s._v("commander.js 在 Github 的 Readme 介绍的比较详细，这里无意做文档翻译机，在此对 commander.js 的功能特点做一些归纳整理。")]),s._v(" "),a("p",[s._v("先准备 index.js 文件以便讲解，代码中涵盖了一部分使用特点。")]),s._v(" "),a("p",[s._v("后续的案例中我们使用 "),a("code",[s._v("node index *")]),s._v(" 启动执行该文件。")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token hashbang comment"}},[s._v("#!/usr/bin/env node")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// index.js")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" Command "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'commander'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" program "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 链式调用")]),s._v("\nprogram\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/******************** 版本配置区域 **********************/")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0.0.1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-v, --version'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 版本信息")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/******************** 选项区域 **********************/")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// boolean 类型的选项")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("option")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-d, --debug'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'output extra debugging'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 带参数类型的选项: <type> 必填")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("option")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c, --cheese <type>'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'cheese type'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'blue'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// (选项定义, 描述, 默认值)")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 带参数类型的选项: [type] 选填;")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//      type 有值时，banana 选项为字符串类型")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//      type 无值时，banana 选项为 boolean 类型")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("option")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-b, --banana [type]'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'banana type'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// (选项定义, 描述)")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 自定义参数类型的选项")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("option")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-i, --integer <number>'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'integer argument'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("number")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("parseInt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("number"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/******************** 解析命令 **********************/")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("parse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 打印options")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("program"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("opts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br")])]),a("ul",[a("li",[a("p",[s._v("链式调用")]),s._v(" "),a("p",[s._v("commander.js 暴露的方法会返回 "),a("code",[s._v("cmd")]),s._v(" 实例或子命令实例对象，以支持链式调用，该做法还是很常见的。")])]),s._v(" "),a("li",[a("p",[s._v("版本配置")]),s._v(" "),a("p",[s._v("执行 "),a("code",[s._v("node index.js -v")]),s._v(" 终端会显示 "),a("code",[s._v("0.0.1")]),s._v("。")])]),s._v(" "),a("li",[a("p",[s._v("多样的选项配置")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("boolean 类型的选项")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("program"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("option")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-d, --debug'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'output extra debugging'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v('扩展："取反 boolean"类型')]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("program"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("option")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'--no-debug'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'not output extra debugging'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("非 boolean 类型的选项")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("program"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("option")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c, --cheese <type>'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'cheese type'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'blue'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// (选项定义, 描述, 默认值)")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("参数可设置默认值。")])]),s._v(" "),a("li",[a("p",[s._v("既可是 boolean 也可非 boolean 类型的选项")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("program"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("option")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-b, --banana [type]'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'banana type'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// (选项定义, 描述)")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("type")]),s._v(" 无值时，"),a("code",[s._v("banana")]),s._v(" 选项的值为 boolean 类型。")]),s._v(" "),a("p",[a("code",[s._v("type")]),s._v(" 有值时，"),a("code",[s._v("banana")]),s._v(" 选项的值为非 boolean 类型。")])]),s._v(" "),a("li",[a("p",[s._v("不定数量的选项")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("program\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("option")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-n, --number <numbers...>'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'specify numbers'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("option")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-l, --letter [letters...]'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'specify letters'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])])])])])])]),s._v(" "),a("li",[a("p",[s._v("commander.js 原理解析")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("概览")]),s._v(" "),a("p",[s._v("commander.js 7.0.0 版本的核心代码就一个文件 "),a("code",[s._v("index.js")]),s._v("，2200 多行代码，代码的注释比较丰富，代码可读性也是不错的，感兴趣的同学可以通读一下。")]),s._v(" "),a("p",[s._v("commander.js 包含以下类：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("Option")])]),s._v(" "),a("li",[a("code",[s._v("Help")])]),s._v(" "),a("li",[a("code",[s._v("Command")])]),s._v(" "),a("li",[a("code",[s._v("CommandError")])]),s._v(" "),a("li",[a("code",[s._v("InvalidOptionArgumentError")])])]),s._v(" "),a("p",[s._v("如下图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/5757051/155270093-4ff28959-cdb2-4654-82b9-e095399dcf51.jpg",alt:"Babel概览/commander-概览"}})])]),s._v(" "),a("li",[a("p",[a("code",[s._v("Option")]),s._v(" 类")]),s._v(" "),a("p",[a("code",[s._v("Option")]),s._v(" 类的实例存储选项的各类信息:")]),s._v(" "),a("ul",[a("li",[s._v("选项是否必填("),a("code",[s._v("requred")]),s._v(")")]),s._v(" "),a("li",[s._v("描述信息("),a("code",[s._v("description")]),s._v(")")]),s._v(" "),a("li",[s._v("可变参数("),a("code",[s._v("variadic")]),s._v(")")]),s._v(" "),a("li",[s._v("是否反向 boolean，也就是 "),a("code",[s._v("--no-xx")]),s._v("类型的选项")]),s._v(" "),a("li",[s._v("长名称/短名称，也就是 "),a("code",[s._v("-c, --cheese")])]),s._v(" "),a("li",[s._v("参数的值")]),s._v(" "),a("li",[s._v("其他")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/5757051/155270176-f03855e2-e5fc-45fe-a594-f8f534622e5e.jpg",alt:"Babel概览/Commander-Option 类"}})]),s._v(" "),a("p",[s._v("命令行实例执行 "),a("code",[s._v('program.option("-c, --cheese", "add cheese")')]),s._v("，会创建一个新的 "),a("code",[s._v("Option")]),s._v(" 实例，存储该选项的各类信息。")]),s._v(" "),a("p",[s._v("Option类内部通过各种正则和字符串的计算各类信息。")]),s._v(" "),a("p",[s._v("比如，Option类接受参数的长短名称有三种写法：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v('"-c, --cheese"')])]),s._v(" "),a("li",[a("code",[s._v('"-c|--cheese"')])]),s._v(" "),a("li",[a("code",[s._v('"-c --cheese"')])])]),s._v(" "),a("p",[s._v("其解析参数的时候以正则"),a("code",[s._v("/[ |,]+/")]),s._v("对字符串做分隔计算: "),a("code",[s._v("flags.split(/[ |,]+/)")]),s._v("。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("Help")]),s._v(" 类")]),s._v(" "),a("p",[a("code",[s._v("Help")]),s._v(" 类主要负责帮助信息的展示、配置等工作。")]),s._v(" "),a("p",[s._v("比如执行命令行 "),a("code",[s._v("node index.js -h")]),s._v("会打印出：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Usage: index "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nOptions:\n    -v, --version           output the version number\n    -d, --debug             output extra debugging\n    -c, --cheese "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("type"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("     cheese "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"blue"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    -b, --banana "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("     banana "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v("\n    -i, --integer "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("number"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  integer argument\n    -h, --help              display "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("help")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[a("code",[s._v("Help")]),s._v(" 类中相对值得说的是 "),a("code",[s._v("formatHelp")]),s._v(" 方法了。")]),s._v(" "),a("p",[a("code",[s._v("formatHelp")]),s._v(" 接收当前命令行和 help 实例对象，返回格式化后的帮助信息。")]),s._v(" "),a("p",[s._v("在生成帮助信息的过程中，有几个小的编程技巧可以借鉴：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("日志信息字符串，通过数组形式组织，最终拼接为字符串")]),s._v(" "),a("p",[s._v("该方法对比直接拼接字符串，代码可维护性更强。")])]),s._v(" "),a("li",[a("p",[s._v("利用 "),a("code",[s._v("String.prototype.padEnd")]),s._v(" 方法实现字符串补全")]),s._v(" "),a("p",[s._v("日常工作中用到该方法的场景可能不多，容易遗漏。")]),s._v(" "),a("p",[s._v("比如："),a("code",[s._v("'hello'.padEnd(7, '~')")]),s._v(" 的结果是 "),a("code",[s._v("hello~~")]),s._v("。")]),s._v(" "),a("p",[s._v("在 "),a("code",[s._v("formatHelp")]),s._v(" 里用空格补全，用于字符串显示的格式化。")])]),s._v(" "),a("li",[a("p",[s._v("根据终端宽度动态计算显示宽度")]),s._v(" "),a("p",[s._v("TODO")])])])]),s._v(" "),a("li",[a("p",[a("code",[s._v("Command")]),s._v(" 类")]),s._v(" "),a("p",[a("code",[s._v("Command")]),s._v(" 类是 commander.js 的核心类，提供了命令行的各类方法。")]),s._v(" "),a("p",[s._v("下图是 "),a("code",[s._v("Command")]),s._v(" 类使用时的主要流程：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/5757051/155270289-cbbe70ce-982d-474e-9ea8-4f8c4f28f394.jpg",alt:"Babel概览/Commander-Command类"}})]),s._v(" "),a("p",[s._v("我们简要介绍下其中的一些点：")]),s._v(" "),a("ul",[a("li",[a("p",[a("code",[s._v("version(str, flags, description)")])]),s._v(" "),a("p",[s._v("该方法注册了命令的版本信息，利用 "),a("code",[s._v("createOption()")]),s._v(" 实现的一个快捷方法。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("command(nameAndArgs, actionOptsOrExecDesc, execOpts)")])]),s._v(" "),a("p",[s._v("该方法注册子命令，有两种模式：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("绑定函数实现命令")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("program\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'start'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'actor'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("执行 "),a("code",[s._v("node index start")]),s._v("的时候，会执行 "),a("code",[s._v("action")]),s._v(" 注册的回调，打印 "),a("code",[s._v("actor")]),s._v("。")])]),s._v(" "),a("li",[a("p",[s._v("启动独立文件执行命令")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("program"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'start'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'start runner'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("执行 "),a("code",[s._v("node index start")]),s._v(" 的时候，会启动 "),a("code",[s._v("index-start.js")]),s._v(" 文件。")])])]),s._v(" "),a("p",[s._v("该方法内部通过是否含有描述信息判断是哪种模式。")])]),s._v(" "),a("li",[a("p",[s._v("重复注册命令时，会使用第一个注册的命令")]),s._v(" "),a("p",[s._v("比如：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("program\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'start'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'start 1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nprogram\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'start'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("action")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'start 2'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("在执行 "),a("code",[s._v("node index start")]),s._v(" 的时候，只会打印 "),a("code",[s._v("start 1")]),s._v("，因为内部找到匹配的命令的代码是：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("commands"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("cmd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" cmd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" cmd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_aliases"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("includes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("Array.prototype.find")]),s._v(" 方法会返回数组第一个匹配的元素。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("EventEmitter")]),s._v(" 在 "),a("code",[s._v("Command")]),s._v(" 类中的使用")]),s._v(" "),a("p",[s._v("Node 内置模块 "),a("code",[s._v("EventEmitter")]),s._v(" 提供了事件机制，最常见的 API 是 "),a("code",[s._v("on/emit")]),s._v("。")]),s._v(" "),a("p",[a("code",[s._v("Command")]),s._v(" 类中几处利用事件机制的地方举例：")]),s._v(" "),a("ul",[a("li",[s._v("注册选项参数时，会注册 "),a("code",[s._v("option:${optionName}")]),s._v(" 事件("),a("code",[s._v("on(option:${optionName})")]),s._v(")，在命令行执行时触发回调("),a("code",[s._v("emit(option:${optionName})")]),s._v(")。")]),s._v(" "),a("li",[s._v("执行命令时，如果没有匹配的命令，会通过 "),a("code",[s._v("this.listenerCount('command:*')")]),s._v(" 获取 "),a("code",[s._v("command:xx")]),s._v(" 事件("),a("code",[s._v("*")]),s._v(" 为通配符)的监听者数量，决定是否触发该事件")])])])])]),s._v(" "),a("li",[a("p",[a("code",[s._v("Error")]),s._v(" 类")]),s._v(" "),a("p",[s._v("下图是 Commander.js 内部定义的几个 "),a("code",[s._v("Error")]),s._v(" 类的继承关系。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/5757051/155270428-9250a291-bd67-449b-a1fa-abcc00c51d68.png",alt:"Babel概览/Commander-Error类"}})]),s._v(" "),a("p",[s._v("在内部实现上，分别定义了每个类自身的特殊字段。但值得注意的是，"),a("code",[s._v("Error.captureStackTrace(this, this.constructor)")]),s._v(" 被频繁使用。")]),s._v(" "),a("ul",[a("li",[a("p",[a("code",[s._v("Error.captureStackTrace")]),s._v(" 使用")]),s._v(" "),a("p",[a("code",[s._v("Error.captureStackTrace(targetObject[, constructorOpt])")])]),s._v(" "),a("p",[s._v("其作用是在 "),a("code",[s._v("targetObject")]),s._v(" 中添加一个 "),a("code",[s._v("stack")]),s._v(" 属性。当访问 "),a("code",[s._v("targetObject.stack")]),s._v(" 时，将以字符串的形式返回 "),a("code",[s._v("Error.captureStackTrace")]),s._v(" 方法被调用时的代码位置信息。举例：")]),s._v(" "),a("p",[s._v("index.js")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" myObject "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" Error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("captureStackTrace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("myObject"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("myObject"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("执行 "),a("code",[s._v("node index.js")]),s._v(" 后，终端输出：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Error\n    at Object."),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("anonymous"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("xxx/index.js:2:7"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    at Module._compile "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("internal/modules/cjs/loader.js:689:30"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    at "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n    at "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("当传入 "),a("code",[s._v("constructorOpt")]),s._v(" 时，代码如：")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("MyError")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("    Error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("captureStackTrace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" MyError"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MyError")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("终端输出：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Error\n    at Object."),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("anonymous"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("xxx/index.js:5:13"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    at Module._compile "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("internal/modules/cjs/loader.js:689:30"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    at "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n    at "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("可以看出，"),a("code",[s._v("MyError")]),s._v(" 函数内部的堆栈细节被隐藏了。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("Error.captureStackTrace")]),s._v(" 优点")]),s._v(" "),a("p",[s._v("相对于 "),a("code",[s._v("new Error().stack")]),s._v("，"),a("code",[s._v("Error.captureStackTrace")]),s._v(" 有以下优点：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("更简洁")]),s._v(" "),a("p",[s._v("无需 "),a("code",[s._v("new")]),s._v(" 一个新的 "),a("code",[s._v("Error")]),s._v(" 对象，节省内存空间，同时代码上也会更加优雅。")]),s._v(" "),a("p",[s._v("一般而言，捕获错误信息通常的做法是：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// err.stack 包含了堆栈信息，可以对其处理")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("而使用 "),a("code",[s._v("Error.captureStackTrace")]),s._v(" 可以直接获取堆栈信息，实现方式更简洁。")])]),s._v(" "),a("li",[a("p",[s._v("更安全")]),s._v(" "),a("p",[s._v("如果需要忽略部分堆栈信息，使用 "),a("code",[s._v("Error.captureStackTrace")]),s._v(" 会更加方便，无需手工操作。")])]),s._v(" "),a("li",[a("p",[s._v("更少资源")]),s._v(" "),a("p",[s._v("使用 "),a("code",[s._v("Error.captureStackTrace")]),s._v(" 时，只有访问 "),a("code",[s._v("targetObject.stack")]),s._v(" 时，才会进行堆栈信息的格式化工作。")]),s._v(" "),a("p",[s._v("如果 "),a("code",[s._v("targetObj.stack")]),s._v(" 未被访问，则堆栈信息的格式化工作会被省略，从而节省计算资源。")])])])]),s._v(" "),a("li",[a("p",[a("code",[s._v("Error.captureStackTrace")]),s._v(" 使用场景")]),s._v(" "),a("p",[a("code",[s._v("Error.captureStackTrace")]),s._v(" 并不是 Node.js 创造的，而是 V8 引擎的 Stack Trace API。语法上，Node.js 中的 "),a("code",[s._v("Error.captureStackTrace()")]),s._v("与 V8 引擎中所暴露的接口完全一致。")]),s._v(" "),a("p",[s._v("事实上，Node.js 的 "),a("code",[s._v("Error")]),s._v(" 类中，所有与 stack trace 有关的内容均依赖于 V8 的 Stack Trace API。")]),s._v(" "),a("p",[s._v("因此，"),a("code",[s._v("Error.captureStackTrace(targetObject[, constructorOpt])")]),s._v(" 使用的场景有：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("基于 V8 引擎的运行环境，如 Node.js、Chrome 浏览器")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("Error.captureStackTrace(this, MyError)")])]),s._v(" "),a("p",[s._v("作用也是隐藏构造函数内部的堆栈信息，但需要明确指定构造函数名，通用性不强。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("Error.captureStackTrace(this, arguments.callee)")])]),s._v(" "),a("p",[a("code",[s._v("arguments.callee")]),s._v(" 表示当前函数，也有通用性。但 ES3 及之后的严格模式禁用了 "),a("code",[s._v("arguments.callee")]),s._v("，因此不建议使用。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("Error.captureStackTrace(this, this.constructor)")])]),s._v(" "),a("p",[s._v("该做法可以隐藏构造函数内部的堆栈信息，无需指定构造函数名，通用型强。")])])])])])])])])]),s._v(" "),a("h1",{attrs:{id:"_4-2-api-服务-babel-core"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-api-服务-babel-core"}},[s._v("#")]),s._v(" 4.2 api 服务: babel-core")]),s._v(" "),a("p",[s._v("TODO")]),s._v(" "),a("h1",{attrs:{id:"_4-3-命令行-babel-cli"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-命令行-babel-cli"}},[s._v("#")]),s._v(" 4.3 命令行: babel-cli")]),s._v(" "),a("p",[s._v("babel-cli 本身的用法本书不再赘述，官方文档讲解的非常详细。")]),s._v(" "),a("p",[s._v("babel-cli 是基于 commander.js 的命令行，了解 commander.js 的使用之后，babel-cli 的原理也比较容易理解了。")]),s._v(" "),a("p",[s._v("babel-cli 的运行过程并不复杂，运行流程图如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/5757051/155269518-722cd7af-fdbd-4adf-a61e-f9ef64e06da7.jpg",alt:"Babel工具集/babel-cli"}})]),s._v(" "),a("p",[s._v("以下是其源码中的部分细节：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("参数定义")]),s._v(" "),a("p",[s._v("babel-cli 的参数定义基于 commander.js。")]),s._v(" "),a("p",[s._v("例如：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" commander "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"commander"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\ncommander"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("option")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-f, --filename [filename]"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"The filename to use when reading from stdin. This will be used in source-maps, errors etc."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("globs 语法")]),s._v(" "),a("p",[s._v("babel-cli 支持通配符匹配源文件，例如：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("babel *.js --output-file dist.js\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("*.js")]),s._v(" 会匹配当前目录所有以 "),a("code",[s._v(".js")]),s._v(" 为后缀的文件。")]),s._v(" "),a("p",[s._v("babel 使用 npm 包 "),a("code",[s._v("glob")]),s._v(" 提供对通配符的支持。")]),s._v(" "),a("p",[s._v("TODO：globs 语法")])]),s._v(" "),a("li",[a("p",[s._v("参数错误信息提示")]),s._v(" "),a("p",[s._v("解析参数的过程中，对于输入错误的情况，babel-cli 在解析过程中用数组统一收集错误信息，最后统一输出给使用者。")]),s._v(" "),a("p",[s._v("这个技巧值得借鉴。")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 错误收集")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" errors "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("commander"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("outFile "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" commander"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("outDir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    errors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("push")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--out-file and --out-dir cannot be used together"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 错误展示")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("errors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"babel:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    errors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("forEach")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("e")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"  "')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("不向前兼容的提示")]),s._v(" "),a("p",[s._v("babel-cli 历史版本可能是支持用户这样使用：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" babel "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"babel-cli"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nbabel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("transform")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("但后续的升级移除了对该功能的支持，为了提示使用者，babel-cli 保留了旧的 "),a("code",[s._v("index.js")]),s._v("，内容比较直接：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Use the `@babel/core` package instead of `@babel/cli`."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在做工具的破坏性升级时，这也是可以借鉴的提示技巧。")])])]),s._v(" "),a("h1",{attrs:{id:"_4-4-node-增强-babel-register"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-node-增强-babel-register"}},[s._v("#")]),s._v(" 4.4 node 增强：babel-register")]),s._v(" "),a("h2",{attrs:{id:"_4-4-1-babel-register-用法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-1-babel-register-用法"}},[s._v("#")]),s._v(" 4.4.1 babel-register 用法")]),s._v(" "),a("p",[s._v("babel-register 模块会改写 node 的 "),a("code",[s._v("require")]),s._v(" 方法，为其加上一个钩子，当 "),a("code",[s._v("require")]),s._v(" 加载 "),a("code",[s._v(".js")]),s._v("、"),a("code",[s._v(".jsx")]),s._v("、"),a("code",[s._v(".es6")]),s._v("、"),a("code",[s._v(".es")]),s._v("、"),a("code",[s._v(".mjs")]),s._v(" 后缀的时候，会先用 Babel 转码。")]),s._v(" "),a("blockquote",[a("p",[s._v("后缀可配置"),a("br"),s._v(" "),a("code",[s._v(".js")]),s._v("、"),a("code",[s._v(".jsx")]),s._v("、"),a("code",[s._v(".es6")]),s._v("、"),a("code",[s._v(".es")]),s._v("、"),a("code",[s._v(".mjs")]),s._v("为默认配置")])]),s._v(" "),a("p",[s._v("举例：")]),s._v(" "),a("p",[s._v("index.js")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'babel-register'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./run'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("run.js")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" fs "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'fs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("执行 "),a("code",[s._v("node index")]),s._v(" 时，run.js 就不需要被转码了。")]),s._v(" "),a("p",[s._v("有两点需要注意：")]),s._v(" "),a("ul",[a("li",[s._v("babel-register 不会对所在的当前文件转码，也就是 "),a("code",[s._v("index.js")]),s._v(" 不会被转码")]),s._v(" "),a("li",[s._v("babel-register 是实时转码，会影响运行性能，只适合在开发环境使用")])]),s._v(" "),a("h2",{attrs:{id:"_4-4-2-require-加载机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-2-require-加载机制"}},[s._v("#")]),s._v(" 4.4.2 require 加载机制")]),s._v(" "),a("p",[s._v("理解 node 中 "),a("code",[s._v("require")]),s._v(" 的加载机制，有助于理解 babel-register 是如何为 require 添加钩子的。")]),s._v(" "),a("p",[s._v("require 的源码定义在 node 源码 "),a("code",[s._v("lib/module.js")]),s._v(" 的 "),a("code",[s._v("Module.prototype.require")]),s._v(" 方法。")]),s._v(" "),a("p",[a("code",[s._v("Module")]),s._v(" 是构造函数，其简要定义如下：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" parent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parent "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" parent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("filename "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("loaded "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("children "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 每个Module实例都有require方法")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("require")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 当前模块 module.js 也是 Module 的实例")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" module "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" parent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("（TODO：附录链接 https://github.com/nodejs/node-v0.x-archive/blob/master/lib/module.js）")]),s._v(" "),a("p",[s._v("下图是 require 过程执行的其中一条链路：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/5757051/155269602-ec603340-e642-46e5-afc4-f5d7fdbc8a0a.jpg",alt:"Babel工具集/require加载机制"}})]),s._v(" "),a("p",[s._v("从上图，我们看到 require 加载链路中有以下特点：")]),s._v(" "),a("ul",[a("li",[s._v("在 node 代码里常见的 "),a("code",[s._v("exports")]),s._v("、"),a("code",[s._v("require")]),s._v("、"),a("code",[s._v("module")]),s._v("、"),a("code",[s._v("__dirname")]),s._v("、"),a("code",[s._v("__filename")]),s._v(" 均是被注入的局部变量")]),s._v(" "),a("li",[s._v("目标模块解析过程中会生成新的 "),a("code",[s._v("Module")]),s._v(" 实例，用于记录目标模块的各类信息")]),s._v(" "),a("li",[a("code",[s._v("require")]),s._v(" 执行过程中涉及很多内部方法，这为 "),a("code",[s._v("require")]),s._v(" 添加钩子提供了可能")]),s._v(" "),a("li",[s._v("一些情况下，目标模块的代码是通过 node 虚拟机 "),a("code",[s._v("require('vm').runInThisContext")]),s._v("、"),a("code",[s._v("require('vm').runInNewContext")]),s._v(" 执行的")])]),s._v(" "),a("h2",{attrs:{id:"_4-4-3-为-require-添加钩子"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-3-为-require-添加钩子"}},[s._v("#")]),s._v(" 4.4.3 为 "),a("code",[s._v("require")]),s._v(" 添加钩子")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("基本原理")]),s._v(" "),a("p",[s._v("我们已经了解了 "),a("code",[s._v("require")]),s._v(" 的加载机制，那么，假如文件 run.js 的内容如下：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[s._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Hi, this is run.js.'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("另有文件 index.js的内容如下：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./run.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("当执行 "),a("code",[s._v("node index.js")]),s._v(" 时，终端会打印：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Hi, this is run.js.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("然后，我们尝试下拦截 "),a("code",[s._v("require")]),s._v("，在执行 "),a("code",[s._v("node index.js")]),s._v(" 时，终端打印：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Knock knock, I'm here"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\nHi, this is run.js.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("结合前面讲解的 "),a("code",[s._v("require")]),s._v(" 加载机制，我们可以从以下点入手：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("重写 "),a("code",[s._v("Module._extensions['.js']")]),s._v("，拦截所有 "),a("code",[s._v(".js")]),s._v(" 文件的 "),a("code",[s._v("require")]),s._v(" 行为")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" Module "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'module'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" oldLoader "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_extensions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_extensions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" filename")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// TODO")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("oldLoader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./run.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("在新的处理函数中，重写 "),a("code",[s._v("module")]),s._v(" 实例的 "),a("code",[s._v("_compile")]),s._v(" 方法")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" Module "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'module'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" oldLoader "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_extensions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_extensions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" filename")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" oldCompile "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_compile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 重写 module._compile")]),s._v("\n    module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("_compile")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("code")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" newCode "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\n                console.log("Knock knock, I\'m here!");\n                ')]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[s._v("${")]),s._v("code"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[s._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\n            ")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("oldCompile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("newCode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("oldLoader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./run.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])])])]),s._v(" "),a("p",[s._v("这样，重新执行 "),a("code",[s._v("node index.js")]),s._v("，终端打印出：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Knock knock, I'm here"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\nindex.js\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("pirates")]),s._v(" "),a("p",[s._v("很显然上面的代码并不优雅，真实的需求中我们可能无需拦截所有的 "),a("code",[s._v(".js")]),s._v(" 文件，可能也需要拦截其他后缀的文件，各种操作还是比较繁琐的。")]),s._v(" "),a("p",[s._v("babel-register 使用 npm 包 "),a("code",[s._v("pirates")]),s._v(" 提供的 "),a("code",[s._v("addHook")]),s._v(" 方法拦截 "),a("code",[s._v("require")]),s._v("，拦截时利用 Babel 对源码转译。")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 拦截 require 注册 compileHook 方法")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// compileHook 会利用Babel转译模块源码，返回转译后的代码")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("addHook")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("compileHook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" exts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("ignoreNodeModules")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[a("code",[s._v("addHook")]),s._v(" 的核心原理同上，但处理了更多细节：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("增强安全性")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" BuiltinModule "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'module'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" Module "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("constructor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("constructor "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" BuiltinModule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("code",[s._v("Module")]),s._v(" 对象的获取优先选取 "),a("code",[s._v("module.constructor")]),s._v("，其次选取内置的 "),a("code",[s._v('"module"')]),s._v(" 模块，以适配 mock 出的 "),a("code",[s._v("module")]),s._v(" 实例。")])]),s._v(" "),a("li",[a("p",[s._v("能够恢复被拦截方法到原始状态")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("revert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("reverted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    reverted "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    exts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("forEach")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("ext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// if the current loader for the extension is our loader then unregister it and set the oldLoader again")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// if not we can not do anything as we cannot remove a loader from within the loader-chain")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_extensions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" loaders"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        Module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("_extensions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" oldLoaders"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("根据配置项确定是否处理目标模块源码")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("shouldCompile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" exts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" matcher"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ignoreNodeModules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" filename "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'string'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("exts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("indexOf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("extname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" resolvedFilename "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ignoreNodeModules "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" nodeModulesRegex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("test")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resolvedFilename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("matcher "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typeof")]),s._v(" matcher "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'function'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("matcher")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resolvedFilename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])])])])])]),s._v(" "),a("h2",{attrs:{id:"_4-4-4-babel-register-内部实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-4-babel-register-内部实现"}},[s._v("#")]),s._v(" 4.4.4 babel-register 内部实现")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("主要流程")]),s._v(" "),a("p",[s._v("在理解了 "),a("code",[s._v("require")]),s._v(" 的加载机制、如何为 "),a("code",[s._v("require")]),s._v(" 添加钩子后，继续阅读 babel-register 源码会得心应手很多。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/5757051/155269714-56adbacc-1c4d-46eb-954f-16028ba60c78.jpg",alt:"Babel工具集/babel-register"}})]),s._v(" "),a("p",[s._v("babel-register 依赖 pirates.js 提供的 "),a("code",[s._v("addHook")]),s._v(" 方法，实现拦截 "),a("code",[s._v("require")]),s._v("，同时在拦截函数里执行 Babel 的转译逻辑。")])]),s._v(" "),a("li",[a("p",[s._v("缓存处理")]),s._v(" "),a("p",[s._v("TODO")])])]),s._v(" "),a("h1",{attrs:{id:"_4-5-命令行-babel-node"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-命令行-babel-node"}},[s._v("#")]),s._v(" 4.5 命令行：babel-node")]),s._v(" "),a("p",[s._v("babel-node 也是基于 commander.js 的命令行服务。下图是 babel-node 的运行过程：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/5757051/155269786-a1927641-ed07-4fa6-829c-9e19c290ca5d.jpg",alt:"Babel工具集/babel-node"}})]),s._v(" "),a("p",[s._v("由上图可以看出，babel-node 的运行过程比较直观。解析其源码，也有一些值得注意的细节：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("v8flags")]),s._v(" "),a("p",[s._v("TODO")])]),s._v(" "),a("li",[a("p",[s._v("kexec 与 spawn")]),s._v(" "),a("p",[s._v("TODO")])]),s._v(" "),a("li",[a("p",[s._v("处理 exit 事件")]),s._v(" "),a("p",[s._v("TODO")])]),s._v(" "),a("li",[a("p",[s._v("repl")]),s._v(" "),a("p",[s._v("TODO")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("vm.runInThisContext")])]),s._v(" "),a("p",[s._v("TODO")])]),s._v(" "),a("li",[a("p",[s._v("Module")]),s._v(" "),a("p",[s._v("TODO")])]),s._v(" "),a("li",[a("p",[s._v("node 参数处理")]),s._v(" "),a("p",[s._v("TODO")])])]),s._v(" "),a("h1",{attrs:{id:"_4-6-浏览器支持-babel-standalone"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-6-浏览器支持-babel-standalone"}},[s._v("#")]),s._v(" 4.6 浏览器支持：babel-standalone")]),s._v(" "),a("p",[s._v("babel-standalone 提供浏览器环境实时转译 JavaScript 的能力。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/5757051/155269870-fbea5b53-1c46-46bc-8d6a-e2822cc3385c.jpg",alt:"Babel工具集/babel-standalone"}})]),s._v(" "),a("h1",{attrs:{id:"_4-7-babel-highlight"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-7-babel-highlight"}},[s._v("#")]),s._v(" 4.7 babel-highlight")]),s._v(" "),a("p",[s._v("babel-highlight 可以将一段代码字符串在终端高亮展示。")]),s._v(" "),a("p",[s._v("代码中已经可以看到 Babel8 的处理方式了。无论是 Babel7 还是 Babel8 的处理方式，总体思路都是：将代码块解析为不同类型的 token 单元，并对不同类型显示不同的颜色。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("token 化处理")]),s._v(" "),a("p",[s._v("babel-highlight 依赖 js-tokens 对代码块解析为不同类型的 token 单元。")]),s._v(" "),a("p",[s._v("TODO")])]),s._v(" "),a("li",[a("p",[s._v("高亮工具：chalk")]),s._v(" "),a("p",[s._v("babel-highlight 使用 chalk 实现代码块在终端的高亮。")]),s._v(" "),a("p",[s._v("TODO")])]),s._v(" "),a("li",[a("p",[s._v("高亮规则")]),s._v(" "),a("p",[s._v("babel-highlight 会用不同颜色对以下目标类型进行高亮处理：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("keyword")]),s._v(": 关键词")]),s._v(" "),a("li",[a("code",[s._v("capitalized")]),s._v(": 大写")]),s._v(" "),a("li",[a("code",[s._v("jsxIdentifier")]),s._v(": JSX标识符")]),s._v(" "),a("li",[a("code",[s._v("punctuator")]),s._v(": 标点")]),s._v(" "),a("li",[a("code",[s._v("number")]),s._v(": 数字")]),s._v(" "),a("li",[a("code",[s._v("string")]),s._v(": 字符串")]),s._v(" "),a("li",[a("code",[s._v("regex")]),s._v(": 正则")]),s._v(" "),a("li",[a("code",[s._v("comment")]),s._v(": 注释")]),s._v(" "),a("li",[a("code",[s._v("invalid")]),s._v(": 非正常写法")]),s._v(" "),a("li",[a("code",[s._v("uncolored")])])])])]),s._v(" "),a("h1",{attrs:{id:"_4-8-babel-template"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-8-babel-template"}},[s._v("#")]),s._v(" 4.8 babel-template")]),s._v(" "),a("p",[s._v("TODO")]),s._v(" "),a("h1",{attrs:{id:"_4-9-webpack-支持-babel-loader"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-9-webpack-支持-babel-loader"}},[s._v("#")]),s._v(" 4.9 webpack 支持：babel-loader")]),s._v(" "),a("p",[s._v("babel-loader 非 Babel 官方出品，也是 webpack 生态中的重要基础工具，其承担了对 webpack 打包过程中相关文件的转译工作。")]),s._v(" "),a("p",[s._v("下图是 babel-loader 的大致运行过程：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/5757051/155269949-ad23f672-418a-4cf4-b315-60bfcdada50f.jpg",alt:"Babel工具集/babel-loader-总览"}})]),s._v(" "),a("ul",[a("li",[a("p",[s._v("转译模块")]),s._v(" "),a("p",[s._v("babel-loader 直接使用 babel-core 的 "),a("code",[s._v("transform")]),s._v(" 方法执行源码的转译。而 "),a("code",[s._v("transform")]),s._v(" 的转译结果对象包含众多属性，babel-loader 选取了部分属性作为新的结果对象。")]),s._v(" "),a("p",[s._v("根据 Github issue 中的描述，babel-loader 开发者注意到，transform 返回的原始结果对象中，含有难以序列化的属性值（如 "),a("code",[s._v("options")]),s._v("），而 Babel 本身也会提供本地化的缓存结果，对于难以序列化的 "),a("code",[s._v("options")]),s._v(" 等属性，缓存时会丢失一些信息，因此，babel-loader 只会返回可以序列化的部分属性组成的新结果对象。")])]),s._v(" "),a("li",[a("p",[s._v("缓存模块")]),s._v(" "),a("p",[s._v("babel-loader 将转移过的结果缓存到本地文件系统。")]),s._v(" "),a("p",[s._v("缓存路径优先使用开发者设置的 "),a("code",[s._v("cacheDirectory")]),s._v(" 路径，否则使用 "),a("code",[s._v("babel-loader")]),s._v(" 提供的默认缓存路径。")]),s._v(" "),a("p",[s._v("经过 babel-core 的 "),a("code",[s._v("transform")]),s._v(" API 处理的转译结果 result 对象，会直接被 "),a("code",[s._v("JSON.stringify(result)")]),s._v(" 转为字符串，并写入本地缓存。如果开发者指定需要对缓存文件压缩，则会压缩为 "),a("code",[s._v(".gz")]),s._v(" 文件，否则会明文写入缓存文件。")]),s._v(" "),a("p",[s._v("下图描述了缓存处理过程：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/5757051/155270020-30770461-e00e-46db-b5b2-829898ad4c9e.jpg",alt:"Babel工具集/babel-loader-cache"}})])]),s._v(" "),a("li",[a("p",[s._v("错误处理模块")]),s._v(" "),a("p",[s._v("对于转译过程发生的错误，babel-loader 并没有直接使用 Node 的原生错误表现，而是基于原生 "),a("code",[s._v("Error")]),s._v(" 类，封装了定制化的 "),a("code",[s._v("LoaderError")]),s._v(" 类。 "),a("code",[s._v("LoaderError")]),s._v(" 类对错误信息执行格式化，主要规范了以下属性：")]),s._v(" "),a("ul",[a("li",[a("p",[a("code",[s._v("name")])]),s._v(" "),a("p",[s._v('报错名称统一为"'),a("code",[s._v("BabelLoaderError")]),s._v('"。')])]),s._v(" "),a("li",[a("p",[a("code",[s._v("message")])]),s._v(" "),a("p",[s._v("去掉 message 信息中的冗余信息。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("hideStack")])]),s._v(" "),a("p",[s._v("隐藏堆栈信息。")])]),s._v(" "),a("li",[a("p",[s._v("使用 "),a("code",[s._v("Error.captureStackTrace")]),s._v(" 隐藏非必要信息")]),s._v(" "),a("p",[s._v("TODO")])])])])])])}),[],!1,null,null,null);t.default=e.exports}}]);