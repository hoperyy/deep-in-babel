<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《深入理解 Babel》 · 刘远洋</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="manifest" href="/deep-in-babel/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="Just playing around">
    <meta property="og:url" content="/deep-in-babel/06.Babel%E5%86%85%E7%BD%AEplugin/">
    <meta property="og:site_name" content="《深入理解 Babel》 · 刘远洋">
    <meta property="og:description" content="在本章，我们将全面了解 Babel 插件生态中，Babel 内置的各类 plugins 和 presets。由于插件数量众多，这里主要介绍各个插件的功能、核心实现思路、部分实现，本章中很多案例来自 Babel 官网。 如果对各个插件的实现细节感兴趣，可以继续阅读各个插件的源码，可以对 Babel 插件的开发过程有更清晰的了解。 6.1 配置 无论是在配置文件">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="《深入理解 Babel》 · 刘远洋">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <link rel="preload" href="/deep-in-babel/assets/css/0.styles.2e317060.css" as="style"><link rel="preload" href="/deep-in-babel/assets/js/app.ce7a4d57.js" as="script"><link rel="preload" href="/deep-in-babel/assets/js/vendors~layout-Layout.f8963aab.js" as="script"><link rel="preload" href="/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ebefd1c7.js" as="script"><link rel="preload" href="/deep-in-babel/assets/js/page--5e0b8312.34d20a66.js" as="script"><link rel="preload" href="/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.33005620.js" as="script"><link rel="prefetch" href="/deep-in-babel/assets/js/22.6353f00e.js"><link rel="prefetch" href="/deep-in-babel/assets/js/layout-Blog.b0c6dcb7.js"><link rel="prefetch" href="/deep-in-babel/assets/js/layout-Layout.54347a9b.js"><link rel="prefetch" href="/deep-in-babel/assets/js/layout-NotFound.846facba.js"><link rel="prefetch" href="/deep-in-babel/assets/js/layout-Slide.88fa1023.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--4c0dc106.30bd06b4.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--4fdeacc4.b6218b0e.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--584954b8.6ac5374d.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--6723acaa.5e9a3a71.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--6ea6aa74.99eda923.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--8fcba694.e2bc50aa.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--9bf3e428.c95018ed.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--aec4dcea.614b31ca.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--c3b426fa.9544b46f.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page--d99aed8e.811085ae.js"><link rel="prefetch" href="/deep-in-babel/assets/js/page-前言.f0a3bfce.js"><link rel="prefetch" href="/deep-in-babel/assets/js/vendors~photo-swipe.e221f9da.js">
    <link rel="stylesheet" href="/deep-in-babel/assets/css/0.styles.2e317060.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/deep-in-babel/" class="home-link router-link-active"><!----> <!----> <span class="site-name can-hide">《深入理解 Babel》 · 刘远洋</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://mogonote.com/home" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Notely
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></nav> <!----> <a rel="noopener noreferrer" href="https://github.com/hoperyy/deep-in-babel" target="_blank" class="repo-link can-hide">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="https://mogonote.com/home" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Notely
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a rel="noopener noreferrer" href="https://github.com/hoperyy/deep-in-babel" target="_blank" class="repo-link">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> <div class="content__sidebar-center"></div> <ul class="sidebar-links"><li><a href="/deep-in-babel/00.%E5%89%8D%E8%A8%80/" class="sidebar-link">第 0 章 - 前言</a></li><li><a href="/deep-in-babel/01.%E6%A6%82%E8%BF%B0/" class="sidebar-link">第 1 章 - 概述</a></li><li><a href="/deep-in-babel/02.%E8%BD%AC%E8%AF%91%E5%8E%9F%E7%90%86/" class="sidebar-link">第 2 章 - 转译原理</a></li><li><a href="/deep-in-babel/03.Babel%E8%8A%82%E7%82%B9/" class="sidebar-link">第 3 章 - Babel 节点</a></li><li><a href="/deep-in-babel/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/" class="sidebar-link">第 4 章 - Babel 工具集</a></li><li><a href="/deep-in-babel/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/" class="sidebar-link">第 5 章 - Babel 插件编写</a></li><li><a href="/deep-in-babel/06.Babel%E5%86%85%E7%BD%AEplugin/" aria-current="page" class="active sidebar-link">第 6 章 - Babel 内置 Plugin</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/deep-in-babel/06.Babel%E5%86%85%E7%BD%AEplugin/#_6-2-1-语法类插件" class="sidebar-link">6.2.1 语法类插件</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/06.Babel%E5%86%85%E7%BD%AEplugin/#_6-2-2-标准特性转换类插件" class="sidebar-link">6.2.2 标准特性转换类插件</a></li><li class="sidebar-sub-header"><a href="/deep-in-babel/06.Babel%E5%86%85%E7%BD%AEplugin/#_6-2-3-提案特性转换插件" class="sidebar-link">6.2.3 提案特性转换插件</a></li></ul></li><li><a href="/deep-in-babel/07.Babel%E5%86%85%E7%BD%AEpreset/" class="sidebar-link">第 7 章 - Babel 内置 Preset</a></li><li><a href="/deep-in-babel/08.runtime/" class="sidebar-link">第 8 章 - runtime</a></li><li><a href="/deep-in-babel/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" class="sidebar-link">第 9 章 - Babel 项目管理</a></li><li><a href="/deep-in-babel/10.%E8%BD%AC%E8%AF%91%E5%99%A8%E5%AF%B9%E6%AF%94/" class="sidebar-link">第 10 章 - 转译器对比</a></li></ul> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb disable"><!----></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline"></span></h1> <div class="page-info"><!----> <!----><!----><!----><!----><!----><span aria-label="Reading Time⌛" data-balloon-pos="down" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 47 min</span> <meta property="timeRequired" content="PT47M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/deep-in-babel/06.Babel%E5%86%85%E7%BD%AEplugin/#_6-2-1-语法类插件" class="anchor-link heading2"><div>6.2.1 语法类插件</div></a></li><li class="anchor"><a href="/deep-in-babel/06.Babel%E5%86%85%E7%BD%AEplugin/#_6-2-2-标准特性转换类插件" class="anchor-link heading2"><div>6.2.2 标准特性转换类插件</div></a></li><li class="anchor"><a href="/deep-in-babel/06.Babel%E5%86%85%E7%BD%AEplugin/#_6-2-3-提案特性转换插件" class="anchor-link heading2"><div>6.2.3 提案特性转换插件</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><p>在本章，我们将全面了解 Babel 插件生态中，Babel 内置的各类 plugins 和 presets。由于插件数量众多，这里主要介绍各个插件的功能、核心实现思路、部分实现，本章中很多案例来自 Babel 官网。</p> <p>如果对各个插件的实现细节感兴趣，可以继续阅读各个插件的源码，可以对 Babel 插件的开发过程有更清晰的了解。</p> <h1 id="_6-1-配置"><a href="#_6-1-配置" class="header-anchor">#</a> 6.1 配置</h1> <p>无论是在配置文件、还是作为 API 调用参数，Babel 的 plugins 和 presets 均以如下形式配置：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;plugin-a&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 字符串形式</span>
        <span class="token punctuation">[</span> 
            <span class="token string">&quot;plugin-b&quot;</span><span class="token punctuation">,</span> 
            <span class="token punctuation">{</span>
                <span class="token literal-property property">desc</span><span class="token operator">:</span> <span class="token string">&quot;hello plugin world&quot;</span>
            <span class="token punctuation">}</span> 
        <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 数组形式: [ plugin名称, 插件配置参数 ]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;preset-a&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 字符串</span>
        <span class="token punctuation">[</span> 
            <span class="token string">&quot;preset-b&quot;</span><span class="token punctuation">,</span> 
            <span class="token punctuation">{</span>
                <span class="token literal-property property">desc</span><span class="token operator">:</span> <span class="token string">&quot;hello preset world&quot;</span>
            <span class="token punctuation">}</span> 
        <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 数组形式: [ preset名称, 插件配置参数 ]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h1 id="_6-2-内置-plugins"><a href="#_6-2-内置-plugins" class="header-anchor">#</a> 6.2 内置 plugins</h1> <p>本节主要介绍 Babel 内置插件(plugins)。</p> <p>Babel 以丰富的插件支持 JavaScript 代码的转换，在 Babel 的工程目录中，各个插件以 <code>babel-plugin-</code> 开头的文件夹命名。截止本书定稿时，内置的插件已有 95 个。</p> <p>Babel 的内置插件分为如下几种：</p> <ul><li><p>语法类插件</p> <p>语法插件以 <code>babel-plugin-syntax-</code> 开头，负责开启 babel-parser 对某个语法的支持。</p> <p>为什么会有语法插件呢？</p> <p>之前的章节提到，babel-parser 负责对源码进行词法解析、语法解析，它可以支持 ECMAScript 标准、提案、TypeScript、Flow 等语法。但除了基础语法，很多语法如 TypeScript、Flow、部分 ECMAScript 语法默认是不会开启支持的，这是为了减少不必要的转译消耗，同时方便使用者针对性地开启对某个语法的支持。</p> <p>简言之，语法类插件主要角色是对某个语法支持的开关，不涉及 AST 修改的工作。</p> <p>通常情况下，语法插件不需要单独引入，因为转换类和提案类的插件会引入语法插件以开启对特定语法的支持。</p></li> <li><p>转换类插件</p> <p>转换插件以 <code>babel-plugin-transform-</code> 开头，负责转换 JavaScript 代码，即我们熟悉的代码转换部分。</p> <p>如箭头函数 <code>() =&gt; {}</code> 转普通函数 <code>function() {}</code>。</p> <p>转换类插件会引入语法插件以开启对当前语法的支持。</p></li> <li><p>对提案支持类插件</p> <p>其实也是转换类插件，只不过是针对提案(proposal)类特性的转换。</p> <p>对提案支持类插件以 <code>babel-plugin-proposal-</code> 开头，负责提供对 ECMAScript 提案的支持。</p> <p>转换类插件会引入语法插件以开启对目标语法的支持。</p></li></ul> <h2 id="_6-2-1-语法类插件"><a href="#_6-2-1-语法类插件" class="header-anchor">#</a> 6.2.1 语法类插件</h2> <p>如上节所述，语法类插件主要是对某个语法支持的开关，不涉及代码转译工作。</p> <p>截至本书编写时，Babel 中有 19 个语法类插件，以下是列举每个插件的作用：</p> <ul><li><p>babel-plugin-syntax-class-properties</p> <p>开启对类的属性(<code>classProperties</code>)、私有属性(<code>classPrivateProperties</code>)、私有方法(<code>classPrivateMethods</code>)的语法支持。</p> <p>举例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Man</span> <span class="token punctuation">{</span>
    <span class="token comment">// 属性</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Jack'</span><span class="token punctuation">,</span>

    <span class="token comment">// 私有属性</span>
    <span class="token keyword">private</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>

    <span class="token comment">// 私有方法</span>
    <span class="token keyword">private</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hi!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p>babel-plugin-syntax-class-static-block</p> <p>开启 <code>classStaticBlock</code> 语法的支持。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">NewClass</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token comment">// do something </span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>举例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 没有使用 static block</span>
<span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> x <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> y<span class="token punctuation">;</span>
    <span class="token keyword">static</span> z<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">doSomethingWith</span><span class="token punctuation">(</span><span class="token constant">C</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">C</span><span class="token punctuation">.</span>y <span class="token operator">=</span> obj<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token constant">C</span><span class="token punctuation">.</span>z <span class="token operator">=</span> obj<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    <span class="token constant">C</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>
    <span class="token constant">C</span><span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用 static block</span>
<span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> x <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> y<span class="token punctuation">;</span>
    <span class="token keyword">static</span> z<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">doSomethingWith</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> obj<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>z <span class="token operator">=</span> obj<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>利用 <code>classStaticBlock</code>，可以在类内部完成类的属性初始化等操作，无需在类的外部区域操作。</p></li> <li><p>babel-plugin-syntax-decimal</p> <p>开启 <code>Decimal</code> 语法的支持，<code>Decimal</code> 意为十进制，该语法可以显著提升提升十进制数的可读性。</p> <ul><li><p>为什么有这个提案</p> <p><code>Decimal</code> 提案希望在 JavaScript 中添加一个内置的十进制类型。</p> <p>JavaScript 中经常需要存储和处理十进制数，但 JavaScript 中<code>Number</code>对数字精度的处理能力并不尽如人意，为了更好的精度，开发者还需使用其他技巧处理，比如第三方库、字符串等。</p> <p>这样在代码的可读性、结果精确度等方面均有很大提升空间。</p></li> <li><p>写法</p> <p><code>1000m</code>。</p></li> <li><p>该提案目标</p> <ul><li><p>目标1：更好的数字可读性，比如针对货币的场景</p> <p>在处理货币数字的问题上会有以下问题：</p> <ul><li>涉及金钱、且不同的人对特定数字表示的金钱的含义理解不同，导致开发者心理负担较重</li> <li>货币可以用不同数量的小数位描述，这需要一个精确的数据类型描述，如 <code>$23.47、$23.4700</code></li></ul> <p>举个例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">calculateBill</span><span class="token punctuation">(</span><span class="token parameter">items<span class="token punctuation">,</span> tax</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> total <span class="token operator">=</span> 0m<span class="token punctuation">;</span>

    <span class="token comment">// 计算总数</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">{</span> price<span class="token punctuation">,</span> count <span class="token punctuation">}</span> <span class="token keyword">of</span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        total <span class="token operator">+=</span> price <span class="token operator">*</span> <span class="token function">BigDecimal</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// BigDecimal 内置类型转换普通数字</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 计算税</span>
    <span class="token keyword">return</span> BigDecimal<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>
        total <span class="token operator">*</span> <span class="token punctuation">(</span>1m <span class="token operator">+</span> tax<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token literal-property property">maximumFractionDigits</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token literal-property property">round</span><span class="token operator">:</span> <span class="token string">&quot;up&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token literal-property property">price</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">.</span>25m<span class="token punctuation">,</span> <span class="token comment">// decimal 写法</span>
        <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">5</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token punctuation">{</span>
        <span class="token literal-property property">price</span><span class="token operator">:</span> 5m<span class="token punctuation">,</span> <span class="token comment">// decimal 写法</span>
        <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> tax <span class="token operator">=</span> <span class="token punctuation">.</span>0735m<span class="token punctuation">;</span> <span class="token comment">// decimal 写法</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">calculateBill</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> tax<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>过去 JavaScript 很少直接参与数字的精确计算，更多地是将数字作为字符串做呈现，但现在的一些趋势，对于 JavaScript 数字方面的精确性、可读性的要求越来越高：</p> <ul><li><p>更复杂的前端架构</p> <p>JavaScript 在本地即可完成各类复杂计算以便更好地交互。</p></li> <li><p>Serverless</p> <p>JavaScript 已参与越来越多的 Serverless 服务，这对于本地化的计算需求越来越多。</p></li> <li><p>基于 JavaScript 的服务端编程</p> <p>JavaScript 也可以作为服务端开发语言，该领域对于数字精确计算的要求非常高。</p></li></ul></li> <li><p>目标2：更高的浮点数精度</p> <p>在目标1的介绍中已经提到了对 JavaScript 数字计算精度的要求。从实际需求看，现在越来越多的场景需要客户端本地环境下的高精度 JavaScript 数字计算，比如航天器、物联网设备、游戏、甚至支付系统。</p> <p>而以前内置的 <code>Number</code> 类型在高精度数字计算方面并不理想，如果 JavaScript 中内置了新的高精度数字计算类型，开发者也就不再需要引入第三方工具或其他手段解决精度问题，代码量更少。</p></li></ul></li> <li><p>用哪种新的数据类型？</p> <p>提案中提到了两种新的数据类型：<code>BigDecimal</code> 和 <code>Decimal128</code>。二者主要是对数字精度方面的区别，各有利弊，用哪一种需要做权衡。</p> <ul><li><p><code>BigDecimal</code>: 无限精度数字</p></li> <li><p><code>Decimal128</code>: 基于 IEEE 754-2008 标准的 128 位十进制数</p> <p>IEEE 754（2008）定义了三种基本的十进制浮点格式（32, 64 和 128位）。</p></li></ul></li></ul></li> <li><p>babel-plugin-syntax-decorators</p> <p>开启对装饰器语法的支持。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@decorator
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对外的配置项：</p> <ul><li><p><code>legacy</code></p> <p>使用 state 1 阶段描述的装饰器写法。</p> <p>TODO</p></li> <li><p><code>decoratorsBeforeExport</code></p> <p>是否要求装饰器位于 <code>export</code> 前，默认是 <code>false</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// decoratorsBeforeExport: true</span>
@decorator
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// decoratorsBeforeExport: false</span>
<span class="token keyword">export</span> @decorator <span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul></li> <li><p>babel-plugin-syntax-do-expressions</p> <p>开启对 <code>do</code> 表达式语法的支持，但并不会启动对 <code>do</code> 语法的转换，可以使用 <code>babel-plugin-proposal-do-expressions</code> 同时启动语法和转换。</p> <p><code>do</code> 表示可以认为是三元表达式的变种，在较复杂的情况下加，用 <code>do</code> 表达式更简洁。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>y <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token string">'big x, big y'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token string">'big x, small y'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>y <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token string">'small x, big y'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token string">'small x, small y'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li> <li><p>babel-plugin-syntax-export-default-from</p> <p>开启对 <code>export-default-from</code> 表达式语法的支持，不提供转译支持。可以使用 <code>babel-plugin-proposal-export-default-from</code> 同时启动语法和转译。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>babel-plugin-syntax-flow</p> <p>开启对 <code>flow</code> 语法的支持。</p></li> <li><p>babel-plugin-syntax-function-bind</p> <p>开启对 <code>functionBind</code> 语法的支持。</p> <p><code>functionBind</code>，顾名思义，就是为指定方法指定运行时的 <code>this</code> 值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">obj</span><span class="token operator">:</span><span class="token operator">:</span>func
<span class="token comment">// 相当于</span>
<span class="token function">func</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

<span class="token operator">:</span><span class="token operator">:</span>obj<span class="token punctuation">.</span>func
<span class="token comment">// 相当于</span>
obj<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

<span class="token literal-property property">obj</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">func</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
<span class="token comment">// 相当于</span>
<span class="token function">func</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> val<span class="token punctuation">)</span>

<span class="token operator">:</span><span class="token operator">:</span>obj<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
<span class="token comment">// 相当于</span>
obj<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li> <li><p>babel-plugin-syntax-function-sent</p> <p>开启对 <code>functionSent</code> 语法的支持，即开启对 <code>function.sent</code> 的语法支持。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Sent&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">.</span>sent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Yield&quot;</span><span class="token punctuation">,</span> <span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Logs &quot;Sent 1&quot;</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Logs &quot;Yield 2&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>相当于</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> generator <span class="token operator">=</span> <span class="token function">_skipFirstGeneratorNext</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> _functionSent <span class="token operator">=</span> <span class="token keyword">yield</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Sent&quot;</span><span class="token punctuation">,</span> _functionSent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Yield&quot;</span><span class="token punctuation">,</span> <span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Logs &quot;Sent 1&quot;</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Logs &quot;Yield 2&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>babel-plugin-syntax-import-assertions</p> <p>开启对 <code>Import assertions</code> 语法的支持。</p> <p>该语法主要是为了更清晰地描述模块的一些特性信息，比如类型。</p> <p>举个例子，引入 <code>./config.json</code> 文件时，声明其内容类型为 json，有几种写法：</p> <ul><li><p>静态import</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">'./config.json'</span> <span class="token keyword">assert</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'json'</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>动态import</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./config.json'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">assert</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'json'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>export</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> config <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config.json'</span> <span class="token keyword">assert</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'json'</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li> <li><p>babel-plugin-syntax-jsx</p> <p>开启对 <code>jsx</code> 语法的支持。</p></li> <li><p>babel-plugin-syntax-module-blocks</p> <p>开启对 <code>moduleBlocks</code> 语法的支持。</p> <p><code>moduleBlocks</code> 语法简介如下(案例来自 tc39)：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> moduleBlock <span class="token operator">=</span> module <span class="token punctuation">{</span>
    <span class="token keyword">export</span> <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> moduleExports <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span>moduleBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span><span class="token punctuation">(</span>moduleExports<span class="token punctuation">.</span>y <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span>moduleBlock<span class="token punctuation">)</span> <span class="token operator">===</span> moduleExports<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// cached in the module map</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这样，提供了非文件的方式引入模块。</p> <p>且 <code>moduleBlocks</code> 只能被 <code>import()</code> 引入，而非 <code>import</code> 表达式。</p></li> <li><p>babel-plugin-syntax-module-string-names</p> <p>开启对 <code>moduleStringNames</code> 语法的支持，也就是模块别名的支持。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token punctuation">{</span> hi <span class="token keyword">as</span> <span class="token string">'hello'</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./hi.js'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>babel-plugin-syntax-partial-application</p> <p>开启 <code>partialApplication</code> 语法的支持。</p> <p>根据提案的描述：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> addOne <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// apply from the left</span>
<span class="token function">addOne</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>

<span class="token keyword">const</span> addTen <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// apply from the right</span>
<span class="token function">addTen</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 12</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这也是函数科里化的一个简单式的写法。</p></li> <li><p>babel-plugin-syntax-pipeline-operator</p> <p>开启对 <code>pipelineOperator</code> 语法的支持，也就是 <code>|&gt;</code> 写法。</p> <p>这个写法挺实用的，举例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 各类函数定义</span>
<span class="token keyword">function</span> <span class="token function">doubleSay</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> str<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">capitalize</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> str<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">exclaim</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token string">'!'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>运行案例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 写法一</span>
<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">exclaim</span><span class="token punctuation">(</span><span class="token function">capitalize</span><span class="token punctuation">(</span><span class="token function">doubleSay</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
result <span class="token comment">//=&gt; &quot;Hello, hello!&quot;</span>

<span class="token comment">// 写法二</span>
<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span>
    <span class="token operator">|</span><span class="token operator">&gt;</span> doubleSay
    <span class="token operator">|</span><span class="token operator">&gt;</span> capitalize
    <span class="token operator">|</span><span class="token operator">&gt;</span> exclaim<span class="token punctuation">;</span>

result <span class="token comment">//=&gt; &quot;Hello, hello!&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>babel-plugin-syntax-record-and-tuple</p> <p>https://github.com/tc39/proposal-record-tuple</p> <p>开启对 <code>recordAndTuple</code> 语法的支持，对应的是 <code>proposal-record-tuple</code> 提案。</p> <p><code>proposal-record-tuple</code> 提案为 JavaScript 新增了两种数据结构：<code>Record</code>（类似对象）和 <code>Tuple</code>（类似数组）。</p> <p>二者共同点均是不可变的（Immutable），且其成员不能包含引用类型。因此，可以用此特性对其进行值比较。如果 Record 之间和 Tuple 之间的成员完全一致，则被认为相同（<code>===</code> 返回 <code>true</code>）。</p> <p>该特性使用 <code>#</code> 标记，且支持 <code>Record</code> 和 <code>Tuple</code> 的互相嵌套式写法。</p> <p>例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Record</span>
<span class="token keyword">const</span> recordExample <span class="token operator">=</span> #<span class="token punctuation">{</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">c</span><span class="token operator">:</span> #<span class="token punctuation">[</span> <span class="token string">'My'</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'is'</span><span class="token punctuation">,</span> <span class="token string">'...'</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Tuple</span>
<span class="token keyword">const</span> tupleExample <span class="token operator">=</span> #<span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'3'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>babel-plugin-syntax-throw-expressions</p> <p>开启对 <code>throwExpressions</code> 的语法支持。</p> <p>举例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">save</span><span class="token punctuation">(</span>filename <span class="token operator">=</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Argument required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>babel-plugin-syntax-top-level-await</p> <p>开启在一级作用域直接使用 <code>await</code> 语法的支持。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token keyword">await</span> promise<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> val <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>babel-plugin-syntax-typescript</p> <p>开启对 <code>TypeScript</code> 语法的支持。</p></li></ul> <h2 id="_6-2-2-标准特性转换类插件"><a href="#_6-2-2-标准特性转换类插件" class="header-anchor">#</a> 6.2.2 标准特性转换类插件</h2> <p>截至本书编写时，Babel 有 52 个内置标准特性转换插件。</p> <p>转换插件，顾名思义，就是对源码进行转换操作，确切地说，是对源码的 AST 进行转换操作，包括新增、删除、复制、校验节点等。本节介绍的转换插件针对已经标准化的特性，对于还处于提案状态的特性，下节的提案特性转换插件中详细介绍。</p> <ul><li><p>babel-plugin-transform-arrow-functions</p> <ul><li><p>作用</p> <p>将箭头函数转为普通函数。</p></li> <li><p>目标节点</p> <p><code>ArrowFunctionExpression</code>: 箭头函数表达式节点。</p></li> <li><p>插件配置</p> <p>该插件支持配置参数 <code>spec</code>（默认 <code>false</code>）。</p> <ul><li><p><code>spec: true</code></p> <ul><li>转换后的普通函数绑定当前环境的 <code>this</code></li> <li>阻止被 <code>new</code> 实例化</li> <li>为生成的普通函数添加 <code>name</code></li></ul></li> <li><p><code>spec: false</code></p> <p>转译为普通函数，不做额外处理。</p></li></ul></li> <li><p>转换原理</p> <p>待转换的源码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>spec分别为 <code>true</code>、<code>false</code> 的转译结果：</p> <ul><li><p>spec: <code>true</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

<span class="token comment">// babel-helpers定义的一个帮助函数</span>
<span class="token keyword">function</span> <span class="token function">_newArrowCheck</span><span class="token punctuation">(</span><span class="token parameter">innerThis<span class="token punctuation">,</span> boundThis</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// new 实例化生成的 this 优先级高于 bind</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>innerThis <span class="token operator">!==</span> boundThis<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot instantiate an arrow function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 普通函数添加了名称 &quot;fn&quot;</span>
<span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查是否被new实例化，如果是，则抛出错误</span>
    <span class="token function">_newArrowCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> _this<span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成的普通函数绑定当前 this</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>生成的函数有以下特点：</p> <ul><li>转换后的普通函数绑定当前环境的 <code>this</code></li> <li>阻止被 <code>new</code> 实例化</li> <li>为生成的普通函数添加 <code>name</code></li></ul> <blockquote><p><code>this</code> 值的优先级：<code>new</code> 实例化生成的 <code>this</code> 优先级高于 <code>bind</code> 绑定的 <code>this</code>。</p></blockquote></li> <li><p>spec: <code>false</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>转译为普通函数，不做额外处理。</p></li></ul></li> <li><p>插件源码细节</p> <ul><li><p><code>path.isArrowFunctionExpression</code>: 判断是否是箭头函数表达式</p> <p>该方法定义自 <code>babel/packages/babel-traverse/src/path/index.ts</code>。</p></li> <li><p><code>path.arrowFunctionToExpression</code>: 将当前箭头函数转为表达式节点</p> <p>该方法定义自 <code>babel/packages/babel-traverse/src/path/conversion.ts</code>。</p> <p>对该方法的介绍可以参考章节 &quot;Babel插件编写&quot;。</p></li></ul></li></ul></li> <li><p>babel-plugin-transform-async-to-generator</p> <ul><li><p>作用</p> <p>将 <code>async</code> 标记的函数转为 <code>generator</code> 函数。</p> <p>如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token number">42</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _ref <span class="token operator">=</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token number">42</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">_ref</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>目标节点</p> <p><code>Function</code>: 函数节点。</p></li> <li><p>插件配置</p> <p>该插件支持配置参数：</p> <ul><li><code>module</code></li> <li><code>method</code></li></ul></li> <li><p>协程</p> <p>https://zhangchen915.com/index.php/archives/719/（《JS 中的协程》）</p> <p>在实现该转译时，用到了协程的概念。协程实现了控制流主动让出和恢复机制，让控制流更加流畅。</p> <ul><li><p>什么是协程？</p> <p>协程是一个特殊的函数：是可以暂停执行、可从暂停点恢复的函数。</p> <p>JavaScript 中的协程，是用 <code>*</code> 标记的函数（<code>function*(...) { ... }</code>），函数内部用 <code>yield</code> 关键字暂停、然后可通过 <code>done()</code> 方法从暂停点恢复。</p></li> <li><p>协程/线程/进程</p> <ul><li><p>进程</p> <p>进程是应用程序的启动实例，拥有代码、打开的文件资源、数据资源、独立的内存空间。</p></li> <li><p>线程</p> <p>线程从属于进程，是程序的实际执行者。一个进程包含一个或多个子线程。线程拥有独立的栈空间。</p></li> <li><p>协程</p> <p>协程是线程的子集，一个线程可拥有多个协程。</p> <p>协程不被操作系统控制，而是被应用程序自身控制。</p> <p>多个线程可以并行执行，但在一个线程内，协程函数是串行执行的。</p></li> <li><p>三者的区别于联系</p> <table><thead><tr><th></th> <th>协程</th> <th>线程</th> <th>进程</th></tr></thead> <tbody><tr><td>控制主体</td> <td>程序自身控制</td> <td>操作系统</td> <td>操作系统</td></tr> <tr><td>共享堆</td> <td>Y</td> <td>Y</td> <td>N</td></tr> <tr><td>共享栈</td> <td>N</td> <td>N</td> <td>N</td></tr> <tr><td>独立上下文</td> <td>Y</td> <td>Y</td> <td>Y</td></tr> <tr><td>切换上下文涉及点</td> <td>只切换用户态</td> <td>切换用户态和内核态</td> <td>切换用户态和内核态</td></tr></tbody></table></li></ul></li></ul></li> <li><p>转换原理</p> <p>该插件使用两种方式实现协程函数的自动执行。</p> <ul><li><p>用 <code>promise/generaotr</code> 实现 <code>async/await</code></p> <p>下面是无配置情况下转换后的代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">asyncGeneratorStep</span><span class="token punctuation">(</span><span class="token parameter">gen<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> _next<span class="token punctuation">,</span> _throw<span class="token punctuation">,</span> key<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">try</span> <span class="token punctuation">{</span> 
        <span class="token keyword">var</span> info <span class="token operator">=</span> gen<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">var</span> value <span class="token operator">=</span> info<span class="token punctuation">.</span>value<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>_next<span class="token punctuation">,</span> _throw<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> args <span class="token operator">=</span> arguments<span class="token punctuation">;</span> 
        
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">var</span> gen <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            
            <span class="token keyword">function</span> <span class="token function">_next</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token function">asyncGeneratorStep</span><span class="token punctuation">(</span>gen<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> _next<span class="token punctuation">,</span> _throw<span class="token punctuation">,</span> <span class="token string">&quot;next&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span> 
            
            <span class="token keyword">function</span> <span class="token function">_throw</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token function">asyncGeneratorStep</span><span class="token punctuation">(</span>gen<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> _next<span class="token punctuation">,</span> _throw<span class="token punctuation">,</span> <span class="token string">&quot;throw&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span> 
            
            <span class="token function">_next</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _ref <span class="token operator">=</span> <span class="token function">_asyncToGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token number">42</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">_ref</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>从上面的代码可以看到几个特点：</p> <ul><li><code>async</code> 标记的函数被转译为了普通函数，同时该普通函数返回 <code>Promise</code> 实例</li> <li><code>await</code> 所在的表达式被转译为了 <code>yield</code> 标记的表达式</li> <li>转换后的普通函数利用：<code>Promise</code>、<code>yield</code> 表达式的 <code>done/value</code>、递归调用等实现了一个自动执行方法</li></ul> <p>其实，就是常说的：<code>async/await</code> 是 <code>promise/generaotr</code>的语法糖。</p></li> <li><p>用第三方工具实现 <code>async/await</code></p> <p>添加配置项 <code>module</code> 和 <code>method</code>，使用第三方实现协程:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'bluebird'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token string">'coroutine'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>源码会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> bluebird <span class="token keyword">as</span> _bluebird <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;coroutine&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _ref <span class="token operator">=</span> <span class="token function">_bluebird</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">_ref</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li></ul></li> <li><p>插件源码细节</p> <ul><li><p><code>path.node.async</code>/<code>path.node.generator</code></p> <p>关于如何识别 <code>async</code> 和 <code>*</code> 标记的函数：</p> <p><code>path.node.async: true/false</code> 可判断是否是 <code>async</code> 标记的函数。</p> <p><code>path.node.generator: true/false</code> 可判断是否是 <code>*</code> 标记的函数。</p> <blockquote><p>&quot;Babel节点集&quot; 有对 <code>path.node</code> 的详细介绍</p></blockquote></li> <li><p><code>state.methodWrapper</code></p> <p>这个方法决定了用哪种方式的&quot;协程&quot;来实现 <code>async/await</code>。<code>state</code> 对象定义在 babel-traverse 中，但并没有定义 <code>state.methodWrapper</code> 方法，笔者判断应该是一个临时的自定义方法，一旦确定，后续执行的插件逻辑会统一使用该方式定义的&quot;协程&quot;。</p> <ul><li><p>自定义方法实现&quot;协程&quot;: <code>state.addHelper(&quot;asyncToGenerator&quot;)</code></p> <p><code>state.addHelper</code> 是 <code>state.file.addHelper</code> 的快捷方式，关于 <code>state</code> 的使用方式，章节&quot;Babel插件编写&quot;有详细介绍，不再赘述。该方法会从 <code>babel-helpers</code> 模块中提取名称为 <code>asyncToGenerator</code> 的辅助代码片段，也就是上文中看到的用 <code>Promise/Generaotr</code> 实现的&quot;协程&quot;。</p></li> <li><p>第三方模块实现&quot;协程&quot;:</p> <p>TODO</p></li></ul></li></ul></li></ul></li> <li><p>babel-plugin-transform-block-scoped-functions</p> <ul><li><p>作用</p> <p>将块级作用域下的函数声明，转为函数表达式。</p></li> <li><p>目标节点</p> <ul><li><code>BlockStatement</code>: 块声明节点</li> <li><code>SwitchCase</code>: <code>switch</code> 语句的 <code>case</code> 节点</li></ul></li> <li><p>转换原理</p> <p>待转换的源码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token function">name</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">function</span> <span class="token function">name</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token function-variable function">name</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">name</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>上面的转换过程有以下特点：</p> <ul><li><p>转换过程发生在块级作用域下</p> <p>函数体(<code>function run() { /* 内容 */ }</code>)和 <code>export</code> 表达式(<code>export { /* 内容 */ }</code>)中的 <code>{ /* 内容 */ }</code> 不会发生转换。</p></li> <li><p>函数声明被转为函数表达式，以 <code>let</code> 声明</p></li> <li><p>生成的函数表达式被提升到块级作用域靠前的位置</p></li></ul></li> <li><p>插件源码细节</p> <ul><li><p><code>const { node, parent } = path;</code></p> <p><code>path</code> 节点有 <code>node</code>、<code>parent</code> 属性，二者均是 AST 节点对象，具体定义，在&quot;Babel节点集&quot;有详细介绍。</p></li> <li><p><code>t.isFunction</code>和<code>t.isExportDeclaration</code></p> <p>babel-types 提供的校验方法。</p></li> <li><p><code>path.get(key)</code></p> <p><code>path.get(key)</code> 类似于 <code>path.node[key]</code> 的写法，用于获取子节点。</p></li> <li><p><code>path.isFunctionDeclaration</code></p> <p>同 <code>t.isFunctionDeclaration</code>。</p></li> <li><p><code>t.variableDeclaration</code> / <code>t.variableDeclarator</code></p> <p>创建节点，其参数如何填写在&quot;Babel插件编写&quot;章节有详细介绍。</p></li></ul></li></ul></li> <li><p>babel-plugin-transform-block-scoping</p> <p>https://babeljs.io/docs/en/babel-plugin-transform-block-scoping</p> <ul><li><p>作用</p> <p>提供块级作用域相关的转换操作。</p></li> <li><p>插件配置</p> <ul><li><p><code>throwIfClosureRequired: boolean</code>，默认值是 <code>false</code>，表示在转译过程中，如果发现闭包的存在，转译阶段是否抛错。</p> <p>比如，源码是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><p><code>throwIfClosureRequired: false</code></p> <p>转译结果：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">_loop</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">_loop</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_loop</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>可以看到，源码中 <code>for</code> 循环中的 <code>let</code> 声明的变量 <code>i</code> 位于块级作用域，转译后，变量 <code>i</code> 的值通过值传递的方式，存储在循环中的闭包函数中。</p></li> <li><p><code>throwIfClosureRequired: true</code></p> <p>转译过程会检查是否含有闭包存在，如有，则转译报错。这对于性能要求极高的场景而言，可以减少闭包的数量，提高运行效率。</p> <p>上面待转译的源码，如果被转译是需要加上闭包的，所以在 <code>throwIfClosureRequired: true</code> 的情况下，转译过程会抛出一个语法错误：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SyntaxError: unknown: Compiling let/const in this block would add a closure (throwIfClosureRequired).
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li> <li><p><code>tdz: boolean</code>，默认是 <code>false</code>，表示在转译过程中，如果发现暂时性死区，是否在转换后的代码的运行时抛出关于暂时性死区的错误。</p> <p>比如，源码是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>i<span class="token punctuation">;</span>
<span class="token keyword">let</span> i<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>该源码含有一个暂时性死区的错误：在<code>let i</code>之前就使用了变量<code>i</code>。</p> <ul><li><p><code>tdz: false</code></p> <p>转译后的结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

i<span class="token punctuation">;</span>
<span class="token keyword">var</span> i<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p><code>tdz: true</code></p> <p>转译后的结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_tdz</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceError</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot; is not defined - temporal dead zone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token function">_tdz</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> i<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在转译时，插件如果发现存在暂时性死区相关的错误，会将 <code>_tdz</code> 方法加入转译后的代码，在运行时抛出错误。</p></li></ul></li></ul></li> <li><p>目标节点</p> <ul><li><code>VariableDeclaration</code>: 变量声明节点</li> <li><code>Loop</code>: 循环节点</li> <li><code>CatchClause</code>: <code>catch</code> 节点</li> <li><code>BlockStatement|SwitchStatement|Program</code></li></ul></li> <li><p>转换原理</p> <ul><li><p><code>VariableDeclaration</code>: 变量声明节点</p> <ul><li><p>如果变量声明没有位于块级作用域，不会处理</p></li> <li><p>将 <code>let/const</code> 的声明方式，转译为 <code>var</code></p> <p>比如：<code>{ let i; }</code> 会被转译为<code>{ var i; }</code></p> <p>而对于 <code>for...of</code>、<code>for...in</code> 循环，该插件有个特殊的处理：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">of</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> key
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 初始化 key 的值为 undefined</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以看到，变量 <code>key</code> 的值在每次循环的时候，均会被初始化为 <code>void 0</code>，也就是 <code>undefined</code>。是因为有这样的场景：</p> <p>源码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> k<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    k <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>转译后：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> k <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 如果不做值的初始化，会出现意料之外的问题</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    k <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>将位于当前块级作用域的绑定信息，移到上层最近的函数作用域或顶层作用域中</p> <p>源码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span> <span class="token comment">// 顶层作用域</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 函数作用域</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">of</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> key
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>转译时，发现当前节点的 <code>scope</code> 中含有两个绑定信息：<code>i</code>、<code>key</code>。这两个绑定信息将被挪动到当前节点上层最近的一个函数作用域或顶层作用域。</p> <p>转译结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 函数作用域</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以看到，<code>i</code>、<code>key</code> 两个变量影响的作用域在最近的一层函数作用域。</p></li></ul></li></ul></li> <li><p>插件源码细节</p> <ul><li><p><code>VariableDeclaration</code>处理逻辑</p> <ul><li><p><code>path.getBindingIdentifiers()</code></p> <p>获取和 <code>path.node</code> 节点绑定的标识符列表。&quot;Babel插件编写&quot;章节中 <code>t.getBindingIdentifiers</code> 有对该方法的详细介绍。</p></li> <li><p><code>scope.getOwnBinding(name)</code></p> <p>获取当前节点中，<code>uid</code> 为 <code>name</code> 的 <code>scope.binding</code> 对象。</p></li> <li><p><code>scope.moveBindingTo(name, parentScope)</code></p> <p>移动作用域 TODO</p></li></ul></li></ul></li></ul></li> <li><p>babel-plugin-transform-classes</p> <ul><li><p>作用</p> <p>将 <code>class</code> 转为普通函数。</p></li> <li><p>目标节点</p> <ul><li><code>ExportDefaultDeclaration</code>: 默认导出声明节点，且针对 <code>class</code> 声明，如 <code>export default class E {}</code></li> <li><code>ClassDeclaration</code>: 类声明节点，如 <code>class [name] [extends] {[body]}</code></li> <li><code>ClassExpression</code>: 类表达式，如 <code>const MyClass = class [className] [extends otherClassName] { ... }</code></li></ul></li> <li><p>转换原理</p> <ul><li><p><code>ClassDeclaration</code></p> <p>针对类的声明转换。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot call a class as a function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> Test <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Test</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">logger</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> Test<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>可以看到，<code>class</code> 被转为了普通函数，且赋值给变量 <code>Test</code>。</p> <p>同时要求 <code>class</code> 不能被直接作为普通函数调用。通过在普通函数运行时，判断当前 <code>this</code> 的值是否是 <code>Test</code> 的实例，判断类是否被作为普通函数调用。</p></li> <li><p><code>ExportDefaultDeclaration</code></p> <p>针对 <code>export default {类}</code> 形式使用的 <code>class</code> 节点。</p> <p>这部分处理逻辑需要和 <code>ClassDeclaration</code> 配合使用，<code>ClassDeclaration</code> 处理函数将 <code>class</code> 类转为普通函数的形式，<code>ExportDefaultDeclaration</code> 处理函数负责处理 <code>export default</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">E</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>转译结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 校验类 E 是否被直接调用，如 E()</span>
<span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot call a class as a function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token function-variable function">E</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token constant">E</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">E</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> <span class="token constant">E</span> <span class="token keyword">as</span> <span class="token keyword">default</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p><code>ClassExpression</code></p> <p>类表达式处理逻辑，如 <code>const MyClass = class [className] [extends otherClassName] { ... }</code>。</p> <p>有两种形式的源码：</p> <p>其一，只有类定义表达式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> MyClass <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>转译结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot call a class as a function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">MyClass</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">MyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> MyClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>其二，含类定义表达式，并立即执行：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">class</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>转译结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot call a class as a function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token comment">/*#__PURE__*/</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">_class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> _class<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> _class<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>其中，<code>class</code> 类先转为箭头函数，然后转为普通函数。</p></li></ul></li></ul></li> <li><p>babel-plugin-transform-computed-properties</p> <ul><li><p>作用</p> <p>该插件会转译计算属性。</p> <p>举例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token string">&quot;x&quot;</span> <span class="token operator">+</span> foo<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&quot;heh&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">&quot;y&quot;</span> <span class="token operator">+</span> bar<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&quot;noo&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _obj<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">value</span><span class="token operator">:</span> value<span class="token punctuation">,</span>
            <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">(</span>
    _obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">_defineProperty</span><span class="token punctuation">(</span>_obj<span class="token punctuation">,</span> <span class="token string">&quot;x&quot;</span> <span class="token operator">+</span> foo<span class="token punctuation">,</span> <span class="token string">&quot;heh&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">_defineProperty</span><span class="token punctuation">(</span>_obj<span class="token punctuation">,</span> <span class="token string">&quot;y&quot;</span> <span class="token operator">+</span> bar<span class="token punctuation">,</span> <span class="token string">&quot;noo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">_defineProperty</span><span class="token punctuation">(</span>_obj<span class="token punctuation">,</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">_defineProperty</span><span class="token punctuation">(</span>_obj<span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    _obj
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div></li> <li><p>目标节点</p> <p><code>ObjectExpression</code>: Object表达式节点。</p></li> <li><p>原理</p> <ul><li><p><code>_defineProperty</code></p> <p>该方法负责设置对象属性，内部优先使用 <code>Object.defineProperty</code> 方法，其次直接通过 <code>obj[key] = value</code> 设置。</p></li> <li><p>用逗号运算符在进行一系列计算后返回目标值</p> <p>用逗号运算符完成变量的定义、初始化等一系列操作后，再返回变量值，是一个可以借鉴的技巧。</p></li></ul></li></ul></li> <li><p>babel-plugin-transform-destructuring</p> <ul><li><p>作用</p> <p>该插件实现对解构的转译。</p></li> <li><p>目标节点</p> <ul><li><p><code>ExportNamedDeclaration</code>: 导出具名声明</p> <p>如: <code>export const [a, b, ...rest] = [10, 20, 30, 40, 50]</code>。</p></li> <li><p><code>ForXStatement</code></p> <p><code>ForXStatement</code> 是一个别名，包括 <code>ForInStatement</code>、<code>ForOfStatement</code>。</p> <p>如：<code>for ({ length: k } in { abc: 3 }) {}</code>。</p></li> <li><p><code>CatchClause</code>: <code>catch</code>从句。</p> <p>如：<code>try { } catch(...) { ... }</code> 中的 <code>catch(...) {...}</code> 部分。</p></li> <li><p><code>AssignmentExpression</code>: 赋值表达式</p> <p>如：<code>[ nums[1], nums[0] ] = [ nums[0], nums[1] ]</code>。</p></li> <li><p><code>VariableDeclaration</code>: 变量声明</p> <p>如：<code>const { k } = { k: 1 }</code></p></li></ul></li> <li><p>原理</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>插件要做的事情，就是将上述类型的解构写法，转译为普通的赋值写法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> _obj <span class="token operator">=</span> obj<span class="token punctuation">,</span>
    x <span class="token operator">=</span> _obj<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
    y <span class="token operator">=</span> _obj<span class="token punctuation">.</span>y<span class="token punctuation">;</span>

<span class="token keyword">let</span> _arr <span class="token operator">=</span> arr<span class="token punctuation">,</span>
    _arr2 <span class="token operator">=</span> <span class="token function">_toArray</span><span class="token punctuation">(</span>_arr<span class="token punctuation">)</span><span class="token punctuation">,</span>
    a <span class="token operator">=</span> _arr2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    b <span class="token operator">=</span> _arr2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    rest <span class="token operator">=</span> _arr2<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>对于各个目标节点，转换过程分别如下：</p> <ul><li><p><code>ExportNamedDeclaration</code></p> <p>如：<code>export const [a, b, ...rest] = [10, 20, 30, 40, 50]</code></p> <p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
    b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span>
    rest <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> rest <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>TODO</p></li> <li><p><code>ForXStatement</code></p> <p>如：<code>for ({ length: k } in { abc: 3 }) {}</code></p> <p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> _ref <span class="token keyword">in</span> <span class="token punctuation">{</span> <span class="token literal-property property">abc</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    k <span class="token operator">=</span> _ref<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p><code>CatchClause</code></p> <p>如：<code>try { } catch({ message }) {}</code></p> <p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>_ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> message <span class="token operator">=</span> _ref<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><code>AssignmentExpression</code></p> <p>如：<code>[ nums[1], nums[0] ] = [ nums[0], nums[1] ]</code></p> <p>数组交换的写法，会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _ref <span class="token operator">=</span> <span class="token punctuation">[</span>nums<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nums<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    nums<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> _ref<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    nums<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> _ref<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    _ref<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p><code>VariableDeclaration</code></p> <p>如: <code>const { ...a } = b;</code></p> <p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_extends</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    _extends <span class="token operator">=</span> Object<span class="token punctuation">.</span>assign <span class="token operator">||</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">var</span> source <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> 
                <span class="token punctuation">}</span> 
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span> 
        
        <span class="token keyword">return</span> target<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">;</span> 
    
    <span class="token keyword">return</span> <span class="token function">_extends</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">const</span> _b <span class="token operator">=</span> b<span class="token punctuation">,</span>
    a <span class="token operator">=</span> <span class="token function">_extends</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> _b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 复制 _b</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>可以看到，在转换的实现上，有以下细节：</p> <ul><li>优先使用 <code>Object.assign</code>，其次自行实现 <code>extends</code></li> <li>自行实现中，<code>for...in</code> 遍历源对象，会引入原型链上的属性，利用 <code>Object.prototype.hasOwnProperty</code> 过滤掉原型链上的属性</li></ul></li></ul></li></ul></li> <li><p>babel-plugin-transform-dotall-regex</p> <ul><li><p>作用</p> <p>转换正则表达式的dotAll(<code>s</code>)标志。</p></li> <li><p>目标节点</p> <p><code>RegExpLiteral</code>: 曾泽表达式字面量。</p></li> <li><p>原理</p> <p>babel/packages/babel-helper-create-regexp-features-plugin/src/index.js</p> <p>截至目前，Babel 支持的正则标志有如下几个：<code>&quot;i&quot; | &quot;g&quot; | &quot;m&quot; | &quot;s&quot; | &quot;u&quot; | &quot;y&quot;</code>。</p> <p>内部实现上，该插件依赖 <code>regexpu-core</code> 对正则写法进行转换。</p> <p>https://www.npmjs.com/package/regexpu-core</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-transform-duplicate-keys</p> <ul><li><p>作用</p> <p>转译对象中重复的 key。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>配合插件 babel-plugin-transform-computed-properties，上述代码将被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> value<span class="token punctuation">,</span> <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">5</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p>目标节点</p> <p><code>ObjectExpression</code>: Object表达式。</p></li> <li><p>原理</p> <p>从转换后的代码可以看到，<code>var x = { a: 5, a: 6 };</code> 在转译后，相当于为对象 <code>{ a: 5 }</code> 重新设置 <code>a</code> 的值为 6。</p></li></ul></li> <li><p>babel-plugin-transform-exponentiation-operator</p> <ul><li><p>作用</p> <p>转换取幂运算符 <code>**</code>。</p> <p>如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">;</span>
x <span class="token operator">**=</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> x <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
x <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>AssignmentExpression</code>: 赋值表达式</li> <li><code>BinaryExpression</code>: 二元运算表达式</li></ul></li> <li><p>原理</p> <p>这个转化过程比较直白，就是用 <code>Math.pow</code> 替代 <code>**</code>。</p></li></ul></li> <li><p>babel-plugin-transform-flow-comments</p> <p>TODO</p></li> <li><p>babel-plugin-transform-flow-strip-types</p> <p>TODO</p></li> <li><p>babel-plugin-transform-for-of</p> <ul><li><p>作用</p> <p>转换 <code>for...of</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// _createForOfIteratorHelper 定义</span>
<span class="token keyword">function</span> <span class="token function">_createForOfIteratorHelper</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> _iterator <span class="token operator">=</span> <span class="token function">_createForOfIteratorHelper</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span>
    _step<span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>_iterator<span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span><span class="token punctuation">(</span>_step <span class="token operator">=</span> _iterator<span class="token punctuation">.</span><span class="token function">n</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>done<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> key <span class="token operator">=</span> _step<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _iterator<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    _iterator<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li> <li><p>目标节点</p> <p><code>ForOfStatement</code>: <code>for...of</code> 语句。</p></li> <li><p>原理</p> <p><code>for...of</code> 会被转译为 <code>for</code> 循环，同时因为 <code>for...of</code> 支持 <code>generator</code> 对象，这里做了特殊处理。TODO</p></li></ul></li> <li><p>babel-plugin-transform-function-name</p> <ul><li><p>作用</p> <p>为 <code>function</code> 添加名称。</p> <p>比如:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token function-variable function">number</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token function-variable function">number</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">number</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>Function</code>: 函数节点</li> <li><code>ObjectProperty</code>: 对象属性节点</li></ul></li> <li><p>原理</p> <ul><li><p><code>ObjectProperty</code> 处理逻辑</p> <p>为作为对象属性的匿名函数添加名称。</p></li> <li><p><code>Function</code> 处理逻辑</p> <p>先排除该函数是对象的属性，然后为匿名函数添加名称。</p></li></ul></li></ul></li> <li><p>babel-plugin-transform-instanceof</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>foo <span class="token keyword">instanceof</span> <span class="token class-name">Bar</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_instanceof</span><span class="token punctuation">(</span><span class="token parameter">left<span class="token punctuation">,</span> right</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        right <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">typeof</span> Symbol <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">&amp;&amp;</span>
        right<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>hasInstance<span class="token punctuation">]</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> right<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>hasInstance<span class="token punctuation">]</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> left <span class="token keyword">instanceof</span> <span class="token class-name">right</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">_instanceof</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> Bar<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li> <li><p>目标节点</p> <p><code>BinaryExpression</code>: 二元运算表达式节点。</p></li> <li><p>原理</p> <p>当对象 <code>foo</code> 使用 <code>instanceof</code> 判断是否为另一个对象 <code>Foo</code> 的实例时，会调用对象 <code>b</code> 的内置方法 <code>Symbol.hasInstance</code>，也就是说，<code>foo instanceof Foo</code> 在运行的时候，实际调用的是 <code>Foo[Symbol.instanceof](foo)</code>。</p> <p>那么，Babel在转换代码时，会优先使用 <code>Bar[Symbol.hasInstance](foo)</code>，如环境不支持，降级为直接调用 <code>instanceof</code>。</p></li></ul></li> <li><p>babel-plugin-transform-jscript</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">return</span> bar<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>目标节点</p> <p>TODO</p></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-transform-literals</p> <ul><li><p>作用</p> <p>转换字面量。</p> <p>举例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">0b11</span><span class="token punctuation">;</span> <span class="token comment">// binary integer literal</span>
<span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token number">0o7</span><span class="token punctuation">;</span> <span class="token comment">// octal integer literal</span>
<span class="token keyword">const</span> u <span class="token operator">=</span> <span class="token string">&quot;Hello\u{000A}\u{0009}!&quot;</span><span class="token punctuation">;</span> <span class="token comment">// unicode string literals, newline and tab</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// binary integer literal</span>
<span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">// octal integer literal</span>
<span class="token keyword">const</span> u <span class="token operator">=</span> <span class="token string">&quot;Hello\n\t!&quot;</span><span class="token punctuation">;</span> <span class="token comment">// unicode string literals, newline and tab</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>NumericLiteral</code>: 数字字面量</li> <li><code>StringLiteral</code>: 字符串字面量</li></ul></li> <li><p>原理</p> <p>该插件的写法和babel-generator有配合的关系，插件中识别：</p> <ul><li><code>/^0[ob]/i.test(node.extra.raw)</code> 为 <code>true</code> 的 <code>NumericLiteral</code> 节点</li> <li><code>/\\[u]/gi.test(node.extra.raw)</code>为 <code>true</code> 的 <code>StringLiteral</code> 节点</li></ul> <p>然后设置该节点 <code>node.extra = undefined</code>。</p> <p>在重新生成代码的 babel-generator中，<code>babel/packages/babel-generator/src/generators/types.ts</code> 文件针对不同类型的节点有不同的处理，其中 <code>NumericLiteral</code>、<code>StringLiteral</code> 节点在重新生成代码字符串时，会判断 <code>node.raw</code> 是否非空，决定是否使用 <code>node.value</code> 的值。</p></li></ul></li> <li><p>babel-plugin-transform-member-expression-literals</p> <ul><li><p>作用</p> <p>成员表达式中，如果名称为关键词的话，会被转为字符串形式的成员。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>obj<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token string">&quot;isValid&quot;</span><span class="token punctuation">;</span>

obj<span class="token punctuation">.</span>const <span class="token operator">=</span> <span class="token string">&quot;isKeyword&quot;</span><span class="token punctuation">;</span>
obj<span class="token punctuation">[</span><span class="token string">&quot;var&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;isKeyword&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>obj<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token string">&quot;isValid&quot;</span><span class="token punctuation">;</span>

obj<span class="token punctuation">[</span><span class="token string">&quot;const&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;isKeyword&quot;</span><span class="token punctuation">;</span>
obj<span class="token punctuation">[</span><span class="token string">&quot;var&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;isKeyword&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>目标节点</p> <p><code>MemberExpression</code>: 成员表达式节点</p></li> <li><p>原理</p> <p>对于 <code>MemberExpression</code> 节点，如果成员表达式满足如下条件：</p> <ul><li>非计算属性</li> <li>是标识符</li> <li>非ES3的标识符</li></ul> <p>会将属性修改为字符串形式的计算属性。</p></li></ul></li> <li><p>babel-plugin-transform-modules-amd</p> <ul><li><p>作用</p> <p>将 <code>import/export</code> 表达式，转译为 amd 格式。</p> <p>举例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token number">42</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;exports&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>_exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _default <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
    _exports<span class="token punctuation">.</span>default <span class="token operator">=</span> _default<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>CallExpression</code>: 函数调用表达式</li> <li><code>Program</code>: 根节点</li></ul></li> <li><p>原理</p> <p>该转换插件通过对 <code>Program</code> 节点和 <code>CallExpression</code> 节点的转换，配合实现转换目标。</p> <p>比如，待转换的源码为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">run</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./module'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>转译结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;require&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_require</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">_getRequireWildcardCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_interopRequireWildcard</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

    <span class="token function">run</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_resolve<span class="token punctuation">,</span> _reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">_require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./module'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token parameter">imported</span> <span class="token operator">=&gt;</span> <span class="token function">_resolve</span><span class="token punctuation">(</span><span class="token function">_interopRequireWildcard</span><span class="token punctuation">(</span>imported<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _reject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>待转换的源码有两种函数：普通函数调用 <code>run()</code> 和动态 <code>import</code> 调用。</p> <p>转换后的结果有以下特点：</p> <ul><li>新增了 <code>define</code> 的调用模块，这是amd模块的典型特征</li> <li><code>run(1 + 1)</code> 并没有改变</li> <li><code>import('./module')</code> 被转译为 <code>Promise</code> 调用，同时新增了一些辅助函数</li></ul> <p>基于此，插件的转换逻辑为：</p> <ul><li>针对 <code>CallExpression</code> 节点，只解析动态 <code>import()</code> 函数调用；额外地，需要引入 babel-plugin-proposal-dynamic-import 以支持动态 <code>import</code> 代码的转换</li> <li>针对 <code>Program</code> 节点，在节点访问的 <code>exit</code> 阶段，对 <code>Program</code> 进行改造，提供 <code>define()</code> 调用</li></ul></li></ul></li> <li><p>babel-plugin-transform-modules-commonjs</p> <ul><li><p>作用</p> <p>将 <code>import/export</code> 表达式，转译为 commonjs 格式。</p> <p>举例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token number">42</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> _default <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>default <span class="token operator">=</span> _default<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>CallExpression</code>: 函数调用</li> <li><code>Program</code> 节点的 <code>exit</code> 时刻</li></ul></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-transform-modules-systemjs</p> <ul><li><p>作用</p> <p>将 <code>import/export</code> 表达式，转译为 systemjs 格式。</p> <p>举例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token number">42</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>System<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_export<span class="token punctuation">,</span> _context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">setters</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">_export</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>对于动态 <code>import</code>，如 <code>import('./lazy.js').then(m =&gt; ...)</code>，需要先开启 <code>babel-plugin-proposal-dynamic-import</code>。</p></li> <li><p>目标节点</p> <p>TODO</p></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-transform-modules-umd</p> <ul><li><p>作用</p> <p>将 <code>import/export</code> 表达式，转译为 umd 格式。</p> <p>举例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token number">42</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">global<span class="token punctuation">,</span> factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;exports&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> exports <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">factory</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> mod <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">factory</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
        global<span class="token punctuation">.</span>unknown <span class="token operator">=</span> mod<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> globalThis <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">?</span> globalThis <span class="token operator">:</span> <span class="token keyword">typeof</span> self <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">?</span> self <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>_exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _default <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
    _exports<span class="token punctuation">.</span>default <span class="token operator">=</span> _default<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></li> <li><p>目标节点</p> <p>TODO</p></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-transform-named-capturing-groups-regex</p> <p>TODO</p></li> <li><p>babel-plugin-transform-new-target</p> <ul><li><p>作用</p> <p>转换 <code>new.target</code> 表达式。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; undefined</span>
<span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; Foo</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Foo</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>constructor <span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; undefined</span>

<span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; Foo</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>目标节点</p> <p><code>MetaProperty</code>: 元属性节点，即 <code>new.target</code>。</p></li> <li><p>原理</p> <p>代码被转译为，当 <code>Foo</code> 运行时的 <code>this</code> 是 <code>Foo</code> 的实例的话，<code>new.target</code> 会返回构造器 <code>Foo</code>，否则返回 <code>undefined</code>。</p></li></ul></li> <li><p>babel-plugin-transform-object-assign</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_extends</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    _extends <span class="token operator">=</span>  Object<span class="token punctuation">.</span>assign 
                <span class="token operator">||</span> 
                <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                        <span class="token keyword">var</span> source <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                                target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> 
                            <span class="token punctuation">}</span> 
                        <span class="token punctuation">}</span> 
                    <span class="token punctuation">}</span> 
                    
                    <span class="token keyword">return</span> target<span class="token punctuation">;</span> 
                <span class="token punctuation">}</span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> <span class="token function">_extends</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token function">_extends</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></li> <li><p>目标节点</p> <p><code>CallExpression</code>: 函数调用表达式。</p></li> <li><p>原理</p> <p>转换后，会优先用 <code>Object.assign</code>，其次自行实现一个 <code>extend</code> 方法，用循环赋值模拟。</p></li></ul></li> <li><p>babel-plugin-transform-object-set-prototype-of-to-assign</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>bar<span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_defaults</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> defaults</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">var</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>defaults<span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">var</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
        <span class="token keyword">var</span> value <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>defaults<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>configurable <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token function">_defaults</span><span class="token punctuation">(</span>bar<span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>Object.setPrototypeOf(obj, prototype)</code> 是 ECMAScript 6之后提出的的新方法，相对于 <code>obj.__proto__ = prototype</code> 这种非标准写法，它被认为是修改对象原型更合适的方法。</p></li> <li><p>目标节点</p> <p><code>CallExpression</code>: 函数调用表达式。</p></li> <li><p>原理</p> <p>该插件源码比较简单：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;callee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matchesPattern</span><span class="token punctuation">(</span><span class="token string">&quot;Object.setPrototypeOf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>callee <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">addHelper</span><span class="token punctuation">(</span><span class="token string">&quot;defaults&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果是 <code>Object.setPrototypeOf</code> 方法的调用，则将该调用替换为 <code>_defaults</code> 方法的调用，<code>_defaults</code> 方法来自辅助模块（babel-helpers、babel-runtime/helpers、babel-runtime-corejs2/helpers、babel-runtime-corejs3/helpers）。</p> <p><code>_defaults</code> 方法内部将 <code>Object.setPrototypeOf(bar, foo);</code> 中的 <code>foo</code> 上的属性直接给了 <code>bar</code> 对象（如果 <code>bar</code> 对象上没有该属性的话）。</p> <p>当然也有其他实现，比如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Object<span class="token punctuation">.</span>setPrototypeOf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 仅适用于Chrome和FireFox，在IE中不工作：</span>
    <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setPrototypeOf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> proto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>__proto__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            obj<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> proto<span class="token punctuation">;</span>
            <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果你想返回 prototype of Object.create(null):</span>
            <span class="token keyword">var</span> <span class="token function-variable function">Fn</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                        <span class="token literal-property property">value</span><span class="token operator">:</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token class-name">Fn</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> proto<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li></ul></li> <li><p>babel-plugin-transform-object-super</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;World!&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_get</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">_getPrototypeOf</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> _obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">say</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">_get</span><span class="token punctuation">(</span><span class="token function">_getPrototypeOf</span><span class="token punctuation">(</span>_obj<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;say&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;World!&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>目标节点</p> <p><code>ObjectExpression</code>: 对象表达式。</p></li> <li><p>原理</p> <p>从转换后的结果来看，针对 <code>super.say()</code> 类的调用，babel-plugin-transform-object-super 将其转为了<code>_get(_getPrototypeOf(_obj), &quot;say&quot;, this).call(this)</code>。</p> <p>这里又定义了一个变量 <code>_obj</code>，应该是为了防止 <code>say()</code> 执行时，<code>obj</code> 被修改而设置的缓存变量。</p></li></ul></li> <li><p>babel-plugin-transform-parameters</p> <ul><li><p>作用</p> <p>该插件会处理参数的转换。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> a<span class="token punctuation">,</span> b <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>
        a<span class="token punctuation">,</span>
        b
    <span class="token punctuation">}</span> <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> _len <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>_len <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">?</span> _len <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _key <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> _key <span class="token operator">&lt;</span> _len<span class="token punctuation">;</span> _key<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        args<span class="token punctuation">[</span>_key <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> arguments<span class="token punctuation">[</span>_key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li> <li><p>目标节点</p> <p><code>Function</code>: 函数。</p></li> <li><p>原理</p> <p>针对 <code>Function</code>节点，且有 <code>rest</code> 和 <code>assignmentPattern</code> 类型的参数时，做转换操作。</p> <p>在满足上述条件时，针对箭头函数做特殊处理，箭头函数内不能使用 <code>arguments</code> 获取运行时的参数，需要先将箭头函数转为普通函数表达式。</p> <p>如果是 <code>rest</code> 类型的节点，会识别目标参数名称，生成数组对其赋值。</p> <p>如果是 <code>assignmentPattern</code> 类型的，也就是有默认值的参数，会在运行时优先使用传入的新值，否则使用默认值。</p></li></ul></li> <li><p>babel-plugin-transform-property-literals</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// changed</span>
    <span class="token function-variable function">const</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">var</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>

    <span class="token comment">// not changed</span>
    <span class="token number">1</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// changed</span>
    <span class="token string-property property">&quot;const&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;var&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>

    <span class="token comment">// not changed</span>
    <span class="token number">1</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>目标节点</p> <p><code>ObjectProperty</code>: 对象属性节点。</p></li> <li><p>原理</p> <p>源码也比较简单，针对满足如下条件的 <code>ObjectProperty</code> 节点：</p> <ul><li>非计算属性</li> <li>标识符</li> <li>ES3中的保留字</li></ul> <p>会将这些属性节点转为字符串形式的节点。</p></li></ul></li> <li><p>babel-plugin-transform-property-mutators</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_bar<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_bar <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_bar<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_bar <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p>目标节点</p> <p><code>ObjectExpression</code>: 对象表达式。</p></li> <li><p>原理</p> <p>针对对象表达式节点，每个属性(<code>property</code>)均有一个kind属性，标记 <code>get/set</code> 等类型信息。</p> <p>对于含这些信息的节点做转换处理，有以下特点：</p> <ul><li>创建一个对象</li> <li>对象上设置属性bar</li> <li>用 <code>Object.defineProperty</code> 设置属性bar的描述信息</li></ul></li></ul></li> <li><p>babel-plugin-transform-proto-to-assign</p> <ul><li><p>作用</p> <p>将非标准用法 <code>__proto__</code> 转为 <code>assign</code> 式的写法。</p> <p>以下案例来自Babel官网：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
bar<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> foo<span class="token punctuation">;</span>
bar<span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// 1</span>
bar<span class="token punctuation">.</span>b<span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>转译结果：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_defaults</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> defaults</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">var</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>defaults<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">var</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> 
        <span class="token keyword">var</span> value <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>defaults<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>configurable <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">_defaults</span><span class="token punctuation">(</span>bar<span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span>

bar<span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// 1</span>

bar<span class="token punctuation">.</span>b<span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>AssignmentExpression</code>: 赋值表达式</li> <li><code>ExpressionStatement</code>: 表达式语句</li> <li><code>ObjectExpression</code>: 对象表达式</li></ul></li> <li><p>原理</p> <p><code>Object.getOwnPropertyNames()</code> 方法返回一个由指定对象的所有自身可枚举和不可枚举属性的属性名（不包括 <code>Symbol</code> 值作为名称的属性）组成的数组。</p> <p>从转换后的代码可以看出：</p> <ul><li>会遍历 <code>foo</code> 节点所有可枚举和不可枚举的属性</li> <li>如果 <code>obj</code> 没有 <code>foo</code> 中的属性，会将 <code>foo</code> 该属性的描述符设置到 <code>obj</code> 的该属性上</li></ul> <p>也就是说，转换后，<code>obj</code> 自身会具备 <code>foo</code> 上的属性。</p></li></ul></li> <li><p>babel-plugin-transform-react-constant-elements</p></li> <li><p>babel-plugin-transform-react-display-name</p></li> <li><p>babel-plugin-transform-react-inline-elements</p></li> <li><p>babel-plugin-transform-react-jsx</p></li> <li><p>babel-plugin-transform-react-jsx-compat</p></li> <li><p>babel-plugin-transform-react-jsx-development</p></li> <li><p>babel-plugin-transform-react-jsx-self</p></li> <li><p>babel-plugin-transform-react-jsx-source</p></li> <li><p>babel-plugin-transform-react-pure-annotations</p></li> <li><p>babel-plugin-transform-regenerator</p> <ul><li><p>作用</p> <p>以下案例来自 Babel 官网：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _marked <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span>regeneratorRuntime<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> regeneratorRuntime<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">a$</span><span class="token punctuation">(</span><span class="token parameter">_context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>_context<span class="token punctuation">.</span>prev <span class="token operator">=</span> _context<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
            _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token string">&quot;end&quot;</span><span class="token operator">:</span>
            <span class="token keyword">return</span> _context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> _marked<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li> <li><p>目标节点</p> <p>TODO</p></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-transform-reserved-words</p> <ul><li><p>作用</p> <p>该插件针对转换目标要求兼容 ES3 的场景，ES3 中有一些保留字，在 ES5 及后续版本并非保留字了，该插件识别出这些保留字，对其重命名，避免 ES3 环境中运行出现问题。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> abstract <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> x <span class="token operator">=</span> abstract <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _abstract <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> x <span class="token operator">=</span> _abstract <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>BindingIdentifier</code>: TODO</li> <li><code>ReferencedIdentifier</code>: TODO</li></ul></li> <li><p>原理</p> <p>对于 <code>BindingIdentifier</code> 和 <code>ReferencedIdentifier</code> 节点，如果是 ES3 中定义的关键词，会对其重命名。</p> <p>ES3 的未来保留字如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>abstract <span class="token operator">/</span> <span class="token keyword">enum</span> <span class="token operator">/</span> int <span class="token operator">/</span> short <span class="token operator">/</span> boolean <span class="token operator">/</span> <span class="token keyword">export</span> <span class="token operator">/</span> <span class="token keyword">interface</span> <span class="token operator">/</span> <span class="token keyword">static</span> <span class="token operator">/</span> byte <span class="token operator">/</span> <span class="token keyword">extends</span> <span class="token operator">/</span> long <span class="token operator">/</span> <span class="token keyword">super</span> <span class="token operator">/</span> char <span class="token operator">/</span> final <span class="token operator">/</span> native <span class="token operator">/</span> synchronized <span class="token operator">/</span> <span class="token keyword">class</span> <span class="token operator">/</span> float <span class="token operator">/</span> <span class="token keyword">package</span> <span class="token operator">/</span> throws <span class="token operator">/</span> <span class="token keyword">const</span> <span class="token operator">/</span> goto <span class="token operator">/</span> <span class="token keyword">private</span> <span class="token operator">/</span> transient <span class="token operator">/</span> <span class="token keyword">debugger</span> <span class="token operator">/</span> <span class="token keyword">implements</span> <span class="token operator">/</span> <span class="token keyword">protected</span> <span class="token operator">/</span> volatile <span class="token operator">/</span> double <span class="token operator">/</span> <span class="token keyword">import</span> <span class="token operator">/</span> <span class="token keyword">public</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li> <li><p>babel-plugin-transform-runtime</p> <p>TODO</p></li> <li><p>babel-plugin-transform-shorthand-properties</p> <ul><li><p>作用</p> <p>转换对象属性简写。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span> 
    a<span class="token punctuation">,</span> 
    <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span> a<span class="token punctuation">,</span>
    <span class="token function-variable function">b</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>ObjectMethod</code>: 对象的方法</li> <li><code>ObjectProperty</code>: 对象的属性</li></ul></li> <li><p>原理</p> <p>对象的方法和属性，均有简写式写法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span> 
    a<span class="token punctuation">,</span> 
    <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在转换对象的简写方法时，会创建一个普通的函数表达式替代，并设置各种原来具备的属性。</p> <p>在转换对象的简写属性时，会转译为非简写写法。</p></li></ul></li> <li><p>babel-plugin-transform-spread</p> <ul><li><p>作用</p> <p>转换扩展运算符。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>a<span class="token punctuation">,</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token operator">...</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>ArrayExpression</code>: 数组表达式</li> <li><code>CallExpression</code>: 函数调用表达式</li> <li><code>NewExpression</code>: <code>new</code> 表达式</li></ul></li> <li><p>原理</p> <ul><li><p>对<code>ArrayExpression</code>的处理</p> <p>如：<code>[...a, &quot;foo&quot;];</code></p> <p>对于这样的数组表达式，内部实现上有这样的逻辑：</p> <ul><li><p>如果 <code>a</code> 数组只有一个元素，则直接 <code>...a</code> 替换为 <code>a[0]</code>，不再用 <code>concat</code> 这种相对“重”的操作</p></li> <li><p>如果 <code>a</code> 是一个数组表达式，则转译为 <code>a.concat([&quot;foo&quot;])</code></p></li> <li><p>如果 <code>a</code> 不是一个数组表达式，比如 <code>[...{}, &quot;foo&quot;];</code>，会被转译为 <code>[].concat(_toConsumableArray({}), [&quot;foo&quot;]);</code></p> <p><code>_toConsumableArray</code> 详解TODO</p></li></ul></li> <li><p>对<code>CallExpression</code>的处理</p> <p>如：<code>var c = foo(...a);</code></p> <p>函数调用表达式中参数含有扩展符的话，最终被转译为 <code>foo.apply</code> 式调用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>对 <code>NewExpression</code> 的处理</p> <p><code>NewExpression</code> 就是 <code>new</code> 表达式，如 <code>new Date(...params)</code>。</p> <p>该表达式中的扩展运算符转译操作不能简单的使用 <code>apply</code> 进行，因为 <code>apply</code> 只是执行方法，而缺少 <code>new</code> 的操作。</p> <p>插件对 <code>new Date(...params)</code> 的转译结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_construct</span><span class="token punctuation">(</span><span class="token parameter">Parent<span class="token punctuation">,</span> args<span class="token punctuation">,</span> Class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_isNativeReflectConstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _construct <span class="token operator">=</span> Reflect<span class="token punctuation">.</span>construct<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">_construct</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">_construct</span><span class="token punctuation">(</span><span class="token parameter">Parent<span class="token punctuation">,</span> args<span class="token punctuation">,</span> Class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">null</span><span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">var</span> Constructor <span class="token operator">=</span> Function<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>Parent<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">var</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Class<span class="token punctuation">)</span> <span class="token function">_setPrototypeOf</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            
            <span class="token keyword">return</span> instance<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">return</span> <span class="token function">_construct</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>     
<span class="token punctuation">}</span>

<span class="token function">_construct</span><span class="token punctuation">(</span>Date<span class="token punctuation">,</span> <span class="token function">_toConsumableArray</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>TODO，详解</p></li></ul></li></ul></li> <li><p>babel-plugin-transform-sticky-regex</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">o+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">y</span></span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">&quot;o+&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>目标节点</p> <p><code>RegExpLiteral</code>: 正则字面量。</p></li> <li><p>原理</p> <p>针对 <code>RegExpLiteral</code> 节点中含有 <code>y</code> 的flag的，会转译为 <code>RegExp</code> 实例式写法：<code>new RegExp(xx, 'y')</code>。</p></li></ul></li> <li><p>babel-plugin-transform-strict-mode</p> <ul><li><p>作用</p> <p>添加严格模式指令。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>目标节点</p> <p><code>Program</code>: 根节点。</p></li> <li><p>原理</p> <p>遍历 <code>Program</code> 的指令中是否含有 <code>&quot;use strict&quot;</code>，如果没有，向节点的指令数组中添加 <code>&quot;use strict&quot;</code> 指令。</p></li></ul></li> <li><p>babel-plugin-transform-template-literals</p> <ul><li><p>作用</p> <p>转换模板字符串。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">foo</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>bar<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;foo&quot;</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>目标节点</p> <ul><li><p><code>TaggedTemplateExpression</code></p> <p>带标签的模板字符串表达式。</p> <p>比如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">tagFunc</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> args<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> setting <span class="token operator">=</span> <span class="token string">'dark mode'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> str <span class="token operator">=</span> tagFunc<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Setting </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> setting <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> value <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p><code>TemplateLiteral</code></p> <p>模板字面量，如 <code>Hello ${name}</code>。</p></li></ul></li> <li><p>原理</p> <ul><li><p><code>TaggedTemplateExpression</code></p> <p>源码：<code>tagFunc\</code>Setting ${ setting } is ${ value }!`;`</p> <p>转译后的结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_taggedTemplateLiteral</span><span class="token punctuation">(</span><span class="token parameter">strings<span class="token punctuation">,</span> raw</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>raw<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        raw <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>strings<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">raw</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">value</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">tagFunc</span><span class="token punctuation">(</span>
    <span class="token function">_taggedTemplateLiteral</span><span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token string">&quot;Setting &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; is &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;!&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    setting<span class="token punctuation">,</span> 
    value
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>可以看到，带标签的模板字符串被转译为了 <code>tagFunc</code> 的函数调用，并且调用的参数依次是：</p> <ul><li><p>带有属性 <code>raw</code> 的数组 <code>[&quot;Setting &quot;, &quot; is &quot;, &quot;!&quot;]</code></p> <p>TODO</p></li> <li><p><code>setting</code> 的值</p></li> <li><p><code>value</code> 的值</p></li></ul></li> <li><p><code>TemplateLiteral</code></p> <p>源码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token string">'world'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>\`Hello \$<span class="token punctuation">{</span>content<span class="token punctuation">}</span>\`<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>转译后的结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token string">'world'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul></li></ul></li> <li><p>babel-plugin-transform-typeof-symbol</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">typeof</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;symbol&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_typeof</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token string">&quot;@babel/helpers - typeof&quot;</span><span class="token punctuation">;</span> 
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Symbol <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Symbol<span class="token punctuation">.</span>iterator <span class="token operator">===</span> <span class="token string">&quot;symbol&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function-variable function">_typeof</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        <span class="token function-variable function">_typeof</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">return</span> obj <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Symbol <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Symbol <span class="token operator">&amp;&amp;</span> obj <span class="token operator">!==</span> <span class="token class-name">Symbol</span><span class="token punctuation">.</span>prototype <span class="token operator">?</span> <span class="token string">&quot;symbol&quot;</span> <span class="token operator">:</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">return</span> <span class="token function">_typeof</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>     
<span class="token punctuation">}</span>

<span class="token function">_typeof</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;symbol&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>Scope</code>: 作用域节点</li> <li><code>UnaryExpression</code>: 一元表达式</li></ul></li> <li><p>原理</p> <ul><li><p><code>Scope</code></p> <p>该处理逻辑关注作用域中是否含有 <code>Symbol</code> 的绑定信息，如 <code>const Symbol = xxx</code> 这样的变量定义，如有，对其重命名。</p> <p>例如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">Symbol</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">typeof</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;symbol&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_typeof</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">_Symbol</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">_typeof</span><span class="token punctuation">(</span><span class="token function">_Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;symbol&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p><code>UnaryExpression</code></p> <p>针对 <code>typeof xx</code> 一元表达式做各种处理。</p></li></ul></li></ul></li> <li><p>babel-plugin-transform-typescript</p> <p>TODO</p></li> <li><p>babel-plugin-transform-unicode-escapes</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> \u<span class="token punctuation">{</span>1d49c<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">&quot;\u{Babe1}&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>\u<span class="token punctuation">{</span>1d49c<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _ud835_udc9c <span class="token operator">=</span> <span class="token string">&quot;\uDAAA\uDFE1&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_ud835_udc9c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>目标节点</p></li> <li><p>原理</p></li></ul></li> <li><p>babel-plugin-transform-unicode-regex</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> string <span class="token operator">=</span> <span class="token string">&quot;foo💩bar&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> match <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">foo(.)bar</span><span class="token regex-delimiter">/</span><span class="token regex-flags">u</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> string <span class="token operator">=</span> <span class="token string">&quot;foo💩bar&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> match <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">foo((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]))bar</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>目标节点</p> <p>TODO</p></li> <li><p>原理</p> <p>TODO</p></li></ul></li></ul> <h2 id="_6-2-3-提案特性转换插件"><a href="#_6-2-3-提案特性转换插件" class="header-anchor">#</a> 6.2.3 提案特性转换插件</h2> <p>截至本书编写时，Babel 有 24 个内置的提案特性转换插件。</p> <p>提案特性转换插件，就是对 ECMAScript 的提案语法进行语法和转译支持，这些插件可能同时有语法开关和代码转译的功能。</p> <ul><li><p>babel-plugin-proposal-async-generator-functions</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">agf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 各种函数定义</span>

<span class="token keyword">function</span> <span class="token function">agf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_agf</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_agf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _agf <span class="token operator">=</span> <span class="token function">_wrapAsyncGenerator</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token function">_awaitAsyncGenerator</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">_agf</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li> <li><p>目标节点</p> <p><code>Function</code>: 函数。</p></li> <li><p>原理</p> <p>针对带有 <code>async</code> 标记的函数处理。</p> <p>转换函数内部的 <code>await for...of</code> 语句，转为 <code>generator</code>写法。</p> <p>然后转换上述过程产生的 <code>yield</code> 标记的语句。</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-proposal-class-properties</p> <ul><li><p>作用</p> <p>转换 class 中的原型和静态属性/方法。</p> <p>下例来自 Babel 官网。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Bork</span> <span class="token punctuation">{</span>
    <span class="token comment">// Property initializer syntax</span>
    instanceProperty <span class="token operator">=</span> <span class="token string">&quot;bork&quot;</span><span class="token punctuation">;</span>
    <span class="token function-variable function">boundFunction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceProperty<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Static class properties</span>
    <span class="token keyword">static</span> staticProperty <span class="token operator">=</span> <span class="token string">&quot;babelIsCool&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token function-variable function">staticFunction</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Bork<span class="token punctuation">.</span>staticProperty<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 定义 obj 对象的 key 属性值为 value</span>
<span class="token keyword">function</span> <span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> value<span class="token punctuation">,</span> <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Bork</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;instanceProperty&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bork&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;boundFunction&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>instanceProperty<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">_defineProperty</span><span class="token punctuation">(</span>Bork<span class="token punctuation">,</span> <span class="token string">&quot;staticProperty&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;babelIsCool&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">_defineProperty</span><span class="token punctuation">(</span>Bork<span class="token punctuation">,</span> <span class="token string">&quot;staticFunction&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Bork<span class="token punctuation">.</span>staticProperty<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>classProperties</code>: TODO</li> <li><code>classPrivateProperties</code>: TODO</li> <li><code>classPrivateMethods</code>: TODO</li></ul></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-proposal-class-static-block</p> <ul><li><p>作用</p> <p>转换 class 类中的静态 block。</p> <p>下例来自 Babel 官网：</p> <blockquote><p>下例的转换需要在该插件前引入插件 babel-plugin-proposal-class-properties，也就是支持对 class 属性的语法支持和代码转换。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> #x <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> y<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token function">doSomethingWith</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token string">&quot;unknown&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>会被转译为（以下代码简化了一些逻辑，非真实转换的结果）：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">C</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token constant">C</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查 C 被调用的方式是否是 new C() 的形式，而非普通函数调用</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">42</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// _defineProperty 的功能类似设置 C.y = undefined</span>
<span class="token function">_defineProperty</span><span class="token punctuation">(</span><span class="token constant">C</span><span class="token punctuation">,</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _ <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token constant">C</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token function">doSomethingWith</span><span class="token punctuation">(</span>_x<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>_unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">C</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token string">&quot;unknown&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div></li> <li><p>目标节点</p> <p><code>Class</code>: 类节点</p></li> <li><p>原理</p> <p>该插件源码部分只处理 static block 部分的代码，上述转译后的代码包括插件 babel-plugin-proposal-class-properties 的转译结果。</p> <p>和 babel-plugin-proposal-class-static-block 相关的转译后代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">42</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _ <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token constant">C</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token function">doSomethingWith</span><span class="token punctuation">(</span>_x<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>_unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">C</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token string">&quot;unknown&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>插件内部将 static block 内的代码放入了一个新的立即执行函数体内。</p></li></ul></li> <li><p>babel-plugin-proposal-decorators</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@annotation
<span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">annotation</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span>annotated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 其他函数定义</span>

<span class="token keyword">let</span> MyClass <span class="token operator">=</span> <span class="token function">_decorate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>annotation<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_initialize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">{</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">_initialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token constant">F</span><span class="token operator">:</span> MyClass<span class="token punctuation">,</span>
        <span class="token literal-property property">d</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">annotation</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span>annotated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></li> <li><p>目标节点</p> <p>TODO</p></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-proposal-do-expressions</p> <ul><li><p>作用</p> <p>会开启对 <code>doExpressions</code> 语法的支持。</p> <p>在转换时，该插件会转为三目运算符。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token string">&quot;big&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token string">&quot;small&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> a <span class="token operator">=</span> x <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token operator">?</span> <span class="token string">&quot;big&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;small&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>目标节点</p> <p><code>DoExpression</code>: <code>do</code> 表达式。</p></li> <li><p>原理</p> <p>在进入 <code>DoExpression</code> 节点的 <code>exit</code> 阶段时，获取 <code>do { ... }</code> 的 <code>{ ... }</code> 部分代码，并根据以下情况做不同转换：</p> <ul><li><p><code>{ ... }</code> 含有至少一行代码</p> <p>会使用 <code>path.replaceExpressionWithStatements(body)</code> 替换 <code>DoExpression</code> 节点，将块作用域内部的代码转为表达式，内部调用链路是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// babel/packages/babel-traverse/src/path/replacement.ts
replaceExpressionWithStatements 

--&gt; 

// babel/packages/babel-types/src/converters/toSequenceExpression.ts
t.toSequenceExpression 

--&gt; 

// babel/packages/babel-types/src/converters/gatherSequenceExpressions.ts
gatherSequenceExpressions
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>各个方法内部有众多的判断逻辑，在此案例下，当块作用域内部的代码是<code>if</code>表达式时，会转为三目运算表达式。</p></li> <li><p><code>{}</code>没有代码</p> <p>会直接生成 <code>void 0</code>。</p> <p>如：<code>let a = do {}</code> 会被转译为 <code>var a = undefined</code>。</p></li></ul></li></ul></li> <li><p>babel-plugin-proposal-dynamic-import</p> <ul><li><p>作用</p> <p>支持动态import语法，并对其转译。</p></li> <li><p>目标节点</p> <p>基于 <code>babel-plugin-transform-modules-commonjs</code>、<code>babel-plugin-transform-modules-amd</code>、<code>babel-plugin-transform-modules-systemjs</code> 做转译，所以目标节点为三者之一的目标节点。</p></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-proposal-export-default-from</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> v <span class="token keyword">from</span> <span class="token string">&quot;mod&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> _v <span class="token keyword">from</span> <span class="token string">&quot;mod&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> _v <span class="token keyword">as</span> v <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>目标节点</p></li> <li><p>原理</p></li></ul></li> <li><p>babel-plugin-proposal-export-namespace-from</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">as</span> ns <span class="token keyword">from</span> <span class="token string">&quot;mod&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> _ns <span class="token keyword">from</span> <span class="token string">&quot;mod&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> _ns <span class="token keyword">as</span> ns <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>目标节点</p> <p>ExportNamedDeclaration</p></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-proposal-function-bind</p> <ul><li><p>作用</p> <p>开启对<code>functionBind</code>语法的支持，并执行代码转换。</p> <p><code>functionBind</code>，顾名思义，就是 <code>fn.bind(context)</code> 的变种写法。</p> <ul><li><p>案例1</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">obj</span><span class="token operator">:</span><span class="token operator">:</span>func
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _context<span class="token punctuation">;</span>
<span class="token punctuation">(</span>_context <span class="token operator">=</span> obj<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>_context<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>案例2</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">:</span><span class="token operator">:</span>obj<span class="token punctuation">.</span>func
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _context<span class="token punctuation">;</span>
<span class="token punctuation">(</span>_context <span class="token operator">=</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>_context<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>案例3</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">obj</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">func</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _context<span class="token punctuation">;</span>
<span class="token punctuation">(</span>_context <span class="token operator">=</span> obj<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>_context<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>案例4</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">:</span><span class="token operator">:</span>obj<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _context<span class="token punctuation">;</span>
<span class="token punctuation">(</span>_context <span class="token operator">=</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>_context<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul></li> <li><p>目标节点</p> <ul><li><code>CallExpression</code>: 函数调用表达式</li> <li><code>BindExpression</code>: <code>bind</code> 表达式，如 <code>obj::func</code></li></ul></li> <li><p>原理</p> <p>插件内部实现上，针对 <code>BindExpression</code>、<code>CallExpression</code> 节点分别处理。</p> <p>从转译产物也可以看到，主要是生成新的 <code>func.bind</code> 函数调用节点，完成对当前节点的替换。</p></li></ul></li> <li><p>babel-plugin-proposal-function-sent</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Sent&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">.</span>sent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Yield&quot;</span><span class="token punctuation">,</span> <span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Logs &quot;Sent 1&quot;</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Logs &quot;Yield 2&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_skipFirstGeneratorNext</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span> it<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _generator <span class="token operator">=</span> <span class="token function">_skipFirstGeneratorNext</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> _functionSent <span class="token operator">=</span> <span class="token keyword">yield</span><span class="token punctuation">;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Sent&quot;</span><span class="token punctuation">,</span> _functionSent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Yield&quot;</span><span class="token punctuation">,</span> _functionSent <span class="token operator">=</span> <span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">_generator</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> iterator <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Logs &quot;Sent 1&quot;</span>

iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Logs &quot;Yield 2&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></li> <li><p>目标节点</p> <p><code>MetaProperty</code>: 元属性。</p></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-proposal-json-strings</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ex <span class="token operator">=</span> &quot;before
after&quot;<span class="token punctuation">;</span>
<span class="token comment">// ^ There's a U+2028 char between 'before' and 'after'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ex <span class="token operator">=</span> <span class="token string">&quot;before\u2028after&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// ^ There's a U+2028 char between 'before' and 'after'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>DirectiveLiteral</code></li> <li><code>StringLiteral</code></li></ul></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-proposal-logical-assignment-operators</p> <ul><li><p>作用</p> <p>转换逻辑运算符（<code>&amp;&amp;</code>，<code>||</code>，<code>??</code>）和复制表达式组成的复合赋值运算符。</p> <p>以下是转换的几个案例：</p> <ul><li><p><code>a ||= b;</code> 会被转译为 <code>a || (a = b);</code></p></li> <li><p><code>a &amp;&amp;= b;</code> 会被转译为 <code>a &amp;&amp; (a = b);</code></p></li> <li><p><code>obj.a.b ||= c;</code></p> <p>会被转译为</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _obj$a<span class="token punctuation">;</span>

<span class="token punctuation">(</span>_obj$a <span class="token operator">=</span> obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span>b <span class="token operator">||</span> <span class="token punctuation">(</span>_obj$a<span class="token punctuation">.</span>b <span class="token operator">=</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><code>obj.a.b &amp;&amp;= c;</code></p> <p>会被转译为</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _obj$a<span class="token punctuation">;</span>

<span class="token punctuation">(</span>_obj$a <span class="token operator">=</span> obj<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span>b <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_obj$a<span class="token punctuation">.</span>b <span class="token operator">=</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li> <li><p>目标节点</p> <p><code>AssignmentExpression</code>: 赋值表达式。</p></li> <li><p>原理</p> <p>该插件源码的逻辑：</p> <ul><li><p>解析 <code>AssignmentExpression</code> 节点，并拆解出 <code>left/operator/right</code>部分</p> <p>对于 <code>a &amp;&amp;= b</code> 这样的表达式，<code>operator</code> 值为 <code>&amp;&amp;=</code>，插件内部会取出 <code>&amp;&amp;</code> 做下一步的处理。</p></li> <li><p>判断 <code>left</code> 节点是否是对象成员表达式，如果是，复制 <code>left</code> 节点为 <code>lhs</code>，对 <code>lhs</code> 节点进行调整</p></li> <li><p>当前 <code>AssignmentExpression</code> 节点被替换为逻辑表达式 <code>logicalExpression</code>。</p></li></ul></li></ul></li> <li><p>babel-plugin-proposal-nullish-coalescing-operator</p> <ul><li><p>作用</p> <p>转换空值处理操作符(Nullish coalescing operator)。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> object<span class="token punctuation">.</span>foo <span class="token operator">??</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _object$foo<span class="token punctuation">;</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">(</span>_object$foo <span class="token operator">=</span> object<span class="token punctuation">.</span>foo<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> _object$foo <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">?</span> _object$foo <span class="token operator">:</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>空值合并操作符（<code>??</code>）是一个逻辑操作符，当左侧的操作数严格等于 <code>null</code> 或者 <code>undefined</code> 时，返回其右侧操作数，否则返回左侧操作数。</p> <p>与逻辑或操作符（<code>||</code>）不同，逻辑或操作符会在左侧操作数为假值（<code>falsy</code>）时返回右侧操作数。也就是说，如果使用 <code>||</code> 来为某些变量设置默认值并不演进，比如遇到假值（<code>''</code> 或 <code>0</code>）时。</p></li> <li><p>目标节点</p> <p><code>LogicalExpression</code>: 逻辑运算表达式。</p></li> <li><p>原理</p> <p>针对 <code>node.operator === '??'</code> 的逻辑运算表达式。</p> <p><code>function (a, x = a.b ?? c) {}</code> 会被转译为 <code>function (a, x = (() =&gt; a.b ?? c)() ){}</code>，也就是将 <code>a.b ?? c</code> 置于立即执行函数（IIFE）中，有效避免了作用域污染的问题。</p> <p>插件其余逻辑就是将 <code>??</code> 转为三元运算符 <code>? :</code>。</p></li></ul></li> <li><p>babel-plugin-proposal-numeric-separator</p> <ul><li><p>作用</p> <p>数字分隔符。它可以在数字间创建可视化分隔符（<code>_</code>）来分割数字，提高数字的可读性。用于数字式的表达式：整数（integer）、大数（bigint）、浮点数（floating-point）、小数（fractional）、指数（exponent parts）。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token number">1_000_000_000</span> <span class="token comment">// 十进制数</span>
<span class="token number">0b1010_0100</span> <span class="token comment">// 二进制数</span>
<span class="token number">101_123_34.11</span> <span class="token comment">// 浮点数</span>
<span class="token number">0.000_001</span> <span class="token comment">// 小数部分</span>
<span class="token number">1e10_000</span> <span class="token comment">// 指数部分</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>下述代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> budget <span class="token operator">=</span> <span class="token number">1_000_000_000_000</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> nibbles <span class="token operator">=</span> <span class="token number">0b1010_0001_1000_0101</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token number">0xa0_b0_c0</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> budget <span class="token operator">=</span> <span class="token number">1000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> nibbles <span class="token operator">=</span> <span class="token number">0b1010000110000101</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token number">0xa0b0c0</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>NumericLiteral</code>: 数字字面量</li> <li><code>BigIntLiteral</code>: <code>bigInt</code> 字面量</li></ul></li> <li><p>原理</p> <p>语法方面，该插件开启了 <code>numericSeparator</code> 的语法支持。</p> <p>转换方面，源码非常简单：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">remover</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> node <span class="token punctuation">}</span><span class="token operator">:</span> NodePath<span class="token operator">&lt;</span>BigIntLiteral <span class="token operator">|</span> NumericLiteral<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> extra <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>extra<span class="token operator">?.</span>raw<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        extra<span class="token punctuation">.</span>raw <span class="token operator">=</span> extra<span class="token punctuation">.</span>raw<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">_</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 省略了无关代码</span>
<span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">NumericLiteral</span><span class="token operator">:</span> remover<span class="token punctuation">,</span>
    <span class="token literal-property property">BigIntLiteral</span><span class="token operator">:</span> remover<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>当遍历到相关节点时，将 <code>_</code> 替换为空字符即可。</p></li></ul></li> <li><p>babel-plugin-proposal-object-rest-spread</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">...</span>z <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { a: 3, b: 4 }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> _x$y$a$b <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">4</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
        x<span class="token punctuation">,</span>
        y
    <span class="token punctuation">}</span> <span class="token operator">=</span> _x$y$a$b<span class="token punctuation">,</span>
    z <span class="token operator">=</span> <span class="token function">_objectWithoutProperties</span><span class="token punctuation">(</span>_x$y$a$b<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { a: 3, b: 4 }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li> <li><p>目标节点</p> <p>TODO</p></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-proposal-optional-catch-binding</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    <span class="token function">doSomthing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>_unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">doSomthing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>目标节点</p> <p><code>CatchClause</code>: <code>catch</code> 从句。</p></li> <li><p>原理</p> <p><code>CatchClause</code> 节点可以对应 <code>catch { ... }</code>、<code>catch(...) { ... }</code> 两种写法，所以需排除后者写法（通过判断 <code>path.node.param</code> 是否为真值）。</p> <p>在解析为 <code>CatchClause</code> 节点时，会携带 <code>param</code> 属性，这里将<code>param</code> 的值设置为 <code>_unused</code> 即可。</p></li></ul></li> <li><p>babel-plugin-proposal-optional-chaining</p> <ul><li><p>作用</p> <p>转换可选链。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> result <span class="token operator">=</span> a<span class="token operator">?.</span>b<span class="token operator">?.</span>c<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会被转译为（转换后的代码做了格式化处理，便于阅读）：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _a<span class="token punctuation">,</span> _a$b<span class="token punctuation">;</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> 
    <span class="token punctuation">(</span>_a <span class="token operator">=</span> a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> _a <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span> 

    <span class="token operator">?</span> 

    <span class="token keyword">void</span> <span class="token number">0</span> 

    <span class="token operator">:</span> 

    <span class="token punctuation">(</span>_a$b <span class="token operator">=</span> _a<span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> _a$b <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span> 

    <span class="token operator">?</span> 
    
    <span class="token keyword">void</span> <span class="token number">0</span> 

    <span class="token operator">:</span> 

    _a$b<span class="token punctuation">.</span>c<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>OptionalCallExpression</code>: 可选链执行方法表达式，如 <code>f?.()()</code></li> <li><code>OptionalMemberExpression</code>: 可选链表达式，如 <code>a?.b?.c</code></li></ul></li> <li><p>原理</p> <p>从转换产物可以看到，与 <code>||</code> 可能判断 <code>null/undefined/0</code> 等不同，<code>a?.b</code> 在实现上是判断 <code>a</code> 的值是否严格等于 <code>null</code> 和 <code>undefined</code> 两个值。</p> <p>对于<code>OptionalCallExpression</code>节点：</p> <p><code>f?.()()</code></p> <p>转换结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _f<span class="token punctuation">;</span>

<span class="token punctuation">(</span>_f <span class="token operator">=</span> f<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> _f <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token function">_f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>判断 <code>f</code> 是否是 <code>null</code> 或 <code>undefined</code>，若是，返回 <code>undefined</code> 作为表达式的值，否则正常执行。</p></li></ul></li> <li><p>babel-plugin-proposal-partial-application</p> <ul><li><p>作用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">)</span>           <span class="token comment">// partial application from left</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>           <span class="token comment">// partial application from right</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">)</span>        <span class="token comment">// partial application for any arg</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _x<span class="token punctuation">,</span>
    _f<span class="token punctuation">;</span>

_f <span class="token operator">=</span> f<span class="token punctuation">,</span>
_x <span class="token operator">=</span> x<span class="token punctuation">,</span> 

<span class="token comment">// f(x, ?)</span>
<span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">_argPlaceholder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_f</span><span class="token punctuation">(</span>_x<span class="token punctuation">,</span> _argPlaceholder<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// f(?, x)</span>
<span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">_argPlaceholder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_f</span><span class="token punctuation">(</span>_argPlaceholder<span class="token punctuation">,</span> _x<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// f(x, ?)</span>
<span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">_argPlaceholder<span class="token punctuation">,</span> _argPlaceholder2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_f</span><span class="token punctuation">(</span>_argPlaceholder<span class="token punctuation">,</span> _x<span class="token punctuation">,</span> _argPlaceholder2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>o<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">)</span>         <span class="token comment">// partial application from left</span>
o<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>         <span class="token comment">// partial application from right</span>
o<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">)</span>      <span class="token comment">// partial application for any arg</span>
<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token punctuation">)</span>        <span class="token comment">// partial application allowed for call on |SuperProperty|</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _x<span class="token punctuation">,</span> 
    _o$f<span class="token punctuation">,</span> 
    _o<span class="token punctuation">;</span>

_o <span class="token operator">=</span> o<span class="token punctuation">,</span> 
_o$f <span class="token operator">=</span> _o<span class="token punctuation">.</span>f<span class="token punctuation">,</span> 
_x <span class="token operator">=</span> x<span class="token punctuation">,</span> 

<span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">_argPlaceholder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_o$f</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>_o<span class="token punctuation">,</span> _x<span class="token punctuation">,</span> _argPlaceholder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>目标节点</p> <p><code>CallExpression</code>: 函数调用节点。</p></li> <li><p>原理</p> <p>如果函数调用时，没有描述 <code>ArgumentPlaceholder</code>，也就是 <code>?</code>，不做处理。</p> <p>处理时判断当前节点是 <code>o.f()</code> 还是 <code>f()</code> 形式的调用，分别处理。</p> <p>二者的最终处理逻辑类似，都是为 <code>f</code> 创建一个新的函数，并提供占位的参数变量。对于 <code>o.f()</code> 的调用形式，还需通过 <code>call</code> 绑定 <code>this</code> 上下文。</p></li></ul></li> <li><p>babel-plugin-proposal-pipeline-operator</p> <ul><li><p>作用</p> <p>管道运算符 <code>|&gt;</code> 本质上是带有单个参数的函数调用中的一个有用的语法糖。换句话说，<code>sqrt(64)</code> 等价于 <code>64 |&gt; sqrt</code>。</p> <p>当把多个函数连接在一起时，这样可以提供更好的可读性：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">doubleSay</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> str<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">capitalize</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> str<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">exclaim</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token string">'!'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>下面的调用是等价的:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">exclaim</span><span class="token punctuation">(</span><span class="token function">capitalize</span><span class="token punctuation">(</span><span class="token function">doubleSay</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
result <span class="token comment">//=&gt; &quot;Hello, hello!&quot;</span>

<span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span>
    <span class="token operator">|</span><span class="token operator">&gt;</span> doubleSay
    <span class="token operator">|</span><span class="token operator">&gt;</span> capitalize
    <span class="token operator">|</span><span class="token operator">&gt;</span> exclaim<span class="token punctuation">;</span>

result <span class="token comment">//=&gt; &quot;Hello, hello!&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>目标节点</p> <p>TODO</p></li> <li><p>原理</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-proposal-private-methods</p> <ul><li><p>作用</p> <p>配合babel-plugin-proposal-class-properties使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
    #xValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">get</span> <span class="token function">#x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#xValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">set</span> <span class="token function">#x</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>#xValue <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _xValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _x<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">get</span><span class="token operator">:</span> _get_x<span class="token punctuation">,</span>
            <span class="token literal-property property">set</span><span class="token operator">:</span> _set_x
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        _xValue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_get_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_classPrivateFieldGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> _xValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_set_x</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classPrivateFieldSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> _xValue<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div></li> <li><p>目标节点</p> <p>TODO</p></li> <li><p>作用</p> <p>TODO</p></li></ul></li> <li><p>babel-plugin-proposal-private-property-in-object</p> <ul><li><p>作用</p> <p>配合 <code>babel-plugin-proposal-class-properties</code> 一起使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>
    #bar <span class="token operator">=</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">;</span>

    <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> #bar <span class="token keyword">in</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> _bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _bar<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _bar<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li> <li><p>目标节点</p></li> <li><p>原理</p></li></ul></li> <li><p>babel-plugin-proposal-record-and-tuple</p> <ul><li><p>作用</p> <p>转换 <code>Record</code> 和 <code>Tuple</code> 类型。</p> <p>在介绍 <code>babel-plugin-syntax-record-and-tuple</code> 时，提到过，<code>Record</code> 类似对象，<code>Tuple</code> 类似数组，其成员必须是非引用类型，它们可以通过成员值是否一致判断相等性。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>#<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
#<span class="token punctuation">{</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token string">'2'</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">Tuple</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Record</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token string">'2'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>目标节点</p> <ul><li><code>RecordExpression</code>: Record表达式</li> <li><code>TupleExpression</code>: Tuple表达式</li></ul></li> <li><p>原理</p> <p>插件逻辑比较简单，直接用 <code>builtIn</code> 式的函数 <code>Tuple()</code>、<code>Record()</code> 替换原来的代码。</p></li></ul></li> <li><p>babel-plugin-proposal-throw-expressions</p> <ul><li><p>作用</p> <p>开启 <code>throwExpressions</code> 语法支持，且做代码转换。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span>param <span class="token operator">=</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;required!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> test <span class="token operator">=</span> param <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">||</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Falsy!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>会被转译为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span> <span class="token function-variable function">param</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;param required!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 默认参数值是立即执行函数</span>
    <span class="token keyword">const</span> test <span class="token operator">=</span> param <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">||</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Falsy!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 右侧是立即执行函数</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上述函数的作用是，如果执行 <code>test</code> 函数：</p> <ul><li><code>test()</code>: 会直接抛出 <code>&quot;param required&quot;</code> 错误</li> <li><code>test(false)</code>: 会直接抛出 <code>&quot;Falsy&quot;</code> 错误</li> <li><code>test(true)</code>: 会无抛错运行</li></ul></li> <li><p>目标节点</p> <p><code>UnaryExpression</code>: 一元表达式。</p></li> <li><p>原理</p> <p>识别一元表达式，并过滤 <code>path.operator</code> 值为非 <code>throw</code> 的节点。</p> <p>之后创建普通函数 <code>function(e) { throw e }</code> 节点，最终创建一个函数执行节点 <code>callExpression</code>，执行的参数是 <code>throw</code> 后面的表达式。</p></li></ul></li> <li><p>babel-plugin-proposal-unicode-property-regex</p> <p>TODO</p></li></ul></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><div class="edit-link"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon edit-icon"><path d="M117.953 696.992 64.306 959.696l265.931-49.336 450.204-452.505-212.284-213.376-450.204 452.513zm496.384-296.326L219.039 797.993l-46.108-46.34L568.233 354.33l46.104 46.335zm345.357-122.99-114.45 115.04-212.288-213.377 114.45-115.035 212.288 213.371zm0 0" fill="currentColor"></path></svg> <a href="https://github.com/hoperyy/deep-in-babel/edit/main/06.Babel内置plugin/index.md" target="_blank" rel="noopener noreferrer">Edit this page</a></div> <!----> <!----></footer> <!----> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close"></button> <button class="pswp__button pswp__button--share"></button> <button class="pswp__button pswp__button--fs"></button> <button class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left"></button> <button class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/deep-in-babel/assets/js/app.ce7a4d57.js" defer></script><script src="/deep-in-babel/assets/js/vendors~layout-Layout.f8963aab.js" defer></script><script src="/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ebefd1c7.js" defer></script><script src="/deep-in-babel/assets/js/page--5e0b8312.34d20a66.js" defer></script><script src="/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.33005620.js" defer></script>
  </body>
</html>
